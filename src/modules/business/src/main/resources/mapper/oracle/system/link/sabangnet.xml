<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="system.link.sabangnet">

    <cache eviction="FIFO" flushInterval="60000" size="512" readOnly="true"/>

    <!-- 사방넷 서비스 사용 대상 업체/사이트 조회 -->
    <select id="selectSabangnetCompany" parameterType="String" resultType="net.danvi.dmall.biz.batch.link.sabangnet.batch.job.model.SabangnetTargetCompanyVO">
	    /* system.link.sabangnet.selectSabangnetCompany - 사방넷 서비스 사용 대상 업체/사이트 조회 */
		SELECT 	TC.COMPANY_NO                                  -- 업체 코드
              , TC.COMPANY_NM                                  -- 업체 명
              , TS.SITE_NO                                     -- 사이트 번호
              , TS.SITE_ID                                     -- 사이트 ID
              , (SELECT SITE_NM FROM TS_SITE_DTL
                  WHERE SITE_NO = TS.SITE_NO) AS SITE_NM       -- 사이트 명
              , TC.SBN_ID                    AS sendCompaynyId -- 사방넷 아이디
			  , SBN_CERT_KEY                 AS sendAuthKey    -- 인증키
			  , TO_CHAR(sysdate, 'YYYYMMDD') AS sendDate       -- 전송일자
			  , 'Y'                          AS sendGoodsCdRt  -- 상품코드 반환여부
			  , TS.DLGT_DOMAIN               AS DLGT_DOMAIN    -- 대표 도메인 (※테스트후 TS.DLGT_DOMAIN으로 수정할 것)
		--	  , TO_CHAR(sysdate -15, 'YYYYMMDD') AS stDate -- 검색 시작일자
			  ,NVL( (SELECT TO_CHAR(MAX(REG_DTTM), 'YYYYMMDD')
			       FROM TI_IF_EXEC_LOG                         -- 연계실행로그 최종 등록일자
                  WHERE IF_PGM_NM LIKE CONCAT(#{ifPgmNo},'%')) , TO_CHAR(sysdate -15, 'YYYYMMDD') ) AS stDate -- 검색 시작일자
              , TO_CHAR(sysdate, 'YYYYMMDD')                   AS edDate -- 검색 종료일자
		FROM 	TS_COMPANY TC
		      , TS_SITE TS
		WHERE 	TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL
        AND     TC.SBN_CERT_KEY IS NOT NULL
		<![CDATA[
		AND 	TC.SBN_START_DT <= TO_CHAR(sysdate, 'YYYYMMDD')
		AND 	TC.SBN_END_DT >= TO_CHAR(sysdate, 'YYYYMMDD')


        ]]>
    </select>

    <!-- 1.사방넷 상품등록&수정 프로시져 실행 -->
    <update id="spIf01GoodsRegUpd" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.ProcRunnerVO">
        { call SP_IF_01_GOODS_REG_UPD (
                #{regrNo, mode=IN}
              , #{updrNo, mode=IN}
              , #{ifNo, mode=IN}
              , #{siteNo, mode=IN}
        ) }
    </update>

    <!-- 2.사방넷 상품요약수정 프로시져 실행 -->
    <update id="spIf02GoodsSmrUpd" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.ProcRunnerVO">
        { call SP_IF_02_GOODS_SMR_UPD (
                #{regrNo, mode=IN}
              , #{updrNo, mode=IN}
              , #{ifNo, mode=IN}
              , #{siteNo, mode=IN}
        ) }
    </update>

    <!-- 4.사방넷 송장등록 프로시져 실행 -->
    <update id="spIf04InvoiceReg" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.ProcRunnerVO">
        { call SP_IF_04_INVOICE_REG (
                #{regrNo, mode=IN}
              , #{updrNo, mode=IN}
              , #{ifNo, mode=IN}
              , #{siteNo, mode=IN}
        ) }
    </update>

    <!-- 7.사방넷 문의답변등록 프로시져 실행 -->
    <update id="spIf07InquiryReplyReg" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.ProcRunnerVO">
         { call SP_IF_07_INQUIRY_REPLY_REG (
                #{regrNo, mode=IN}
              , #{updrNo, mode=IN}
              , #{ifNo, mode=IN}
              , #{siteNo, mode=IN}
        ) }
    </update>

    <!-- 사방넷 배치 로그 등록 프로시져 실행 -->
    <update id="spIf004SbnBtchLogReg" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.common.model.IfLogVO">
         { call SP_IF_004_SBN_BTCH_LOG_REG (
                'REG'            , #{ifNo}     , #{ifId}     , #{siteNo}    , #{ifPgmId}
               , #{ifPgmNm}      , '1'         , null        , null         , null
               , null            , null        , #{regrNo}   , #{updrNo}
        ) }
    </update>

    <!-- 사방넷 배치 로그 수정 프로시져 실행 -->
    <update id="spIf004SbnBtchLogUpd" statementType="CALLABLE" parameterType="net.danvi.dmall.biz.batch.common.model.IfLogVO">
         { call SP_IF_004_SBN_BTCH_LOG_REG (
                'UPD'            , #{ifNo}     , #{ifId}     , #{siteNo}    , null
               , null            , '1'         , #{dataCnt}  , #{sucsYn}    , #{errCd}
               , #{resultContent}, null        , #{regrNo}   , #{updrNo}
        ) }
    </update>

    <!-- 1.상품 등록 -->
    <resultMap id="goodsRegiRequest" type="net.danvi.dmall.biz.batch.link.sabangnet.model.request.GoodsRequest">
        <collection column="{siteNo=SITE_NO, ifNo=IF_NO}" property="data" javaType="ArrayList"
                    ofType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.Goods"
                    select="system.link.sabangnet.selectGoodsRegiData"/>
    </resultMap>
    <!-- 1.상품 등록 데이터 조회 -->
    <select id="selectGoodsRegi" resultMap="system.link.sabangnet.goodsRegiRequest">
        /* system.link.sabangnet.selectGoodsRegi - 1.상품 등록 데이터 조회 */
        SELECT  TC.SBN_ID                       AS sendCompaynyId,
                SBN_CERT_KEY                    AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD')    AS sendDate,
                TS.SITE_NO,
                #{ifNo}                         AS IF_NO
		FROM 	TS_COMPANY TC, TS_SITE TS
		WHERE 	TC.COMPANY_NO = TS.COMPANY_NO
		AND     TC.SBN_ID IS NOT NULL
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')
		AND   	TS.SITE_NO = #{siteNo}


        ]]>
    </select>
    <!-- 1-1.상품 등록 데이터 조회-->
    <select id="selectGoodsRegiData" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.Goods">
        /* system.link.sabangnet.selectGoodsRegiData - 1-1.상품 등록 데이터 조회 */
        select
             NVL(goodsNm,'') as goodsNm
            ,NVL(modelNm,'') as modelNm
            ,NVL(brandNm,'') as brandNm
            ,NVL(compaynyGoodsCd,'') as compaynyGoodsCd
            ,NVL(goodsSearch,'') as goodsSearch
            ,NVL(goodsGubun,'') as goodsGubun
            ,NVL(classCd1,'') as classCd1
            ,NVL(classCd2,'') as classCd2
            ,NVL(classCd3,'') as classCd3
            ,NVL(classCd4,'') as classCd4
            ,NVL(maker,'') as maker
            ,NVL(origin,'') as origin
            ,NVL(makeYear,'') as makeYear
            ,NVL(makeDm,'') as makeDm
            ,NVL(goodsSeason,'') as goodsSeason
            ,NVL(sex,'') as sex
            ,NVL(status,'') as status
            ,NVL(taxYn,'') as taxYn
            ,NVL(delvType,'') as delvType
            ,NVL(delvCost,'') as delvCost
            ,NVL(goodsCost,'') as goodsCost
            ,NVL(goodsPrice,'') as goodsPrice
            ,NVL(goodsConsumerPrice,'') as goodsConsumerPrice
            ,NVL(char1Nm,'') as char1Nm
            ,NVL(char1Val,'') as char1Val
            ,NVL(char2Nm,'') as char2Nm
            ,NVL(char2Val,'') as char2Val
            ,NVL(goodsImgType, '')  AS goodsImgType
            ,NVL(replace(imgPath,'/image/','http://www.davichmarket.com/image/'),'') as imgPath
            ,NVL(replace(imgPath1,'/image/','http://www.davichmarket.com/image/'),'') as imgPath1
            ,NVL(replace(imgPath2,'/image/','http://www.davichmarket.com/image/'),'') as imgPath2
            ,NVL(replace(imgPath3,'/image/','http://www.davichmarket.com/image/'),'') as imgPath3
            ,NVL(replace(imgPath4,'/image/','http://www.davichmarket.com/image/'),'') as imgPath4
            ,NVL(replace(imgPath5,'/image/','http://www.davichmarket.com/image/'),'') as imgPath5
            ,NVL(replace(goodsRemarks,'/image/','http://www.davichmarket.com/image/'),'') as goodsRemarks
            ,NVL(material,'') as material
            ,NVL(stockUseYn,'') as stockUseYn
            ,NVL(optType,'') as optType
            ,NVL(propEditYn,'') as propEditYn
            ,NVL(prop1Cd,'') as prop1Cd
            ,NVL(propVal1,'') as propVal1
            ,NVL(propVal2,'') as propVal2
            ,NVL(propVal3,'') as propVal3
            ,NVL(propVal4,'') as propVal4
            ,NVL(propVal5,'') as propVal5
            ,NVL(propVal6,'') as propVal6
            ,NVL(propVal7,'') as propVal7
            ,NVL(propVal8,'') as propVal8
            ,NVL(propVal9,'') as propVal9
            ,NVL(propVal10,'') as propVal10
            ,NVL(propVal11,'') as propVal11
            ,NVL(propVal12,'') as propVal12
            ,NVL(propVal13,'') as propVal13
            ,NVL(propVal14,'') as propVal14
            ,NVL(propVal15,'') as propVal15
            ,NVL(propVal16,'') as propVal16
            ,NVL(propVal17,'') as propVal17
            ,NVL(propVal18,'') as propVal18
            ,NVL(propVal19,'') as propVal19
            ,NVL(propVal20,'') as propVal20
            ,NVL(propVal21,'') as propVal21
            ,NVL(propVal22,'') as propVal22
            ,NVL(propVal23,'') as propVal23
            ,NVL(propVal24,'') as propVal24
            ,NVL(importno,'') as importno
            from (
        SELECT ROW_NUMBER() OVER(ORDER BY IF_SNO) PAGING_NUM ,
            IF_SNO,
              TRIM(
                	NVL(GOODS_NM,'') || ' ' || NVL(ITEM_NM,'')
                      || NVL(CASE WHEN NVL(fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ','),'') != ''
                                   THEN '-' || fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ',') END,'')
                      )                                   AS goodsNm
              , NVL(MODEL_NM                    , '')               AS modelNm
              , NVL(BRAND_NM                    , '')               AS brandNm
              , NVL(ITEM_NO||'-'||ATTR_VER      , '')               AS compaynyGoodsCd
              , NVL(SRCH_WORD                   , '')               AS goodsSearch
              , NVL(GOODS_GB_CD                 , '')               AS goodsGubun
              , NVL(CTG_NO1                     , '')               AS classCd1
              , NVL(CTG_NO2                     , '')               AS classCd2
              , NVL(CTG_NO3                     , '')               AS classCd3
              , NVL(CTG_NO4                     , '')               AS classCd4
              , NVL(MMFT                        , '')               AS maker
              , NVL(HABITAT                     , '')               AS origin
              , NVL(PRDT_YR                     , '')               AS makeYear
              , NVL(MK_DT                       , '')               AS makeDm
              , NVL(SSN_GB_CD                   , '')               AS goodsSeason
              , NVL(MW_GB_CD                    , '')               AS sex
              , NVL(SALE_STATUS_CD              , '')               AS status
              , NVL(TAX_GB_CD                   , '')               AS taxYn
              , NVL(DLVRC_GB_CD                 , '')               AS delvType
              , NVL(GOODS_EACH_DLVRC            , '')               AS delvCost
              , NVL(SUPPLY_PRICE              , '')                 AS goodsCost
              , NVL(SALE_PRICE                  , '')               AS goodsPrice
              , NVL(CUSTOMER_PRICE              , '')               AS goodsConsumerPrice
              , NVL(OPT_GB1                     , '')               AS char1Nm
              , NVL(OPT_ITEM1                   , '')               AS char1Val
              , NVL(OPT_GB2                     , '')               AS char2Nm
              , NVL(OPT_ITEM2                   , '')               AS char2Val
              , NVL(GOODS_IMG_TYPE              , '')               AS goodsImgType
              , NVL(DLGT_IMG_PATH               , '')               AS imgPath
              , NVL(IMG_PATH1                   , '')               AS imgPath1
              , NVL(IMG_PATH2                   , '')               AS imgPath2
              , NVL(IMG_PATH3                   , '')               AS imgPath3
              , NVL(IMG_PATH4                   , '')               AS imgPath4
              , NVL(IMG_PATH5                   , '')               AS imgPath5
              , NVL(GOODS_DTL_DSCRT, TRIM(
                        NVL(GOODS_NM,'') || ' ' || NVL(ITEM_NM,'')
                              || NVL(CASE WHEN NVL(fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ','),'') != ''
                                           THEN '-' || fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ',') END,'')
                              || ' :: ' || NVL(OPT_ITEM1,'')))      AS goodsRemarks
              , NVL(MTRL_HABITAT                , '')               AS material
              , NVL(STOCK_MANAGE_USE_YN         , '')               AS stockUseYn
              , NVL(OPT_UPD_PSB_YN              , '')               AS optType
              , NVL(ATTR_INFO_UPD_YN            , '')               AS propEditYn
              , NVL(ATTR_CLSF_CD                , '')               AS prop1Cd
              , NVL(ATTR_VALUE1                 , '')               AS propVal1
              , NVL(ATTR_VALUE2                 , '')               AS propVal2
              , NVL(ATTR_VALUE3                 , '')               AS propVal3
              , NVL(ATTR_VALUE4                 , '')               AS propVal4
              , NVL(ATTR_VALUE5                 , '')               AS propVal5
              , NVL(ATTR_VALUE6                 , '')               AS propVal6
              , NVL(ATTR_VALUE7                 , '')               AS propVal7
              , NVL(ATTR_VALUE8                 , '')               AS propVal8
              , NVL(ATTR_VALUE9                 , '')               AS propVal9
              , NVL(ATTR_VALUE10                , '')               AS propVal10
              , NVL(ATTR_VALUE11                , '')               AS propVal11
              , NVL(ATTR_VALUE12                , '')               AS propVal12
              , NVL(ATTR_VALUE13                , '')               AS propVal13
              , NVL(ATTR_VALUE14                , '')               AS propVal14
              , NVL(ATTR_VALUE15                , '')               AS propVal15
              , NVL(ATTR_VALUE16                , '')               AS propVal16
              , NVL(ATTR_VALUE17                , '')               AS propVal17
              , NVL(ATTR_VALUE18                , '')               AS propVal18
              , NVL(ATTR_VALUE19                , '')               AS propVal19
              , NVL(ATTR_VALUE20                , '')               AS propVal20
              , NVL(ATTR_VALUE21                , '')               AS propVal21
              , NVL(ATTR_VALUE22                , '')               AS propVal22
              , NVL(ATTR_VALUE23                , '')               AS propVal23
              , NVL(ATTR_VALUE24                , '')               AS propVal24
              , NVL(IMPT_REGIST_NO              , '')               AS importno
          FROM  TI_GOODS_REG_UPD_IF
         WHERE IF_NO   = #{ifNo}
           AND SITE_NO = #{siteNo}
            <![CDATA[
           AND (SBN_IF_YN IS NULL OR SBN_IF_YN = 'N') -- 사방넷연계여부
           AND GOODS_NM IS NOT NULL
           AND ITEM_NO IS NOT NULL
            ]]>
            )
	</select>

    <!-- 1-2.상품등록수정 연계 사방넷연계여부 수정 -->
    <update id="updateGoodsRegSbnIfYn" parameterType="net.danvi.dmall.biz.batch.common.model.IfExecLogVO">
        /* system.link.sabangnet.updateGoodsRegSbnIfYn - 1-2.상품등록수정 연계 사방넷연계여부 수정 */
        UPDATE TI_GOODS_REG_UPD_IF A
           SET A.SBN_IF_YN      = CASE WHEN #{resultContent} LIKE '%성공%' THEN 'Y' ELSE 'N' END
             , A.SBN_IF_MSG     = #{resultContent}
             , A.UPDR_NO        = #{updrNo}
             , A.UPD_DTTM       = sysdate
        WHERE
               A.IF_SNO         = (SELECT IF_SNO
                  FROM TI_GOODS_REG_UPD_IF
                 WHERE ITEM_NO = SPLIT(#{srchKey},1,'-')
                   AND ATTR_VER = SPLIT(#{srchKey},2,'-')
                   AND IF_NO    = #{ifNo}
                   AND NVL(SBN_IF_YN,'N') = 'N'      -- 'N' 사방넷연계 여부
               )
    </update>

    <!-- 2.상품요약수정 -->
    <resultMap id="goodsSmrUpdRequest" type="net.danvi.dmall.biz.batch.link.sabangnet.model.request.GoodsSmrUpdRequest">
        <collection column="{siteNo=SITE_NO, ifNo=IF_NO}" property="data" javaType="ArrayList"
                    ofType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.GoodsSmrUpd"
                    select="system.link.sabangnet.selectGoodsSmrUpdData"/>
    </resultMap>
    <!-- 2.상품요약수정 데이터 조회-->
    <select id="selectGoodsSmrUpd" resultMap="system.link.sabangnet.goodsSmrUpdRequest">
        /* system.link.sabangnet.selectGoodsSmrUpd - 2.상품요약수정 데이터 조회 */
        SELECT  TC.SBN_ID                       AS sendCompaynyId,
                SBN_CERT_KEY                    AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD')    AS sendDate,
                TS.SITE_NO,
                #{ifNo}                         AS IF_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>
    <!-- 2-1.상품요약수정 데이터 조회-->
    <select id="selectGoodsSmrUpdData" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.GoodsSmrUpd">
        /* system.link.sabangnet.selectGoodsSmrUpdData - 2-1.상품요약수정 데이터 조회 */
        SELECT
           A.goodsNm
           ,A.compaynyGoodsCd
           ,A.status
           ,A.goodsCost
           ,A.goodsPrice
           ,A.goodsConsumerPrice
          , A.skuValue1 ||
              decode(A.skuValue2,null,'',','|| A.skuValue2) ||
              decode(A.skuValue3,null,'',','|| A.skuValue3) ||
              decode(A.skuValue4,null,'',','|| A.skuValue4) ||
              decode(A.skuValue5,null,'',','|| A.skuValue5) ||
              decode(A.skuValue6,null,'',','|| A.skuValue6) ||
              decode(A.skuValue7,null,'',','|| A.skuValue7)  as skuInfo
          FROM (
        SELECT  TRIM(
                NVL(GOODS_NM,'') || ' ' || NVL(ITEM_NM,'')
                      || NVL(CASE WHEN NVL(fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ','),'') != ''
                                   THEN '-' || fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, ':', ',') END,'')
                      )                                   AS goodsNm
              , NVL(ITEM_NO||'-'||ATTR_VER, '')               AS compaynyGoodsCd
              , NVL(SALE_STATUS_CD              , '')               AS status
              , NVL(SUPPLY_PRICE              , '')               AS goodsCost
              , NVL(SALE_PRICE                  , '')               AS goodsPrice
              , NVL(CUSTOMER_PRICE              , '')               AS goodsConsumerPrice
              , NVL(OPT_ITEM1                   , '')               AS skuValue1
              , NVL(OPT_ITEM2                   , '')               AS skuValue2
              , NVL(OPT_ITEM3                   , '')               AS skuValue3
              , NVL(OPT_ITEM4                   , '')               AS skuValue4
              , NVL(OPT_ITEM5                   , '')               AS skuValue5
              , NVL(OPT_ITEM6                   , '')               AS skuValue6
              , NVL(OPT_ITEM7                   , '')               AS skuValue7
          FROM  TI_GOODS_SMR_UPD_IF
          WHERE SITE_NO = #{siteNo}
           AND IF_NO   = #{ifNo}               -- 연계번호
           AND (SBN_IF_YN IS NULL OR SBN_IF_YN = 'N') -- 사방넷연계여부
           AND GOODS_NM IS NOT NULL
           AND ITEM_NO IS NOT NULL
           AND fn_getItemOptAttrNm(ITEM_NO, ATTR_VER, '-', ',') IS NOT NULL
         ORDER BY IF_SNO
          ) A
    </select>

    <!-- 2-2상품요약수정 연계 사방넷연계여부 수정 -->
    <update id="updateGoodsSmrUpdSbnIfYn" parameterType="net.danvi.dmall.biz.batch.common.model.IfExecLogVO">
        /* system.link.sabangnet.updateGoodsSmrUpdSbnIfYn - 2-2.상품요약수정 연계 사방넷연계여부 수정 */
        UPDATE TI_GOODS_SMR_UPD_IF A
           SET A.SBN_IF_YN      = CASE WHEN #{resultContent} LIKE '%성공%' THEN 'Y' ELSE 'N' END
             , A.SBN_IF_MSG     = #{resultContent}
             , A.UPDR_NO        = #{updrNo}
             , A.UPD_DTTM       = sysdate
        WHERE
               A.IF_SNO         = (SELECT IF_SNO
                  FROM TI_GOODS_SMR_UPD_IF
                 WHERE ITEM_NO = SUBSTR(#{srchKey}, 1, 16)
                   AND ATTR_VER = SUBSTR(#{srchKey}, 18)
                   AND IF_NO    = #{ifNo}
                   AND NVL(SBN_IF_YN,'N') = 'N'      -- 'N' 사방넷연계 여부
               )
    </update>

    <!-- 3.주문 수집 요청 조회 -->
    <select id="selectOrderRequest" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.OrderRequest">
        /* system.link.sabangnet.selectOrderRequest - 3.주문 수집 요청 조회 */
        SELECT  TC.SBN_ID                    AS sendCompaynyId,
                SBN_CERT_KEY                 AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD') AS sendDate,
                TS.SITE_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>

    <!-- 3-1.주문수집 연계 테이블 중복 체크 -->
    <select id="selectOrdClctIfDupYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrderResult">
        /* system.link.sabangnet.selectOrdClctIfDupCheck - 3-1.주문수집 연계 테이블 중복 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS DUP_YN
          FROM TI_ORD_CLCT_IF
         WHERE SITE_NO       = #{siteNo}
           AND SPMALL_ID     = #{mallId}            -- 쇼핑몰 ID
           AND SPMALL_ORD_NO = #{orderId}           -- 쇼핑몰 주문번호
           AND SBN_ORD_NO    = #{idx}               -- 사방넷 유니크 주문번호
           AND ORD_DLVR_STATUS = #{orderStatus}     -- 주문 배송 상태
    </select>

    <!-- 3-2.주문 수집 연계 테이블 등록 -->
    <insert id="insertOrdClctIf" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrderResult">
        /* system.link.sabangnet.insertOrdClctIf - 3-2.주문 수집 연계 테이블 등록 */
        INSERT INTO TI_ORD_CLCT_IF (
               IF_SNO
             , IF_ID
             , IF_NO
             , SITE_NO
             , SBN_ORD_NO
             , SBN_ORG_ORD_NO
             , SPMALL_ORD_NO
             , SPMALL_ID
             , SPMALL_LOGIN_ID
             , ORD_DLVR_STATUS
             , ORDR_NM
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_EMAIL
             , ADRS_TEL
             , ADRS_MOBILE
             , DLVR_MSG
             , ADRS_NM
             , POST_NO
             , DTL_ADDR
             , SALE_AMT
             , PAYMENT_AMT
             , ORD_ACCEPT_DTTM
             , GOODS_NM
             , OPT_NM
             , SALE_PRICE
             , ORD_QTT
             , SPMALL_ORD_DLVR_INFO
             , REAL_DLVR_AMT
             , GOODS_NO
             , ITEM_NO
             , ATTR_VER
             , ORD_GB_CD
             , ORD_CLCT_DTTM
             , ORD_CMPLT_DTTM
             , RETURN_CMPLT_REG_DTTM
             , EXCHG_CMPLT_DTTM
             , RLS_CMPLT_REG_DTTM
             , ORD_CANCEL_DTTM
             , RLS_COURIER_CD
             , RLS_INVOICE_NO
             , REGR_NO
             , REG_DTTM
        ) VALUES (
               #{ifSno}
             , #{ifId}
             , #{ifNo}
             , #{siteNo}
             , #{idx}
             , #{copyIdx}
             , #{orderId}
             , #{mallId}
             , #{mallUserId}
             , #{orderStatus}
             , #{userName}
             , #{userTel}
             , #{userCel}
             , #{userEmail}
             , #{receiveTel}
             , #{receiveCel}
             , #{delvMsg}
             , #{receiveName}
             , #{receiveZipcode}
             , #{receiveAddr}
             , #{totalCost}
             , #{payCost}
             , #{orderDate}
             , #{pProductName}
             , #{pSkuValue}
             , #{saleCost}
             , #{saleCnt}
             , #{deliveryMethodStr}
             , #{delvCost}
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = SUBSTR(#{compaynyGoodsCd},1,16))
             , nvl(split(#{compaynyGoodsCd},1,'-'),null)
             , (SELECT SUBSTR(#{compaynyGoodsCd},18,2) FROM DUAL)
             , #{orderGubun}
             , #{regDate}
             , #{ordConfirmDate}
             , #{rtnDt}
             , #{chngDt}
             , #{deliveryConfirmDate}
             , #{cancelDt}
             , #{deliveryId}
             , #{invoiceNo}
             , #{regrNo}
             , sysdate
             )
    </insert>

    <!-- 3-3.주문수집연계 처리 - 쇼핑몰 주문번호별 조회 -->
    <select id="selectOrdClctIfList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.selectOrdClctIfList - 3-3.주문수집연계 - 쇼핑몰 주문번호별 조회 */
          SELECT A.SPMALL_ORD_NO              -- 쇼핑몰주문번호
               , A.SBN_ORD_NO                 -- 사방넷주문번호 - 신규주문 자료 조회
               , A.SBN_ORG_ORD_NO
               , A.IF_SNO
               , A.IF_NO
               , A.SITE_NO
               , A.ORD_NO
               , A.ORD_DLVR_STATUS  -- 주문배송상태
               , A.SPMALL_LOGIN_ID
            FROM TI_ORD_CLCT_IF A
           WHERE A.SITE_NO  = #{siteNo}
             AND A.IF_NO    = #{ifNo}
             AND (A.SPMALL_ORD_NO, A.SBN_ORD_NO) IN (SELECT B.SPMALL_ORD_NO, MIN(B.SBN_ORD_NO) SBN_ORD_NO
                                                       FROM TI_ORD_CLCT_IF B
                                                      WHERE B.SITE_NO  = #{siteNo}
                                                        AND B.IF_NO    = #{ifNo}
                                                        AND NVL(B.SBN_IF_YN,'N') = 'N'   -- 'N' 사방넷연계 여부
                                                      GROUP BY B.SPMALL_ORD_NO -- 쇼핑몰 주문번호별 주문은 1건만 조회
                                                    )
             AND NVL(A.SBN_IF_YN,'N') = 'N'   -- 'N' 사방넷연계 여부
           ORDER BY A.SPMALL_ORD_NO, A.SBN_ORD_NO
    </select>

    <!-- 3-3.주문수집연계 처리 - 원본 주문번호 조회 -->
    <select id="selectOrgOrdNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.selectOrgOrdNo - 3-3.주문수집연계 - 원본 주문번호 조회 */
        SELECT ORD_NO    AS ORG_ORD_NO             -- 원본주문번호
          FROM TI_ORD_CLCT_IF                      -- 주문수집연계
         WHERE IF_SNO = (SELECT MIN(D.IF_SNO)
                           FROM TI_ORD_CLCT_IF C
                              , TI_ORD_CLCT_IF D   -- 최초 신규주문 수집자료
                          WHERE C.SITE_NO = #{siteNo}
                            AND C.IF_SNO  = #{ifSno}
                            AND D.SITE_NO        = C.SITE_NO         -- 사이트번호
                            AND D.SPMALL_ID      = C.SPMALL_ID       -- 쇼핑몰ID
                            AND D.SPMALL_ORD_NO  = C.SPMALL_ORD_NO   -- 쇼핑몰주문번호
                            AND D.SBN_ORD_NO     = C.SBN_ORG_ORD_NO  -- 사방넷주문번호 = 사방넷원본주문번호
                            AND D.ORD_NO IS NOT NULL
                            AND D.ORD_DLVR_STATUS IN ('신규주문')    -- 주문배송상태
                        )
    </select>

    <!-- 3-3.주문 테이블 존재여부 체크 -->
    <select id="selectOrdExistYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.selectOrdExistYn - 3-5.주문 테이블 존재여부 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS EXIST_YN
          FROM TO_ORD
         WHERE SITE_NO      = #{siteNo}
           AND ORD_NO       = #{ordNo}           -- 주문번호
    </select>

    <!-- 3-3.주문 처리 -->
    <update id="procOrd" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procOrd - 3-3-1.주문 처리 - 주문 테이블 등록 */
        INSERT INTO TO_ORD (
               ORD_NO
             , SITE_NO
             , ORG_ORD_NO
             , ORD_STATUS_CD
             , ORD_MEDIA_CD
             , SALE_CHANNEL_CD
             , MEMBER_ORD_YN
             , MEMBER_NO
             , LOGIN_ID
             , MEMBER_GRADE_NO
             , ORD_SECT_NO
             , ORDR_NM
             , ORDR_EMAIL
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_IP
             , ORD_ACCEPT_DTTM
             , ORD_CMPLT_DTTM
             , ORD_CANCEL_DTTM
             , PAYMENT_CMPLT_DTTM
             , SMS_RECV_YN
             , EMAIL_RECV_YN
             , PVD_SVMN
             , MANUAL_ORD_YN
             , PAYMENT_AMT
             , SALE_AMT
             , DC_AMT
             , REGR_NO
             , REG_DTTM
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{siteNo}                      -- 사이트 번호
             , #{orgOrdNo}                    -- 원본 주문번호
             , '20' -- 주문상태 20:결제완료
             , '01'                           -- 주문매체 코드 PC
		     , (SELECT B.CD
		          FROM TA_CMN_CD_DTL B
		         WHERE B.GRP_CD = 'SALE_CHANNEL_CD'
		           AND B.CD_NM  = A.SPMALL_ID)  -- 판매채널 코드
             , 'N'                            -- 회원주문 여부
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 주문자 번호
             , A.SPMALL_LOGIN_ID              -- 쇼핑몰 로그인 아이디
             , (SELECT MEMBER_GRADE_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_GRADE_NO                          -- 회원등급 번호
             , null                           -- 주문 비밀번호
             , A.ORDR_NM                      -- 주문자 명
             , A.ORDR_EMAIL                   -- 주문자 이메일
             , A.ORDR_TEL                     -- 주문자 전화
             , A.ORDR_MOBILE                  -- 주문자 휴대폰
             , null                           -- 주문자 IP
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_ACCEPT_DTTM  -- 주문접수 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , TO_DATE(A.ORD_CANCEL_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_CANCEL_DTTM  -- 주문취소 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , null                           -- SMS 수신 여부
             , null                           -- 이메일 수신 여부
             , 0                           -- 지급 마켓포인트
             , 'N'                            -- 수기주문 여부
             , #{paymentAmt}                  -- 결제 금액
             , A.SALE_AMT                     -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-3-2.주문 처리 - 주문 배송지 테이블 등록 */
        INSERT INTO TO_ORD_DELIVERY (
               ORD_NO                         -- 주문 번호
             , MEMBER_NO                      -- 회원 번호
             , AREA_DLVR_SET_NO               -- 지역 배송 설정 번호
             , SITE_NO                        -- 사이트 번호
             , DELIVERY_NM                    -- 배송지 명
             , ADRS_NM                        -- 수취인 명
             , ADRS_TEL                       -- 수취인 전화
             , ADRS_MOBILE                    -- 수취인 휴대폰
             , POST_NO                        -- 신 우편 번호
             , ROADNM_ADDR                    -- 도로명 주소
             , NUM_ADDR                       -- 지번 주소
             , DTL_ADDR                       -- 도로명 상세 주소
             , DLVR_MSG                       -- 배송 메세지
             , MEMBER_GB_CD                   -- 회원 구분 코드
             , FRG_ADDR_COUNTRY               -- 해외 주소 COUNTRY
             , FRG_ADDR_CITY                  -- 해외 주소 CITY
             , FRG_ADDR_STATE                 -- 해외 주소 STATE
             , FRG_ADDR_ZIP_CODE              -- 해외 주소 우편번호
             , FRG_ADDR_DTL1                  -- 해외 주소 상세1
             , FRG_ADDR_DTL2                  -- 해외 주소 상세2
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 회원 번호
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             , #{siteNo}                      -- 사이트 번호
             , null                           -- 배송지 명
             , A.ADRS_NM                      -- 수취인 명
             , A.ADRS_TEL                     -- 수취인 전화
             , A.ADRS_MOBILE                  -- 수취인 휴대폰
             , A.POST_NO                      -- 신 우편 번호
             , null                           -- 도로명 주소
             , null                           -- 지번 주소
             , A.DTL_ADDR                     -- 도로명 상세 주소
             , A.DLVR_MSG                     -- 배송 메세지
             , null                           -- 회원 구분 코드
             , null                           -- 해외 주소 COUNTRY
             , null                           -- 해외 주소 CITY
             , null                           -- 해외 주소 STATE
             , null                           -- 해외 주소 우편번호
             , null                           -- 해외 주소 상세1
             , A.DLVR_WISH_DT                 -- 해외 주소 상세2
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE 1=1
           AND A.DTL_ADDR IS NOT NULL
           AND A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-3-3.주문 처리 - 결제 테이블 배포 등록 */
        INSERT INTO TO_PAYMENT (
               PAYMENT_NO                     -- 결제 번호
             , SITE_NO                        -- 사이트 번호
             , ORD_NO                         -- 주문 번호
             , PAYMENT_TURN                   -- 결제 차수
             , PAYMENT_PG_CD                  -- 결제 PG 코드
             , PAYMENT_WAY_CD                 -- 결제 수단 코드
             , PAYMENT_STATUS_CD              -- 결제 상태 코드
             , PAYMENT_CMPLT_DTTM             -- 결제 완료 일시
             , PAYMENT_AMT                    -- 결제 금액
             , MEMBER_NO                      -- 회원 번호
             , TX_NO                          -- 거래 번호
             , CONFIRM_NO                     -- 승인 번호
             , CONFIRM_DTTM                   -- 승인 일시
             , CONFIRM_RESULT_CD              -- 승인 결과 코드
             , CONFIRM_RESULT_MSG             -- 승인 결과 메세지
             , CARD_CD                        -- 카드사 코드
             , INSTMNT_MONTH                  -- 할부개월
             , BANK_CD                        -- 은행 코드
             , ACT_NO                         -- 계좌 번호
             , HOLDER_NM                      -- 예금주 명
             , DPSTER_NM                      -- 입금자 명
             , DPST_SCD_DT                    -- 입금 예정 일자
             , DPST_SCD_AMT                   -- 입금 예정 금액
             , DPST_CHECK_MSG                 -- 입금 확인 메세지
             , ESCROW_YN                      -- 에스크로 여부
             , ESCROW_CONFIRMNO               -- 에스크로 승인번호(올더게이트)
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0,'TO_PAYMENT_NO') FROM DUAL) PAYMENT_NO -- 결제 번호
             , #{siteNo}                      -- 사이트 번호
             , #{ordNo}                       -- 주문 번호
             , 1                              -- 결제 차수
             , '00'                           -- 결제 PG 코드
             , '51'                           -- 결제 수단 코드 51:사방넷
             , '02'                           -- 결제 상태 코드 02:완료, 01:접수, 03:취소
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , A.PAYMENT_AMT                  -- 결제 금액
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 회원 번호
             , null                           -- 거래 번호
             , null                           -- 승인 번호
             , null                           -- 승인 일시
             , null                           -- 승인 결과 코드
             , null                           -- 승인 결과 메세지
             , null                           -- 카드사 코드
             , null                           -- 할부개월
             , null                           -- 은행 코드
             , null                           -- 계좌 번호
             , null                           -- 예금주 명
             , null                           -- 입금자 명
             , null                           -- 입금 예정 일자
             , null                           -- 입금 예정 금액
             , null                           -- 입금 확인 메세지
             , null                           -- 에스크로 여부
             , null                           -- 에스크로 승인번호(올더게이트)
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-3-4.주문 처리 - 주문번호를 주문수집연계 테이블에 업데이트 */
        UPDATE TI_ORD_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
         WHERE A.IF_SNO        = #{ifSno};

         END
         }
    </update>

    <!-- 3-4.주문수집연계 - 주문수집연계 상세 조회 -->
    <select id="selectOrdClctIfDtlList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        /* system.link.sabangnet. 3-4.주문수집연계 - 주문수집연계 상세 조회 */
        SELECT A.IF_SNO                               -- 연계 일련번호(PK)
             , A.IF_NO                                -- 연계 번호
             , A.SPMALL_ORD_NO                        -- 쇼핑몰 주문 번호
             , A.SBN_ORD_NO                           -- 사방넷 주문 번호
             , A.SBN_ORG_ORD_NO                       -- 사방넷 원본 주문 번호
             , A.ORD_NO                               -- 주문 번호
             , A.ORD_DTL_SEQ                          -- 주문 상세 순번
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) end ITEM_NO         -- 단품번호
             , A.ATTR_VER        -- 속성VER
             , A.ORD_QTT                              -- 주문수량
             , A.ORD_DLVR_STATUS                      -- 주문 배송 상태
             , A.ORD_CANCEL_DTTM                      -- 주문취소일시
             , A.RETURN_CMPLT_REG_DTTM                -- 반품완료등록일시
             , A.EXCHG_CMPLT_DTTM                     -- 교환완료일시
             , (SELECT CLAIM_NO FROM TI_CLAIM_CLCT_IF WHERE SPMALL_ORD_NO=A.SPMALL_ORD_NO) AS CLAIM_NO -- 클레임번호
          FROM TI_ORD_CLCT_IF A                       -- 주문수집 연계
         WHERE A.IF_NO           = #{ifNo}
           AND A.SITE_NO         = #{siteNo}
           AND A.SPMALL_ORD_NO   = #{spmallOrdNo}     -- 쇼핑몰 주문 번호
           AND NVL(A.SBN_IF_YN,'N') = 'N'          -- 'N' 사방넷연계 여부
         ORDER BY A.IF_SNO
    </select>

    <!-- 3-4.주문 상세 처리 -->
    <update id="procOrdDtl" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procOrdDtl - 3-4-1.주문 상세 처리 - 주문 상세 테이블 등록 */
        INSERT INTO TO_ORD_DTL (
               ORD_NO                         -- 주문 번호
             , ORD_DTL_SEQ                    -- 주문 상세 순번
             , ORD_DTL_STATUS_CD              -- 주문 상세 상태 코드
             , GOODS_NO                       -- 상품 번호
             , ITEM_NO                        -- 단품 번호
             , GOODS_NM                       -- 상품 명
             , ITEM_NM                        -- 단품 명
             , ORD_QTT                        -- 주문 수량
             , CUSTOMER_AMT                   -- 소비자 금액
             , SUPPLY_AMT                   -- 공급 금액
             , SALE_AMT                       -- 판매 금액
             , DC_AMT                         -- 할인 금액
             , GOODS_READY_DTTM               -- 상품 준비 일시
             , RLS_CMD_DTTM                   -- 출고 지시 일시
             , RLS_CMPLT_DTTM                 -- 출고 완료 일시
             , DLVR_CMPLT_DTTM                -- 배송 완료 일시
             , GOODS_ESTM_REG_YN              -- 상품 평가 등록 여부
             , DLVR_WISH_DT                   -- 배송 희망 일자
             , ADD_OPT_YN                     -- 추가 옵션 여부
             , ADD_OPT_NO                     -- 추가 옵션 번호
             , ADD_OPT_NM                     -- 옵션명
             , ADD_OPT_DTL_SEQ                -- 추가 옵션 상세 순번
             , PVD_SVMN                        --지급적립금
             , RECOM_PVD_SVMN                  -- 추천인지급적립금
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{ordDtlSeq}                   -- 주문 상세 순번
             , '20'  -- 주문상세상태코드 20:결제완료
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END) AS GOODS_NO -- 상품 번호
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END AS ITEM_NO    -- 단품 번호
             , A.GOODS_NM                     -- 상품 명
             , A.OPT_NM                       -- 옵션 명
             , A.ORD_QTT                      -- 주문 수량
             , (SELECT CUSTOMER_PRICE FROM TG_ITEM WHERE ITEM_NO =case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END)                           -- 소비자 금액
             , (SELECT SUPPLY_PRICE FROM TG_ITEM WHERE ITEM_NO =case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END)                           -- 공급 금액
             , A.PAYMENT_AMT                  -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , null                           -- 상품 준비 일시
             , null                           -- 출고 지시 일시
             , null                           -- 출고 완료 일시
             , null                           -- 배송 완료 일시
             , null                           -- 상품 평가 등록 여부
             , A.DLVR_WISH_DT               -- 배송 희망 일자
             , 'N'                            -- 추가 옵션 여부
             , 0                           -- 추가 옵션 번호
             , null                           -- 옵션명
             , 0                           -- 추가 옵션 상세 순번
             , 0                        --지급적립금
             , 0                  -- 추천인지급적립금
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrdDtl - 3-4-2.주문 상세 처리 - 배송 테이블 배포 등록 */
        INSERT INTO TO_DLVR (
               DLVR_NO                            -- 배송 번호
             , SITE_NO                            -- 사이트 번호
             , ORD_NO                             -- 주문 번호
             , ORD_DTL_SEQ                        -- 주문 상세 순번
             , DLVR_PRC_TYPE_CD                   -- 배송 처리 유형 코드
             , DLVRC_PAYMENT_CD                   -- 배송비 결제 코드
             , DLVR_SET_CD                        -- 배송 설정 코드
             , RLS_COURIER_CD                     -- 출고 택배사 코드
             , RLS_INVOICE_NO                     -- 출고 송장 번호
             , RLS_INVOICE_REG_DTTM               -- 출고 송장 등록 일시
             , RLS_CMPLT_REG_DTTM                 -- 출고 완료 등록 일시
             , DLVR_QTT                           -- 배송 수량
             , DLVR_MSG                           -- 배송 메세지
             , ORG_DLVR_AMT                       -- 원본 배송 금액
             , REAL_DLVR_AMT                      -- 실 배송 금액
             , AREA_ADD_DLVRC                     -- 지역 추가 배송비
             , REGR_NO                            -- 등록자 번호
             , REG_DTTM                           -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0, 'TO_DLVR_NO') FROM DUAL) DLVR_NO -- 배송 번호
             , #{siteNo}                          -- 사이트 번호
             , #{ordNo}                           -- 주문 번호
             , #{ordDtlSeq}                       -- 주문 상세 순번
             , null                               -- 배송 처리 유형 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='DLVRC_PAYMENT_CD' AND CD_NM=A.SPMALL_ORD_DLVR_INFO) AS DLVRC_PAYMENT_CD -- 배송비 결제 코드
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='COURIER_CD' AND USER_DEFINE1=A.RLS_COURIER_CD) -- 출고 택배사 코드
             , null                                -- 출고 송장 번호
             , null                                -- 출고 송장 등록 일시
             , null                                -- 출고 완료 등록 일시
             , A.ORD_QTT                           -- 배송 수량
             , A.DLVR_MSG                          -- 배송 메시지
             , null                                -- 원본 배송 금액
             , A.REAL_DLVR_AMT                     -- 실 배송 금액
             , null                                -- 지역 추가 배송비
             , #{regrNo}                           -- 등록자 번호
             , sysdate                               -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrdDtl - 3-4-3.주문 상세 처리 - 단품 재고 차감 */
        UPDATE TG_ITEM
        SET STOCK_QTT=STOCK_QTT+(SELECT ORD_QTT FROM TI_ORD_CLCT_IF WHERE IF_SNO = #{ifSno})
     WHERE ITEM_NO=(SUBSTR((SELECT ITEM_NO FROM TI_ORD_CLCT_IF
                                       WHERE IF_SNO =#{ifSno}),1,16));


        /* system.link.sabangnet.procOrdDtl 3-4-4.주문 상세 처리 - 주문 수집 연계 테이블 업데이트 */
        UPDATE TI_ORD_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.ORD_DTL_SEQ   = #{ordDtlSeq}        -- 주문 상세 순번
             , A.DLVRC_NO      = (SELECT DISTINCT DLVR_NO FROM TO_DLVR WHERE ORD_NO = #{ordNo} AND ORD_DTL_SEQ = #{ordDtlSeq} AND ROWNUM = 1)            -- 배송 번호
             , A.BTCH_PRC_YN   = 'Y'                 -- 배치 처리 여부
             , A.SBN_IF_YN     = 'Y'                 -- 사방넷 연계 여부
             , A.SBN_IF_MSG    = #{resultContent}    -- 사방넷 연계 메시지
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
             , A.UPD_DTTM      =  sysdate              -- 수정 일시
         WHERE A.IF_SNO        = #{ifSno};

         END
         }
    </update>

    <!-- 3-4-5.주문 처리 - 결제금액 주문, 결제 테이블 업데이트-->
    <update id="procOrdPaymentUpdate" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procOrdPaymentUpdate 3-4-5.주문 처리 - 결제금액 주문테이블 업데이트 */
        UPDATE TO_ORD A
	       SET A.PAYMENT_AMT =  (SELECT NVL(SUM(B.SALE_AMT*B.ORD_QTT-NVL(B.DC_AMT,0)),0) AS PAYMENT_AMT
                                    FROM TO_ORD_DTL B
                                    WHERE ORD_NO = #{ordNo}
                                )  -- 결제금액
		     , A.SALE_AMT    = (SELECT NVL(SUM(B.SALE_AMT*B.ORD_QTT),0) AS SALE_AMT
                                    FROM TO_ORD_DTL B
                                    WHERE ORD_NO = #{ordNo}
                                )            -- 판매금액
		     , A.DC_AMT      = (SELECT NVL(SUM(B.DC_AMT),0) AS DC_AMT
                                    FROM TO_ORD_DTL B
                                    WHERE ORD_NO = #{ordNo}
                                )               -- 할인금액
	     WHERE A.ORD_NO = #{ordNo};


        /* system.link.sabangnet.procOrdPaymentUpdate 3-4-5.주문 처리 - 결제금액 결제테이블 업데이트 */
        UPDATE TO_PAYMENT A
           SET A.PAYMENT_AMT    =  (SELECT  NVL(SUM(B.SALE_AMT*B.ORD_QTT-NVL(B.DC_AMT,0)),0) PAYMENT_AMT
                                      FROM TO_ORD_DTL B
                                     WHERE ORD_NO = #{ordNo}
                                   )     -- 결제금액
         WHERE A.ORD_NO         = #{ordNo}
           AND A.PAYMENT_WAY_CD = 51
           AND A.PAYMENT_TURN   = 1
           AND A.ORD_NO = #{ordNo};

        END
        }
    </update>

    <!-- 3-5.클레임완료 주문 번호 조회 -->
    <select id="selectClaimCmpltOrdNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.selectClaimCmpltOrdNo - 3-5.클레임완료 주문 번호 조회 */
        SELECT A.ORD_NO
             , A.ORD_STATUS_CD  -- 주문상태코드
          FROM TO_ORD A
         WHERE A.ORD_NO = (SELECT ORD_NO FROM TI_ORD_CLCT_IF                      -- 주문수집연계
                              WHERE IF_SNO = (SELECT MIN(C.IF_SNO)
                                                FROM TI_ORD_CLCT_IF B               -- 현재 주문수집 클레임완료 자료
                                                   , TI_ORD_CLCT_IF C               -- 최초 신규주문 수집자료
                                               WHERE B.SITE_NO = #{siteNo}
                                                 AND B.IF_SNO = #{ifSno}
                                                 AND B.ORD_DLVR_STATUS IN ('취소완료','반품완료','교환완료')
                                                 AND C.SITE_NO        = B.SITE_NO         -- 사이트번호
                                                 AND C.SPMALL_ORD_NO  = B.SPMALL_ORD_NO   -- 쇼핑몰주문번호
                                                 AND C.SBN_ORD_NO     = B.SBN_ORD_NO      -- 사방넷유니크주문번호
                                                 AND C.ORD_NO        IS NOT NULL
                                                 AND C.ORD_DLVR_STATUS IN ('신규주문')      -- 주문배송상태
                                             )
                            )
    </select>

    <!-- 3-5.클레임완료 주문 상세 처리 -->
    <update id="procClaimCmpltOrdDtl" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        {CALL
		DECLARE
		BEGIN
		UPDATE TO_CLAIM SET
             RETURN_CD =  CASE WHEN #{ordDlvrStatus} = '반품완료' THEN '12'  END -- 반품코드 - 12:반품완료
            ,CLAIM_CD =  CASE WHEN #{ordDlvrStatus} = '취소완료' THEN '32'  -- 결제취소완료
                              WHEN #{ordDlvrStatus} = '반품완료' THEN '12'  -- 환불완료
                              WHEN #{ordDlvrStatus} = '교환완료' THEN '22'  -- 교환완료
                          END
            ,CLAIM_ACCEPT_DTTM = NVL(CLAIM_ACCEPT_DTTM, sysdate)
            ,CLAIM_CMPLT_DTTM = sysdate
            ,CLAIM_REASON_CD = '90'                                   -- 클레임 사유코드 90:기타
            ,CLAIM_DTL_REASON = '사방넷 연계 주문 ' || #{ordDlvrStatus}  -- 클레임 상세 사유
            ,CLAIM_MEMO = (SELECT CLAIM_MEMO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                          -- 클레임 메모
            ,UPDR_NO = #{updrNo}
            ,UPD_DTTM = sysdate
       WHERE ORD_NO            = (SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
         AND ORD_DTL_SEQ       = (SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
         ;

		/* system.link.sabangnet.procClaimCmpltDtl - 3-5-1.클레임 상세 처리 - 주문 상세 테이블 상태 수정 */
        UPDATE TO_ORD_DTL   A                   -- 주문상세
           SET A.CLAIM_NO          = #{claimNo}
               -- 주문 상세 상태 코드
             , A.ORD_DTL_STATUS_CD = CASE WHEN #{ordDlvrStatus} = '취소완료' THEN '21'  -- 결제취소
                                          WHEN #{ordDlvrStatus} = '반품완료' THEN '74'  -- 반품완료
                                          WHEN #{ordDlvrStatus} = '교환완료' THEN '60'  -- 교환완료
                                      END
               -- 반품 코드 11:반품신청, 12:반품완료
             , A.RETURN_CD         = CASE WHEN #{ordDlvrStatus} = '반품완료' THEN '12'  -- 반품코드 - 12:반품완료
                                      END
               -- 클레임 코드
             , A.CLAIM_CD          = CASE WHEN #{ordDlvrStatus} = '취소완료' THEN '32'  -- 결제취소완료
                                          WHEN #{ordDlvrStatus} = '반품완료' THEN '12'  -- 환불완료
                                          WHEN #{ordDlvrStatus} = '교환완료' THEN '22'  -- 교환완료
                                      END
             , A.CLAIM_ACCEPT_DTTM = (SELECT TO_DATE(CLAIM_ACCEPT_DTTM,'YYYYMMDDHH24MISS')  FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                    -- 클레임 접수 일시
             , A.CLAIM_REASON_CD   = '90'                                   -- 클레임 사유코드 90:기타
             , A.CLAIM_DTL_REASON  = '사방넷 연계 주문 ' || #{ordDlvrStatus}  -- 클레임 상세 사유
             , A.CLAIM_MEMO        = (SELECT CLAIM_MEMO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                          -- 클레임 메모
             , A.UPDR_NO           = #{updrNo}
             , A.UPD_DTTM          = sysdate
         WHERE A.ORD_NO            = (SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
           AND A.ORD_DTL_SEQ       = (SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno});


        /* system.link.sabangnet. 5-3-2.클레임 상세 처리 - 단품재고 차감 */
          UPDATE TG_ITEM
              SET STOCK_QTT=STOCK_QTT+(#{ordQtt} *(-1))
            WHERE ITEM_NO=SUBSTR(#{itemNo},1,16);

            END
            }
    </update>

    <!-- 3-5.클레임완료 주문상세 전체 클레임 완료 여부 조회 -->
    <select id="selectAllClaimCmpltCheck" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.selectAllClaimCmpltCheck - 3-5-2.클레임완료 주문상세 전체 클레임 완료 여부 조회 */
        SELECT CASE WHEN COUNT(*) =                                  -- 주문상세 갯수
                                    SUM(CASE WHEN ORD_DTL_STATUS_CD
                                               IN ('21','66','74')   -- 결제취소,교환완료,환불완료
                                             THEN 1 ELSE 0  END)     -- 취소완료 갯수
                    THEN 'Y' ELSE 'N'
                END                     ALL_CANCEL_CMPLT  -- 전체 취소완료여부 : 주문상세 갯수 = 취소완료 갯수
          FROM TO_ORD_DTL
         WHERE ORD_NO = #{ordNo}
    </select>

    <!-- 3-5.클레임완료 완료일 때 - 결제 테이블 인서트 +1차수 증가 -->
    <insert id="insertClaimCmpltPayment" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.insertClaimCmpltPayment - 3-5-3.클레임 완료일 때 - 결제 테이블 인서트 +1차수 증가 */
        INSERT INTO TO_PAYMENT (
               PAYMENT_NO                     -- 결제 번호
             , SITE_NO                        -- 사이트 번호
             , ORD_NO                         -- 주문 번호
             , PAYMENT_TURN                   -- 결제 차수
             , PAYMENT_PG_CD                  -- 결제 PG 코드
             , PAYMENT_WAY_CD                 -- 결제 수단 코드
             , PAYMENT_STATUS_CD              -- 결제 상태 코드
             , PAYMENT_CMPLT_DTTM             -- 결제 완료 일시
             , PAYMENT_AMT                    -- 결제 금액
             , MEMBER_NO                      -- 회원 번호
             , TX_NO                          -- 거래 번호
             , CONFIRM_NO                     -- 승인 번호
             , CONFIRM_DTTM                   -- 승인 일시
             , CONFIRM_RESULT_CD              -- 승인 결과 코드
             , CONFIRM_RESULT_MSG             -- 승인 결과 메세지
             , CARD_CD                        -- 카드사 코드
             , INSTMNT_MONTH                  -- 할부개월
             , BANK_CD                        -- 은행 코드
             , ACT_NO                         -- 계좌 번호
             , HOLDER_NM                      -- 예금주 명
             , DPSTER_NM                      -- 입금자 명
             , DPST_SCD_DT                    -- 입금 예정 일자
             , DPST_SCD_AMT                   -- 입금 예정 금액
             , DPST_CHECK_MSG                 -- 입금 확인 메세지
             , ESCROW_YN                      -- 에스크로 여부
             , ESCROW_CONFIRMNO               -- 에스크로 승인번호(올더게이트)
             , REFUND_AMT                     -- 환불금액
             , CLAIM_CMPLT_DTTM               -- 클레임완료일시
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0,'TO_PAYMENT_NO') FROM DUAL) PAYMENT_NO -- 결제 번호 채번
             , #{siteNo}                      -- 사이트 번호
             , A.ORD_NO                       -- 주문 번호
             , NVL((SELECT MAX(PAYMENT_TURN) + 1
                         FROM TO_PAYMENT
                        WHERE ORD_NO = A.ORD_NO
                          AND PAYMENT_WAY_CD = '51'     -- 사방넷
                        GROUP BY ORD_NO
                       ), 2)  PAYMENT_TURN    -- 결제 차수 + 1
             , null                           -- 결제 PG 코드
             , '51'                           -- 결제 수단 코드 51:사방넷
             , '03'                           -- 결제 상태 코드 03:취소, 01:접수, 02:완료
             , null                           -- 결제 완료 일시
             , E.PAYMENT_AMT - C.CLAIM_PAYMENT_SUM + H.REAL_DLVR_SUM   -- 최종결제금액 - 취소주문금액 + 클레임완료 제외한 배송비합계
             , null                           -- 회원 번호
             , null                           -- 거래 번호
             , null                           -- 승인 번호
             , null                           -- 승인 일시
             , null                           -- 승인 결과 코드
             , null                           -- 승인 결과 메세지
             , null                           -- 카드사 코드
             , null                           -- 할부개월
             , null                           -- 은행 코드
             , null                           -- 계좌 번호
             , null                           -- 예금주 명
             , null                           -- 입금자 명
             , null                           -- 입금 예정 일자
             , null                           -- 입금 예정 금액
             , null                           -- 입금 확인 메세지
             , null                           -- 에스크로 여부
             , null                           -- 에스크로 승인번호(올더게이트)
             , C.CLAIM_PAYMENT_SUM            -- 환불 금액
             , C.CLAIM_CMPLT_DTTM             -- 클레임 완료 일시
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TO_ORD A
             , (
               SELECT B.ORD_NO
                    , SUM(CASE WHEN B.ORD_DTL_STATUS_CD IN ('21','66','74') -- 결제취소, 교환완료, 환불완료
                            AND B.CLAIM_CMPLT_DTTM >                -- 주문상세테이블의 클레임완료일시 >
                                    (SELECT MAX(I.CLAIM_CMPLT_DTTM) -- 결제테이블의 최종 클레임완료일시
                                       FROM TO_PAYMENT I
                                      WHERE I.ORD_NO = B.ORD_NO
                                        AND I.CLAIM_CMPLT_DTTM = B.CLAIM_CMPLT_DTTM
                                      GROUP BY I.ORD_NO
                                    )
                          THEN (B.SALE_AMT*B.ORD_QTT)-B.DC_AMT
                          ELSE 0 END)                     CLAIM_PAYMENT_SUM -- 클레임 주문 금액
                    , MAX(CASE WHEN B.ORD_DTL_STATUS_CD IN ('21','66','74')
                          THEN B.CLAIM_CMPLT_DTTM END)    CLAIM_CMPLT_DTTM  -- 클레임 최종 완료 일시
                 FROM TO_ORD_DTL B
                WHERE B.ORD_NO = #{ordNo}
                GROUP BY B.ORD_NO
               ) C
             , (
               SELECT D.ORD_NO
                    , D.PAYMENT_AMT           -- 최종 결제 금액
                 FROM TO_PAYMENT D
                WHERE D.ORD_NO = #{ordNo}
                  AND D.PAYMENT_TURN = (SELECT MAX(PAYMENT_TURN) FROM TO_PAYMENT    -- 최종 결제 차수
                                         WHERE ORD_NO = D.ORD_NO
                                           AND PAYMENT_WAY_CD = D.PAYMENT_WAY_CD)
               ) E
              ,(
               SELECT F.ORD_NO
                    , SUM(F.REAL_DLVR_AMT)                      DLVR_SUM      -- 배송비합계
                    , SUM(CASE WHEN G.ORD_DTL_STATUS_CD IN ('21','66','74')
                               THEN F.REAL_DLVR_AMT ELSE 0 END) REAL_DLVR_SUM -- 클레임완료 제외한 배송비합계
                 FROM TO_DLVR F
                    , TO_ORD_DTL G
                WHERE F.ORD_NO = #{ordNo}
                  AND G.ORD_NO = F.ORD_NO
                  AND G.ORD_DTL_SEQ = F.ORD_DTL_SEQ
                  GROUP BY F.ORD_NO
               ) H
         WHERE A.ORD_NO  = #{ordNo}
           AND C.ORD_NO  = A.ORD_NO
           AND E.ORD_NO  = A.ORD_NO
           AND H.ORD_NO  = A.ORD_NO
    </insert>

    <!-- 3-6.클레임완료 주문, 결제 테이블 주문상태코드 21, 결제상태코드 03 업데이트 처리 -->
    <update id="procClaimCmpltOrdPayment" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procClaimCmpltOrdPayment - 3-6-1.전체 클레임완료 주문 테이블 주문상태코드 21 업데이트 처리 */
        UPDATE TO_ORD A
           SET A.ORD_STATUS_CD = '21'                                        -- 주문상태코드 21:결제취소
         WHERE A.ORD_NO        = (SELECT B.ORD_NO
                  FROM TO_ORD_DTL B
                 WHERE B.ORD_NO = #{ordNo}      -- 주문번호
               )      -- 주문번호
           AND C.SEQ_CNT       = (SELECT
                      SUM(CASE WHEN B.ORD_DTL_STATUS_CD IN ('21','66','74') -- 결제취소,교환완료,환불완료 카운트
                                THEN 1 ELSE 0 END) CANCEL_CNT
                  FROM TO_ORD_DTL B
                 WHERE B.ORD_NO = #{ordNo}      -- 주문번호
               ) -- 주문상세 전체 클레임완료 : 주문상세 갯수 = 클레임완료 갯수
               ;


        /* system.link.sabangnet.procClaimCmpltOrdPayment - 3-6-2.전체 클레임완료 결제 테이블 결제상태코드 03 업데이트 처리 */
        UPDATE TO_PAYMENT A
           SET A.PAYMENT_STATUS_CD = '03'                               -- 결제상태코드 03:취소
             , A.REFUND_AMT        = E.BF_PAYMENT_AMT - C.AF_PAYMENT_AMT  -- 환불 금액 = 직전결제금액 - 최종결제금액
         WHERE A.ORD_NO         = #{ordNo}          -- 주문번호
           AND A.ORD_NO         =  (
                SELECT B.ORD_NO
                  FROM TO_PAYMENT B
                 WHERE B.PAYMENT_TURN = (SELECT MAX(D.PAYMENT_TURN)     -- 최종 결제차수
                                           FROM TO_PAYMENT D
                                          WHERE D.ORD_NO = #{ordNo}     -- 주문번호
                                            AND D.ORD_NO = B.ORD_NO
                                            AND D.PAYMENT_WAY_CD = B.PAYMENT_WAY_CD
                                            AND D.PAYMENT_TURN > 1
                                        )
               )         -- 주문번호
           AND A.PAYMENT_WAY_CD =  (
                SELECT  B.PAYMENT_WAY_CD
                  FROM TO_PAYMENT B
                 WHERE B.PAYMENT_TURN = (SELECT MAX(D.PAYMENT_TURN)     -- 최종 결제차수
                                           FROM TO_PAYMENT D
                                          WHERE D.ORD_NO = #{ordNo}     -- 주문번호
                                            AND D.ORD_NO = B.ORD_NO
                                            AND D.PAYMENT_WAY_CD = B.PAYMENT_WAY_CD
                                            AND D.PAYMENT_TURN > 1
                                        )
               )  -- 결제방법코드
           AND A.ORD_NO         = (
                SELECT B.ORD_NO
                  FROM TO_PAYMENT B
                 WHERE B.PAYMENT_TURN = (SELECT MAX(D.PAYMENT_TURN)-1   -- 직전 결제차수
                                           FROM TO_PAYMENT D
                                          WHERE D.ORD_NO = #{ordNo}     -- 주문번호
                                            AND D.ORD_NO = B.ORD_NO
                                            AND D.PAYMENT_WAY_CD = B.PAYMENT_WAY_CD
                                            AND D.PAYMENT_TURN >= 1
                                        )
               )          -- 주문번호
           AND A.PAYMENT_WAY_CD = (
                SELECT  B.PAYMENT_WAY_CD
                  FROM TO_PAYMENT B
                 WHERE B.PAYMENT_TURN = (SELECT MAX(D.PAYMENT_TURN)-1   -- 직전 결제차수
                                           FROM TO_PAYMENT D
                                          WHERE D.ORD_NO = #{ordNo}     -- 주문번호
                                            AND D.ORD_NO = B.ORD_NO
                                            AND D.PAYMENT_WAY_CD = B.PAYMENT_WAY_CD
                                            AND D.PAYMENT_TURN >= 1
                                        )
               )  -- 결제방법코드
           AND A.PAYMENT_TURN   = 1                   -- 최초 결제차수
           ;
           END
           }
    </update>

    <!-- 3-9.클레임완료 - 교환 재주문 처리 -->
    <update id="procClaimReOrder" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procClaimReOrder - 3-9-1.클레임완료 - 교환 재주문 처리 - 주문 테이블 등록 */
        INSERT INTO TO_ORD (
               ORD_NO
             , SITE_NO
             , ORG_ORD_NO
             , ORD_STATUS_CD
             , ORD_MEDIA_CD
             , SALE_CHANNEL_CD
             , MEMBER_ORD_YN
             , MEMBER_NO
             , LOGIN_ID
             , MEMBER_GRADE_NO
             , ORD_SECT_NO
             , ORDR_NM
             , ORDR_EMAIL
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_IP
             , ORD_ACCEPT_DTTM
             , ORD_CMPLT_DTTM
             , ORD_CANCEL_DTTM
             , PAYMENT_CMPLT_DTTM
             , SMS_RECV_YN
             , EMAIL_RECV_YN
             , PVD_SVMN
             , MANUAL_ORD_YN
             , PAYMENT_AMT
             , SALE_AMT
             , DC_AMT
             , REGR_NO
             , REG_DTTM
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , A.SITE_NO                      -- 사이트 번호
             , A.ORD_NO                       -- 원본 주문번호 (클레임연계 테이블의 주문번호)
             , '20'                           -- 주문상태 20:결제완료
             , '01'                           -- 주문매체 코드 PC
             , (SELECT C.CD
                  FROM TA_CMN_CD_DTL C
                 WHERE C.GRP_CD = 'SALE_CHANNEL_CD'
                   AND C.CD_NM  = A.SPMALL_ID)  -- 판매채널 코드
             , 'N'                            -- 회원주문 여부
             , null                           -- 주문자 번호
             , A.SPMALL_LOGIN_ID              -- 쇼핑몰 로그인 아이디
             , null                           -- 회원등급 번호
             , null                           -- 주문 비밀번호
             , A.ORDR_NM                      -- 주문자 명
             , A.ORDR_EMAIL                   -- 주문자 이메일
             , A.ORDR_TEL                     -- 주문자 전화
             , A.ORDR_MOBILE                  -- 주문자 휴대폰
             , null                           -- 주문자 IP
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_ACCEPT_DTTM  -- 주문접수 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , TO_DATE(A.ORD_CANCEL_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_CANCEL_DTTM  -- 주문취소 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , null                           -- SMS 수신 여부
             , null                           -- 이메일 수신 여부
             , null                           -- 지급 마켓포인트
             , 'N'                            -- 수기주문 여부
             , A.PAYMENT_AMT                  -- 결제 금액
             , A.SALE_AMT                     -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
         WHERE 1=1
           AND A.IF_SNO = #{ifSno};


        /* system.link.sabangnet.procClaimReOrder - 3-9-2.클레임완료 - 교환 재주문 처리 - 주문 배송지 테이블 등록 */
        INSERT INTO TO_ORD_DELIVERY (
               ORD_NO                         -- 주문 번호
             , MEMBER_NO                      -- 회원 번호
             , AREA_DLVR_SET_NO               -- 지역 배송 설정 번호
             , SITE_NO                        -- 사이트 번호
             , DELIVERY_NM                    -- 배송지 명
             , ADRS_NM                        -- 수취인 명
             , ADRS_TEL                       -- 수취인 전화
             , ADRS_MOBILE                    -- 수취인 휴대폰
             , POST_NO                        -- 신 우편 번호
             , ROADNM_ADDR                    -- 도로명 주소
             , NUM_ADDR                       -- 지번 주소
             , DTL_ADDR                       -- 도로명 상세 주소
             , DLVR_MSG                       -- 배송 메세지
             , MEMBER_GB_CD                   -- 회원 구분 코드
             , FRG_ADDR_COUNTRY               -- 해외 주소 COUNTRY
             , FRG_ADDR_CITY                  -- 해외 주소 CITY
             , FRG_ADDR_STATE                 -- 해외 주소 STATE
             , FRG_ADDR_ZIP_CODE              -- 해외 주소 우편번호
             , FRG_ADDR_DTL1                  -- 해외 주소 상세1
             , FRG_ADDR_DTL2                  -- 해외 주소 상세2
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 회원 번호
             , null                           -- 지역 배송 설정 번호
             , A.SITE_NO                      -- 사이트 번호
             , null                           -- 배송지 명
             , A.ADRS_NM                      -- 수취인 명
             , A.ADRS_TEL                     -- 수취인 전화
             , A.ADRS_MOBILE                  -- 수취인 휴대폰
             , A.POST_NO                      -- 신 우편 번호
             , null                           -- 도로명 주소
             , null                           -- 지번 주소
             , A.DTL_ADDR                     -- 도로명 상세 주소
             , A.DLVR_MSG                     -- 배송 메세지
             , null                           -- 회원 구분 코드
             , null                           -- 해외 주소 COUNTRY
             , null                           -- 해외 주소 CITY
             , null                           -- 해외 주소 STATE
             , null                           -- 해외 주소 우편번호
             , null                           -- 해외 주소 상세1
             , A.DLVR_WISH_DT                 -- 해외 주소 상세2
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
         WHERE 1=1
           AND A.DTL_ADDR IS NOT NULL
           AND A.IF_SNO = #{ifSno};


        /* system.link.sabangnet.procClaimReOrder - 3-9-4.클레임완료 교환 재주문 처리 - 주문번호를 주문수집연계 테이블에 업데이트 */
        UPDATE TI_ORD_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
         WHERE A.IF_SNO        = #{ifSno};

         END
         }
    </update>

    <!-- 3-9.클레임완료 - 재주문상세 처리 -->
    <update id="procClaimReOrderDtl" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procClaimReOrderDtl - 3-9-5.클레임상세 - 재주문상세 처리 - 주문상세 테이블 등록 */
        INSERT INTO TO_ORD_DTL (
               ORD_NO                         -- 주문 번호
             , ORD_DTL_SEQ                    -- 주문 상세 순번
             , ORD_DTL_STATUS_CD              -- 주문 상세 상태 코드
             , GOODS_NO                       -- 상품 번호
             , ITEM_NO                        -- 단품 번호
             , GOODS_NM                       -- 상품 명
             , ITEM_NM                        -- 단품 명
             , ORD_QTT                        -- 주문 수량
             , CUSTOMER_AMT                   -- 소비자 금액
             , SALE_AMT                       -- 판매 금액
             , DC_AMT                         -- 할인 금액
             , GOODS_READY_DTTM               -- 상품 준비 일시
             , RLS_CMD_DTTM                   -- 출고 지시 일시
             , RLS_CMPLT_DTTM                 -- 출고 완료 일시
             , DLVR_CMPLT_DTTM                -- 배송 완료 일시
             , GOODS_ESTM_REG_YN              -- 상품 평가 등록 여부
             , DLVR_WISH_DT                   -- 배송 희망 일자
             , ADD_OPT_YN                     -- 추가 옵션 여부
             , ADD_OPT_NO                     -- 추가 옵션 번호
             , ADD_OPT_NM                     -- 옵션명
             , ADD_OPT_DTL_SEQ                -- 추가 옵션 상세 순번
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{ordDtlSeq}                   -- 주문 상세 순번
             , '20'                           -- 주문 상세 상태 코드 20:결제완료
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END) AS GOODS_NO -- 상품 번호
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END AS ITEM_NO    -- 단품 번호
             , A.GOODS_NM                     -- 상품 명
             , A.OPT_NM                       -- 옵션 명
             , A.ORD_QTT                      -- 주문 수량
             , null                           -- 소비자 금액
             , A.PAYMENT_AMT                  -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , null                           -- 상품 준비 일시
             , null                           -- 출고 지시 일시
             , null                           -- 출고 완료 일시
             , null                           -- 배송 완료 일시
             , null                           -- 상품 평가 등록 여부
             , A.RLS_INVOICE_NO               -- 배송 희망 일자
             , 'N'                            -- 추가 옵션 여부
             , null                           -- 추가 옵션 번호
             , null                           -- 옵션명
             , null                           -- 추가 옵션 상세 순번
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
         WHERE 1=1
           AND A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimReOrderDtl - 3-9-6.재주문 상세 처리 - 배송 테이블 배포 등록 */
        INSERT INTO TO_DLVR (
               DLVR_NO                            -- 배송 번호
             , SITE_NO                            -- 사이트 번호
             , ORD_NO                             -- 주문 번호
             , ORD_DTL_SEQ                        -- 주문 상세 순번
             , DLVR_PRC_TYPE_CD                   -- 배송 처리 유형 코드
             , DLVRC_PAYMENT_CD                   -- 배송비 결제 코드
             , DLVR_SET_CD                        -- 배송 설정 코드
             , RLS_COURIER_CD                     -- 출고 택배사 코드
             , RLS_INVOICE_NO                     -- 출고 송장 번호
             , RLS_INVOICE_REG_DTTM               -- 출고 송장 등록 일시
             , RLS_CMPLT_REG_DTTM                 -- 출고 완료 등록 일시
             , DLVR_QTT                           -- 배송 수량
             , DLVR_MSG                           -- 배송 메세지
             , ORG_DLVR_AMT                       -- 원본 배송 금액
             , REAL_DLVR_AMT                      -- 실 배송 금액
             , AREA_ADD_DLVRC                     -- 지역 추가 배송비
             , REGR_NO                            -- 등록자 번호
             , REG_DTTM                           -- 등록 일시
        )
        SELECT
               (SELECT fn_getSeq(0, 'TO_DLVR_NO') FROM DUAL) DLVR_NO -- 배송 번호
             , #{siteNo}                          -- 사이트 번호
             , #{ordNo}                           -- 주문 번호
             , #{ordDtlSeq}                       -- 주문 상세 순번
             , null                               -- 배송 처리 유형 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='DLVRC_PAYMENT_CD' AND CD_NM=A.SPMALL_ORD_DLVR_INFO) AS DLVRC_PAYMENT_CD -- 배송비 결제 코드
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='COURIER_CD' AND USER_DEFINE1=A.RLS_COURIER_CD) -- 출고 택배사 코드
             , null                                -- 출고 송장 번호
             , null                                -- 출고 송장 등록 일시
             , null                                -- 출고 완료 등록 일시
             , A.ORD_QTT                           -- 배송 수량
             , A.DLVR_MSG                          -- 배송 메시지
             , null                                -- 원본 배송 금액
             , A.REAL_DLVR_AMT                     -- 실 배송 금액
             , null                                -- 지역 추가 배송비
             , #{regrNo}                           -- 등록자 번호
             , sysdate                               -- 등록 일시
          FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
         WHERE 1=1
           AND A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimDtl - 3-9-7.클레임 상세 처리 - 클레임 수집 연계 테이블 업데이트 */
        UPDATE TI_CLAIM_CLCT_IF                 -- 클레임 수집 연계
           SET CLAIM_NO      = #{claimNo}       -- 클레임 번호
             , BTCH_PRC_YN   = 'Y'              -- 배치 처리 여부
             , SBN_IF_YN     = 'Y'              -- 사방넷 연계 여부
             , SBN_IF_MSG    = #{resultContent} -- 사방넷 연계 메시지
             , UPDR_NO       = #{updrNo}        -- 수정자 번호
             , UPD_DTTM      = sysdate            -- 수정 일시
         WHERE IF_SNO = #{ifSno}
           AND ORD_DLVR_STATUS = '교환완료';

           END
           }
    </update>

    <!-- 3-10.클레임완료 - 결제금액,판매금액,할인금액 주문 테이블 업데이트 -->
    <update id="updateClaimCmpltReOrdAmt" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        /* system.link.sabangnet.updateClaimCmpltReOrdAmt - 3-10.클레임완료 - 결제금액,판매금액,할인금액 주문 테이블 업데이트 */
        UPDATE TO_ORD F
           SET F.PAYMENT_AMT = (SELECT
                     (SELECT SUM(B.SALE_AMT*B.ORD_QTT-NVL(B.DC_AMT,0)) FROM TO_ORD_DTL B
                         WHERE B.ORD_NO = A.ORD_NO
                           AND B.ORD_DTL_STATUS_CD NOT IN ('11','21','22', '66', '74')
                       )                  PAYMENT_AMT -- 결제 금액
                  FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
                 WHERE 1=1
                   AND A.IF_SNO = #{ifSno}
               )
             , F.SALE_AMT    = (SELECT
                     (SELECT SUM(C.SALE_AMT) FROM TO_ORD_DTL C
                         WHERE C.ORD_NO = A.ORD_NO
                           AND C.ORD_DTL_STATUS_CD NOT IN ('11','21','22', '66', '74')
                       )                  SALE_AMT    -- 판매 금액
                  FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
                 WHERE 1=1
                   AND A.IF_SNO = #{ifSno}
               )
             , F.DC_AMT      = (SELECT
                    (SELECT SUM(NVL(D.DC_AMT,0)) FROM TO_ORD_DTL D
                         WHERE D.ORD_NO = A.ORD_NO
                           AND D.ORD_DTL_STATUS_CD NOT IN ('11','21','22','23', '60','66', '70','74')
                       )                  DC_AMT      -- 할인 금액
                  FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
                 WHERE 1=1
                   AND A.IF_SNO = #{ifSno}
               )
         WHERE F.ORD_NO      = (SELECT
                      A.ORD_NO
                  FROM TI_ORD_CLCT_IF A                                                     -- 주문수집 연계 테이블
                 WHERE 1=1
                   AND A.IF_SNO = #{ifSno}
               )
    </update>

    <!-- 3-7.클레임완료 NoOrd 주문 테이블에 주문자료가 없는 경우 -->
    <update id="procClaimCmpltNoOrd" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procOrd - 3-7-1.클레임완료 NoOrd 주문 처리 - 주문 테이블 등록 */
        INSERT INTO TO_ORD (
               ORD_NO
             , SITE_NO
             , ORG_ORD_NO
             , ORD_STATUS_CD
             , ORD_MEDIA_CD
             , SALE_CHANNEL_CD
             , MEMBER_ORD_YN
             , MEMBER_NO
             , LOGIN_ID
             , MEMBER_GRADE_NO
             , ORD_SECT_NO
             , ORDR_NM
             , ORDR_EMAIL
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_IP
             , ORD_ACCEPT_DTTM
             , ORD_CMPLT_DTTM
             , ORD_CANCEL_DTTM
             , PAYMENT_CMPLT_DTTM
             , SMS_RECV_YN
             , EMAIL_RECV_YN
             , PVD_SVMN
             , MANUAL_ORD_YN
             , PAYMENT_AMT
             , SALE_AMT
             , DC_AMT
             , REGR_NO
             , REG_DTTM
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{siteNo}                      -- 사이트 번호
             , #{orgOrdNo}                    -- 원본 주문번호
             , '21' -- 주문상태 21:결제취소
             , '01'                           -- 주문매체 코드 PC
             , (SELECT B.CD
                  FROM TA_CMN_CD_DTL B
                 WHERE B.GRP_CD = 'SALE_CHANNEL_CD'
                   AND B.CD_NM  = A.SPMALL_ID)  -- 판매채널 코드
             , 'N'                            -- 회원주문 여부
             , null                           -- 주문자 번호
             , A.SPMALL_LOGIN_ID              -- 쇼핑몰 로그인 아이디
             , null                           -- 회원등급 번호
             , null                           -- 주문 비밀번호
             , A.ORDR_NM                      -- 주문자 명
             , A.ORDR_EMAIL                   -- 주문자 이메일
             , A.ORDR_TEL                     -- 주문자 전화
             , A.ORDR_MOBILE                  -- 주문자 휴대폰
             , null                           -- 주문자 IP
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_ACCEPT_DTTM  -- 주문접수 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , TO_DATE(A.ORD_CANCEL_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_CANCEL_DTTM  -- 주문취소 일시
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , null                           -- SMS 수신 여부
             , null                           -- 이메일 수신 여부
             , null                           -- 지급 마켓포인트
             , 'N'                            -- 수기주문 여부
             , #{paymentAmt}                  -- 결제 금액
             , A.SALE_AMT                     -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-7-2.클레임완료 NoOrd 주문 처리 - 주문 배송지 테이블 등록 */
        INSERT INTO TO_ORD_DELIVERY (
               ORD_NO                         -- 주문 번호
             , MEMBER_NO                      -- 회원 번호
             , AREA_DLVR_SET_NO               -- 지역 배송 설정 번호
             , SITE_NO                        -- 사이트 번호
             , DELIVERY_NM                    -- 배송지 명
             , ADRS_NM                        -- 수취인 명
             , ADRS_TEL                       -- 수취인 전화
             , ADRS_MOBILE                    -- 수취인 휴대폰
             , POST_NO                        -- 신 우편 번호
             , ROADNM_ADDR                    -- 도로명 주소
             , NUM_ADDR                       -- 지번 주소
             , DTL_ADDR                       -- 도로명 상세 주소
             , DLVR_MSG                       -- 배송 메세지
             , MEMBER_GB_CD                   -- 회원 구분 코드
             , FRG_ADDR_COUNTRY               -- 해외 주소 COUNTRY
             , FRG_ADDR_CITY                  -- 해외 주소 CITY
             , FRG_ADDR_STATE                 -- 해외 주소 STATE
             , FRG_ADDR_ZIP_CODE              -- 해외 주소 우편번호
             , FRG_ADDR_DTL1                  -- 해외 주소 상세1
             , FRG_ADDR_DTL2                  -- 해외 주소 상세2
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , null                           -- 회원 번호
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             , #{siteNo}                      -- 사이트 번호
             , null                           -- 배송지 명
             , A.ADRS_NM                      -- 수취인 명
             , A.ADRS_TEL                     -- 수취인 전화
             , A.ADRS_MOBILE                  -- 수취인 휴대폰
             , A.POST_NO                      -- 신 우편 번호
             , null                           -- 도로명 주소
             , null                           -- 지번 주소
             , A.DTL_ADDR                     -- 도로명 상세 주소
             , A.DLVR_MSG                     -- 배송 메세지
             , null                           -- 회원 구분 코드
             , null                           -- 해외 주소 COUNTRY
             , null                           -- 해외 주소 CITY
             , null                           -- 해외 주소 STATE
             , null                           -- 해외 주소 우편번호
             , null                           -- 해외 주소 상세1
             , A.DLVR_WISH_DT                 -- 해외 주소 상세2
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE 1=1
           AND A.DTL_ADDR IS NOT NULL
           AND A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-7-3.클레임완료 NoOrd 주문 처리 - 결제 테이블 배포 등록 */
        INSERT INTO TO_PAYMENT (
               PAYMENT_NO                     -- 결제 번호
             , SITE_NO                        -- 사이트 번호
             , ORD_NO                         -- 주문 번호
             , PAYMENT_TURN                   -- 결제 차수
             , PAYMENT_PG_CD                  -- 결제 PG 코드
             , PAYMENT_WAY_CD                 -- 결제 수단 코드
             , PAYMENT_STATUS_CD              -- 결제 상태 코드
             , PAYMENT_CMPLT_DTTM             -- 결제 완료 일시
             , PAYMENT_AMT                    -- 결제 금액
             , MEMBER_NO                      -- 회원 번호
             , TX_NO                          -- 거래 번호
             , CONFIRM_NO                     -- 승인 번호
             , CONFIRM_DTTM                   -- 승인 일시
             , CONFIRM_RESULT_CD              -- 승인 결과 코드
             , CONFIRM_RESULT_MSG             -- 승인 결과 메세지
             , CARD_CD                        -- 카드사 코드
             , INSTMNT_MONTH                  -- 할부개월
             , BANK_CD                        -- 은행 코드
             , ACT_NO                         -- 계좌 번호
             , HOLDER_NM                      -- 예금주 명
             , DPSTER_NM                      -- 입금자 명
             , DPST_SCD_DT                    -- 입금 예정 일자
             , DPST_SCD_AMT                   -- 입금 예정 금액
             , DPST_CHECK_MSG                 -- 입금 확인 메세지
             , ESCROW_YN                      -- 에스크로 여부
             , ESCROW_CONFIRMNO               -- 에스크로 승인번호(올더게이트)
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0,'TO_PAYMENT_NO') FROM DUAL) PAYMENT_NO -- 결제 번호
             , #{siteNo}                      -- 사이트 번호
             , #{ordNo}                       -- 주문 번호
             , 1                              -- 결제 차수
             , null                           -- 결제 PG 코드
             , '51'                           -- 결제 수단 코드 51:사방넷
             , '03'                           -- 결제 상태 코드 03:취소, 01:접수, 02:완료
             , TO_DATE((CASE WHEN A.ORD_CMPLT_DTTM IS NULL OR A.ORD_CMPLT_DTTM = ''
                                 THEN A.ORD_ACCEPT_DTTM
                                 ELSE A.ORD_CMPLT_DTTM END), 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , A.PAYMENT_AMT                  -- 결제 금액
             , null                           -- 회원 번호
             , null                           -- 거래 번호
             , null                           -- 승인 번호
             , null                           -- 승인 일시
             , null                           -- 승인 결과 코드
             , null                           -- 승인 결과 메세지
             , null                           -- 카드사 코드
             , null                           -- 할부개월
             , null                           -- 은행 코드
             , null                           -- 계좌 번호
             , null                           -- 예금주 명
             , null                           -- 입금자 명
             , null                           -- 입금 예정 일자
             , null                           -- 입금 예정 금액
             , null                           -- 입금 확인 메세지
             , null                           -- 에스크로 여부
             , null                           -- 에스크로 승인번호(올더게이트)
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrd - 3-7-4.클레임완료 NoOrd 주문 처리 - 주문번호를 주문수집연계 테이블에 업데이트 */
        UPDATE TI_ORD_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
         WHERE A.IF_SNO        = #{ifSno};

         END
         }
    </update>

    <!-- 3-8.클레임완료 NoOrd 주문 상세 처리 -->
    <update id="procClaimCmpltOrdDtlNoOrd" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procOrdDtl - 3-8-1.클레임완료 NoOrd 주문 상세 처리 - 주문 상세 테이블 등록 */
        INSERT INTO TO_ORD_DTL (
               ORD_NO                         -- 주문 번호
             , ORD_DTL_SEQ                    -- 주문 상세 순번
             , ORD_DTL_STATUS_CD              -- 주문 상세 상태 코드
             , GOODS_NO                       -- 상품 번호
             , ITEM_NO                        -- 단품 번호
             , GOODS_NM                       -- 상품 명
             , ITEM_NM                        -- 단품 명
             , ORD_QTT                        -- 주문 수량
             , CUSTOMER_AMT                   -- 소비자 금액
             , SALE_AMT                       -- 판매 금액
             , DC_AMT                         -- 할인 금액
             , GOODS_READY_DTTM               -- 상품 준비 일시
             , RLS_CMD_DTTM                   -- 출고 지시 일시
             , RLS_CMPLT_DTTM                 -- 출고 완료 일시
             , DLVR_CMPLT_DTTM                -- 배송 완료 일시
             , GOODS_ESTM_REG_YN              -- 상품 평가 등록 여부
             , DLVR_WISH_DT                   -- 배송 희망 일자
             , ADD_OPT_YN                     -- 추가 옵션 여부
             , ADD_OPT_NO                     -- 추가 옵션 번호
             , ADD_OPT_NM                     -- 옵션명
             , ADD_OPT_DTL_SEQ                -- 추가 옵션 상세 순번
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{ordDtlSeq}                   -- 주문 상세 순번
             , (SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='ORD_DTL_STATUS_CD'
                AND CD_NM = DECODE(A.ORD_DLVR_STATUS,'신규주문','결제완료','주문확인','결제완료','출고대기','배송준비중','출고완료','배송중','취소접수','결제취소신청','교환접수','교환신청','반품접수','반품신청','취소완료','결제취소','교환완료','교환완료','반품완료','반품완료','')
                ) AS ORD_DTL_STATUS_CD -- 주문상세상태코드 결제완료
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END) AS GOODS_NO -- 상품 번호
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END AS ITEM_NO    -- 단품 번호
             , A.GOODS_NM                     -- 상품 명
             , A.OPT_NM                       -- 옵션 명
             , A.ORD_QTT                      -- 주문 수량
             , null                           -- 소비자 금액
             , A.PAYMENT_AMT                  -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , null                           -- 상품 준비 일시
             , null                           -- 출고 지시 일시
             , null                           -- 출고 완료 일시
             , null                           -- 배송 완료 일시
             , null                           -- 상품 평가 등록 여부
             , A.RLS_INVOICE_NO               -- 배송 희망 일자
             , 'N'                            -- 추가 옵션 여부
             , null                           -- 추가 옵션 번호
             , null                           -- 옵션명
             , null                           -- 추가 옵션 상세 순번
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procOrdDtl - 3-8-3.클레임완료 NoOrd 주문 상세 처리 - 배송 테이블 배포 등록 */
        INSERT INTO TO_DLVR (
               DLVR_NO                            -- 배송 번호
             , SITE_NO                            -- 사이트 번호
             , ORD_NO                             -- 주문 번호
             , ORD_DTL_SEQ                        -- 주문 상세 순번
             , DLVR_PRC_TYPE_CD                   -- 배송 처리 유형 코드
             , DLVRC_PAYMENT_CD                   -- 배송비 결제 코드
             , DLVR_SET_CD                        -- 배송 설정 코드
             , RLS_COURIER_CD                     -- 출고 택배사 코드
             , RLS_INVOICE_NO                     -- 출고 송장 번호
             , RLS_INVOICE_REG_DTTM               -- 출고 송장 등록 일시
             , RLS_CMPLT_REG_DTTM                 -- 출고 완료 등록 일시
             , DLVR_QTT                           -- 배송 수량
             , DLVR_MSG                           -- 배송 메세지
             , ORG_DLVR_AMT                       -- 원본 배송 금액
             , REAL_DLVR_AMT                      -- 실 배송 금액
             , AREA_ADD_DLVRC                     -- 지역 추가 배송비
             , REGR_NO                            -- 등록자 번호
             , REG_DTTM                           -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0, 'TO_DLVR_NO') FROM DUAL) DLVR_NO -- 배송 번호
             , #{siteNo}                          -- 사이트 번호
             , #{ordNo}                           -- 주문 번호
             , #{ordDtlSeq}                       -- 주문 상세 순번
             , null                               -- 배송 처리 유형 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='DLVRC_PAYMENT_CD' AND CD_NM=A.SPMALL_ORD_DLVR_INFO) AS DLVRC_PAYMENT_CD -- 배송비 결제 코드
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='COURIER_CD' AND USER_DEFINE1=A.RLS_COURIER_CD) -- 출고 택배사 코드
             , null                                -- 출고 송장 번호
             , null                                -- 출고 송장 등록 일시
             , null                                -- 출고 완료 등록 일시
             , A.ORD_QTT                           -- 배송 수량
             , A.DLVR_MSG                          -- 배송 메시지
             , null                                -- 원본 배송 금액
             , A.REAL_DLVR_AMT                     -- 실 배송 금액
             , null                                -- 지역 추가 배송비
             , #{regrNo}                           -- 등록자 번호
             , sysdate                               -- 등록 일시
          FROM TI_ORD_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet. 3-8-5.클레임완료 NoOrd 주문 상세 처리 - 주문 수집 연계 테이블 업데이트 */
        UPDATE TI_ORD_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.ORD_DTL_SEQ   = #{ordDtlSeq}        -- 주문 상세 순번
             , A.DLVRC_NO      = (SELECT DISTINCT DLVR_NO FROM TO_DLVR WHERE ORD_NO = #{ordNo} AND ORD_DTL_SEQ = #{ordDtlSeq} AND ROWNUM = 1)           -- 배송 번호
             , A.BTCH_PRC_YN   = 'Y'                 -- 배치 처리 여부
             , A.SBN_IF_YN     = 'Y'                 -- 사방넷 연계 여부
             , A.SBN_IF_MSG    = #{resultContent}    -- 사방넷 연계 메시지
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
             , A.UPD_DTTM      =  sysdate              -- 수정 일시
         WHERE A.IF_SNO        = #{ifSno};

         END
         }
    </update>

    <!-- 3-10.주문수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 -->
    <delete id="deleteOrdClctIfPastData">
        /* system.link.sabangnet.deleteOrdClctIfPastData - 3-10.주문수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 */
        DELETE FROM TI_ORD_CLCT_IF
         WHERE SITE_NO = #{siteNo}
           AND IF_SNO IN (
                      SELECT IF_SNO
                        FROM (
                              SELECT IF_SNO
                                FROM TI_ORD_CLCT_IF A
                               WHERE A.SITE_NO = #{siteNo}
                                 AND IF_SNO NOT IN (    -- 최종 IF_SNO (주문번호,주문상세순번 별 최종)는 제외
                                            SELECT MAX(B.IF_SNO) FROM TI_ORD_CLCT_IF B
                                             WHERE B.SITE_NO = #{siteNo}
                                               AND B.ORD_NO IS NOT NULL
                                             GROUP BY B.SPMALL_ORD_NO, B.SBN_ORG_ORD_NO, B.SBN_ORD_NO, B.ORD_DLVR_STATUS
                                                    , B.ORD_NO, B.ORD_DTL_SEQ, B.ORD_ACCEPT_DTTM, B.ORD_CMPLT_DTTM
                                                    , B.ORD_CANCEL_DTTM, B.RETURN_CMPLT_REG_DTTM, B.EXCHG_CMPLT_DTTM
                                                    , B.SALE_AMT, B.ORD_QTT, B.DLVRC_NO, B.SBN_IF_YN
                                             )
                           ) C
                    )
    </delete>

    <!-- 4.송장 등록 -->
    <resultMap id="invoiceRegiRequest" type="net.danvi.dmall.biz.batch.link.sabangnet.model.request.InvoiceRequest">
        <collection column="{siteNo=SITE_NO, ifNo=IF_NO}" property="data" javaType="ArrayList"
                    ofType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.Invoice"
                    select="system.link.sabangnet.selectInvoiceRegiData"/>
    </resultMap>
    <!-- 4.송장 등록 데이터 조회 -->
    <select id="selectInvoiceRegi" resultMap="system.link.sabangnet.invoiceRegiRequest">
        /* system.link.sabangnet.selectInvoiceRegi - 4.송장 등록 데이터 조회 */
        SELECT  TC.SBN_ID                       AS sendCompaynyId,
                SBN_CERT_KEY                    AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD')    AS sendDate,
                TS.SITE_NO,
                #{ifNo}                         AS IF_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>
    <!-- 4.송장 등록 데이터 조회-->
    <select id="selectInvoiceRegiData" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.Invoice">
        /* system.link.sabangnet.selectInvoiceRegiData - 4.송장 등록 데이터 조회 */
        SELECT
                SBN_ORD_NO                      AS SabangnetIdx
              , NVL(RLS_COURIER_CD, '')      AS TakCode
              , NVL(RLS_INVOICE_NO, '')      AS TakInvoice
          FROM  TI_INVOICE_REG_IF
         WHERE  SITE_NO = #{siteNo}             -- 사이트번호
           AND  IF_NO   = #{ifNo}               -- 연계번호
           AND  (NVL(SBN_IF_YN,'N') = 'N' OR SBN_IF_YN = '')   -- 'N' 사방넷연계 여부
           AND  NVL(BTCH_PRC_YN,'N') = 'Y'   -- 배치처리여부
         ORDER BY IF_SNO
    </select>

    <!-- 4-1.송장등록 연계 사방넷연계여부 수정 -->
    <update id="updateInvoiceRegSbnIfYn" parameterType="net.danvi.dmall.biz.batch.common.model.IfExecLogVO">
        /* system.link.sabangnet.updateInvoiceRegSbnIfYn - 4-1.송장등록 연계 사방넷연계여부 수정 */
        UPDATE TI_INVOICE_REG_IF A
           SET A.SBN_IF_YN      = CASE WHEN #{resultContent} LIKE '%성공%' THEN 'Y' ELSE 'N' END
             , A.SBN_IF_MSG     = #{resultContent}
             , A.UPDR_NO        = #{updrNo}
             , A.UPD_DTTM       = sysdate
        WHERE
               A.IF_SNO         = (SELECT IF_SNO
                  FROM TI_INVOICE_REG_IF
                 WHERE NVL(RLS_INVOICE_NO, RETURN_INVOICE_NO) = #{srchKey}
                   AND IF_NO    = #{ifNo}
                   AND NVL(SBN_IF_YN,'N') = 'N'                 -- 'N' 사방넷연계 여부
               )
    </update>

    <!-- 5.클레임수집 요청 조회 -->
    <select id="selectClaimRequest" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.ClaimRequest">
        /* system.link.sabangnet.selectClaimRequest - 5.클레임수집 요청 조회 */
        SELECT  TC.SBN_ID                    AS sendCompaynyId,
                SBN_CERT_KEY                 AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD') AS sendDate,
                TS.SITE_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>

    <!-- 5-1.클레임수집 연계 테이블 중복 체크 -->
    <select id="selectClaimClctIfDupYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimResult">
        /* system.link.sabangnet.selectClaimClctIfDupYn - 5-1.클레임수집 연계 테이블 중복 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS DUP_YN
          FROM TI_CLAIM_CLCT_IF
         WHERE SITE_NO       = #{siteNo}
           AND SPMALL_ID     = #{mallId}            -- 쇼핑몰 ID
           AND SPMALL_ORD_NO = #{orderId}           -- 쇼핑몰 주문번호
           AND SBN_ORD_NO    = #{idx}               -- 사방넷 유니크 주문번호
           AND SBN_CLAIM_NO  = #{clIdx}             -- 사방넷 클레임 번호
           AND ORD_DLVR_STATUS = #{orderStatus}     -- 주문 배송 상태
    </select>

    <!-- 5-2.클레임수집 연계 테이블 등록 -->
    <insert id="insertClaimClctIf" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimResult">
        /* system.link.sabangnet.insertClaimClctIf - 5-2.클레임수집 연계 테이블 등록 */
        INSERT INTO TI_CLAIM_CLCT_IF (
               IF_SNO
             , IF_ID
             , IF_NO
             , SITE_NO
             , CLAIM_NO
             , CLAIM_DTL_SEQ
             , SBN_CLAIM_NO
             , ORD_NO
             , ORD_DTL_SEQ
             , SBN_ORD_NO
             , SPMALL_ORD_NO
             , SPMALL_ID
             , SPMALL_LOGIN_ID
             , ORD_DLVR_STATUS
             , ORDR_NM
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_EMAIL
             , ADRS_TEL
             , ADRS_MOBILE
             , DLVR_MSG
             , ADRS_NM
             , POST_NO
             , DTL_ADDR
             , SALE_AMT
             , PAYMENT_AMT
             , ORD_ACCEPT_DTTM
             , GOODS_NM
             , OPT_NM
             , SALE_PRICE
             , ORD_QTT
             , GOODS_NO
             , ITEM_NO
             , ATTR_VER
             , CLAIM_TYPE
             , CLAIM_MEMO
             , CLAIM_ACCEPT_DTTM
             , CLAIM_CLCT_DTTM
             , REGR_NO
             , REG_DTTM
        ) VALUES (
               #{ifSno}
             , #{ifId}
             , #{ifNo}
             , #{siteNo}
             , null
             , null
             , #{clIdx}
             , (SELECT ORD_NO FROM (SELECT ORD_NO      FROM TI_ORD_CLCT_IF WHERE SBN_ORD_NO = #{idx} AND ORD_NO IS NOT NULL ORDER BY IF_SNO DESC) WHERE ROWNUM = 1)
             , (SELECT ORD_DTL_SEQ FROM (SELECT ORD_DTL_SEQ FROM TI_ORD_CLCT_IF WHERE SBN_ORD_NO = #{idx} AND ORD_DTL_SEQ IS NOT NULL ORDER BY IF_SNO DESC) WHERE ROWNUM = 1)
             , #{idx}
             , #{orderId}
             , #{mallId}
             , #{mallUserId}
             , #{orderStatus}
             , #{userName}
             , #{userTel}
             , #{userCel}
             , #{userEmail}
             , #{receiveTel}
             , #{receiveCel}
             , #{delvMsg}
             , #{receiveName}
             , #{receiveZipcode}
             , #{receiveAddr}
             , #{totalCost}
             , #{payCost}
             , #{orderDate}
             , #{pProductName}
             , #{pSkuValue}
             , #{saleCost}
             , #{saleCnt}
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = SUBSTR(#{compaynyGoodsCd},1,16))
             , SUBSTR(#{compaynyGoodsCd},1,16)
             , (SELECT SUBSTR(#{compaynyGoodsCd},18,2) FROM DUAL)
             , #{clameStatusGubun}
             , #{clameContent}
             , #{clameInsDate}
             , #{clameRegDate}
             , #{regrNo}
             , sysdate
             )
    </insert>

    <!-- 5-3.클레임수집연계 - 쇼핑몰 주문번호별 클레임 조회 -->
    <select id="selectClaimClctIfList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfPO">
        /* system.link.sabangnet.selectClaimClctIfList - 5-3.클레임수집연계 - 쇼핑몰 주문번호별 클레임 조회 */
        SELECT A.SPMALL_ORD_NO
             , A.IF_SNO
             , A.IF_NO
             , A.SITE_NO
             , A.ORD_NO
             , A.CLAIM_TYPE
             , A.ORD_DLVR_STATUS                                                -- 사방넷 주문배송상태
             , A.REGR_NO
             , A.UPDR_NO
          FROM TI_CLAIM_CLCT_IF A
         WHERE A.SITE_NO  = #{siteNo}
           AND A.IF_NO    = #{ifNo}
                 AND A.ORD_DLVR_STATUS IN ('취소접수','반품접수','교환접수')
           AND (A.SPMALL_ORD_NO, A.SBN_ORD_NO) IN (SELECT B.SPMALL_ORD_NO, MIN(B.SBN_ORD_NO) SBN_ORD_NO
                                                  FROM TI_CLAIM_CLCT_IF B
                                                 WHERE B.SITE_NO  = #{siteNo}
                                                   AND B.IF_NO    = #{ifNo}
                                                   AND NVL(B.SBN_IF_YN,'N') = 'N'   -- 'N' 사방넷연계 여부
                                                 GROUP BY B.SPMALL_ORD_NO -- 쇼핑몰 주문번호별 클레임은 1건만 조회
                                                  )
           AND NVL(A.SBN_IF_YN,'N') = 'N'   -- 'N' 사방넷연계 여부
         ORDER BY A.SPMALL_ORD_NO, A.SBN_ORD_NO, A.CLAIM_NO
    </select>

    <!-- 5-5.클레임접수 처리 - 원본 주문번호 조회 -->
    <select id="selectClaimOrgOrdNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfPO">
        /* system.link.sabangnet.selectOrgOrdNo - 5-5.클레임접수 처리 - 원본 주문번호 조회 */
        SELECT SBN_ORG_ORD_NO    AS ORG_ORD_NO             -- 원본주문번호
          FROM TI_ORD_CLCT_IF                      -- 주문수집연계
         WHERE IF_SNO = (
                         SELECT MIN(D.IF_SNO)
                           FROM TI_CLAIM_CLCT_IF E  -- 클레임접수 연계
                              , TI_ORD_CLCT_IF C    --
                              , TI_ORD_CLCT_IF D    -- 최초 신규주문 수집자료
                          WHERE E.SITE_NO        = #{siteNo}
                            AND E.IF_SNO         = #{ifSno}
                            AND C.SITE_NO        = E.SITE_NO
                            AND C.SPMALL_ORD_NO  = E.SPMALL_ORD_NO   -- 쇼핑몰주문번호
                            AND C.SBN_ORD_NO     = E.SBN_ORD_NO      -- 사방넷유니크주문번호
                            AND D.SITE_NO        = C.SITE_NO         -- 사이트번호
                            AND D.SPMALL_ID      = C.SPMALL_ID       -- 쇼핑몰ID
                            AND D.SPMALL_ORD_NO  = C.SPMALL_ORD_NO   -- 쇼핑몰주문번호
                            AND D.SBN_ORD_NO     = C.SBN_ORG_ORD_NO  -- 사방넷주문번호 = 사방넷원본주문번호
                            AND D.ORD_NO IS NOT NULL
                            AND D.ORD_DLVR_STATUS IN ('신규주문')    -- 주문배송상태
                        )
    </select>

    <!-- 5-6.클레임접수 주문 번호 조회 -->
    <select id="selectClaimAcceptOrdNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfPO">
        /* system.link.sabangnet.selectClaimCmpltOrdNo - 5-6.클레임접수 주문 번호 조회 */
        SELECT A.ORD_NO
             , A.ORD_STATUS_CD  -- 주문상태코드
          FROM TO_ORD A
         WHERE A.ORD_NO = (SELECT ORD_NO FROM TI_ORD_CLCT_IF                      -- 주문수집연계
                              WHERE IF_SNO = (SELECT MIN(C.IF_SNO)
                                                FROM TI_CLAIM_CLCT_IF B               -- 현재 주문수집 클레임완료 자료
                                                   , TI_ORD_CLCT_IF C               -- 최초 신규주문 수집자료
                                               WHERE B.SITE_NO = #{siteNo}
                                                 AND B.IF_SNO = #{ifSno}
                                                 AND B.ORD_DLVR_STATUS IN ('취소접수','반품접수','교환접수')
                                                 AND C.SITE_NO        = B.SITE_NO         -- 사이트번호
                                                 AND C.SPMALL_ORD_NO  = B.SPMALL_ORD_NO   -- 쇼핑몰주문번호
                                                 AND C.SBN_ORD_NO     = B.SBN_ORD_NO      -- 사방넷유니크주문번호
                                                 AND C.ORD_NO        IS NOT NULL
                                                 AND C.ORD_DLVR_STATUS IN ('신규주문')      -- 주문배송상태
                                             )
                            )
    </select>

    <!-- 5-6.클레임수집연계 - 클레임수집연계 상세 조회 -->
    <select id="selectClaimClctIfDtlList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfDtlPO">
        /* system.link.sabangnet.selectClaimClctIfDtlList - 5-6.클레임수집연계 - 클레임수집연계 상세 조회 */
        SELECT A.IF_SNO                               -- 연계 일련번호(PK)
             , A.SPMALL_ORD_NO                        -- 쇼핑몰 주문 번호
             , A.SBN_ORD_NO                           -- 사방넷 주문 번호
             , A.ORD_NO                               -- 주문 번호
             , A.ORD_DTL_SEQ                          -- 주문 상세 순번
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END ITEM_NO         -- 단품번호
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,19) else SUBSTR(A.ITEM_NO,18) END   ATTR_VER        -- 속성VER
             , A.ORD_QTT                              -- 주문수량
             , A.CLAIM_TYPE
             , A.ORD_DLVR_STATUS                      -- 주문 배송 상태
             , (SELECT B.ORD_DTL_STATUS_CD
                  FROM TO_ORD_DTL B
                 WHERE B.ORD_NO      = A.ORD_NO
                   AND B.ORD_DTL_SEQ = A.ORD_DTL_SEQ
                   )                    LOCAL_ORD_DTL_STATUS_CD -- 로컬주문상세상태코드
          FROM TI_CLAIM_CLCT_IF A                               -- 클레임수집 연계
         WHERE A.IF_NO           = #{ifNo}
           AND A.SITE_NO         = #{siteNo}
           AND A.SPMALL_ORD_NO   = #{spmallOrdNo}               -- 쇼핑몰 주문 번호
           AND A.ORD_DLVR_STATUS IN ('취소접수','반품접수','교환접수')
           AND NVL(A.SBN_IF_YN,'N') = 'N'                    -- 'N' 사방넷연계 여부
         ORDER BY A.IF_SNO
    </select>

    <!-- 5-7.클레임 상세 처리 - 클레임번호 채번 -->
    <select id="selectClaimNo" resultType="String">
        /* system.link.sabangnet.selectClaimNo - 5-7.클레임 상세 처리 - 클레임번호 채번 */
        SELECT NVL((SELECT MAX(CLAIM_NO) + 1
                         FROM TO_ORD_DTL), 1)    AS CLAIM_NO
          FROM DUAL
    </select>

    <!-- 5-8.클레임 상세 처리 -->
    <update id="procClaimDtl" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfDtlPO">
        {CALL
		DECLARE
		BEGIN
		INSERT INTO TO_CLAIM
        (
         CLAIM_NO
        ,ORD_NO
        ,ORD_DTL_SEQ
        ,RETURN_CD
        ,CLAIM_QTT
        ,CLAIM_CD
        ,CLAIM_ACCEPT_DTTM
        ,CLAIM_REASON_CD
        ,CLAIM_DTL_REASON
        ,REGR_NO
		,REG_DTTM
        )
        VALUES
        (
         #{claimNo}
        ,(SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
        ,(SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
        , CASE WHEN #{ordDlvrStatus} = '반품접수' THEN '11' ELSE '12' END  /* 반품코드 - 11:반품신청*/
        ,(SELECT ORD_QTT FROM TO_ORD_DTL WHERE ORD_NO = (SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno}) AND ORD_DTL_SEQ =(SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno}))
        ,CASE WHEN #{ordDlvrStatus} = '취소접수' THEN '31'  -- 결제취소신청
                                          WHEN #{ordDlvrStatus} = '반품접수' THEN '11'  -- 환불신청
                                          WHEN #{ordDlvrStatus} = '교환접수' THEN '21'  -- 교환신청
                                      END
        ,sysdate
        ,'90'
        ,'사방넷 연계 주문 ' || (SELECT CLAIM_TYPE FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
        ,#{regrNo}
        ,sysdate
        );

        /* system.link.sabangnet.procClaimDtl - 5-8-1.클레임 상세 처리 - 주문 상세 테이블 상태 수정 */
        UPDATE TO_ORD_DTL   A                   -- 주문상세
           SET A.CLAIM_NO          = #{claimNo}
               -- 주문 상세 상태 코드
             , A.ORD_DTL_STATUS_CD = CASE WHEN #{ordDlvrStatus} = '취소접수' THEN '23'  -- 결제취소신청
                                          WHEN #{ordDlvrStatus} = '반품접수' THEN '70'  -- 반품신청
                                          WHEN #{ordDlvrStatus} = '교환접수' THEN '60'  -- 교환신청
                                      END
               -- 반품 코드 11:반품신청, 12:반품완료
             , A.RETURN_CD         = CASE WHEN #{ordDlvrStatus} = '반품접수' THEN '11' ELSE '12'  -- 반품코드 - 11:반품신청
                                      END
               -- 클레임 코드
             , A.CLAIM_CD          = CASE WHEN #{ordDlvrStatus} = '취소접수' THEN '31'  -- 결제취소신청
                                          WHEN #{ordDlvrStatus} = '반품접수' THEN '11'  -- 환불신청
                                          WHEN #{ordDlvrStatus} = '교환접수' THEN '21'  -- 교환신청
                                      END
             , CLAIM_QTT =(SELECT ORD_QTT FROM TO_ORD_DTL WHERE ORD_NO = (SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno}) AND ORD_DTL_SEQ =(SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno}))
             , A.CLAIM_ACCEPT_DTTM = (SELECT TO_DATE(CLAIM_ACCEPT_DTTM,'YYYYMMDDHH24MISS')  FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                    -- 클레임 접수 일시
             , A.CLAIM_REASON_CD   = '90'                                   -- 클레임 사유코드 90:기타
             , A.CLAIM_DTL_REASON  = '사방넷 연계 주문 ' || (SELECT CLAIM_TYPE FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})   -- 클레임 상세 사유
             , A.CLAIM_MEMO        = (SELECT CLAIM_MEMO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                           -- 클레임 메모
             , A.UPDR_NO           = #{updrNo}
             , A.UPD_DTTM          = sysdate
         WHERE A.ORD_NO            = (SELECT ORD_NO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
           AND A.ORD_DTL_SEQ       = (SELECT ORD_DTL_SEQ FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno});


        /* system.link.sabangnet.procClaimDtl - 5-8-2.클레임 상세 처리 - 클레임 수집 연계 테이블 업데이트 */
        UPDATE TI_CLAIM_CLCT_IF                 -- 클레임 수집 연계
           SET CLAIM_NO      = #{claimNo}       -- 클레임 번호
             , BTCH_PRC_YN   = 'Y'              -- 배치 처리 여부
             , SBN_IF_YN     = 'Y'              -- 사방넷 연계 여부
             , SBN_IF_MSG    = #{resultContent} -- 사방넷 연계 메시지
             , UPDR_NO       = #{updrNo}        -- 수정자 번호
             , UPD_DTTM      = sysdate            -- 수정 일시
         WHERE IF_SNO = #{ifSno}
           AND ORD_DLVR_STATUS = #{ordDlvrStatus};

           END
           }

    </update>

    <!-- 5-9.클레임접수 NoOrd 주문 처리 -->
    <update id="procClaimAcceptNoOrd" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfPO">
         { CALL
   		DECLARE
   		BEGIN
        /* system.link.sabangnet.procClaimForNoOrd - 5-9-1.클레임접수 NoOrd 주문 처리 - 주문 테이블 등록 */
        INSERT INTO TO_ORD (
               ORD_NO
             , SITE_NO
             , ORG_ORD_NO
             , ORD_STATUS_CD
             , ORD_MEDIA_CD
             , SALE_CHANNEL_CD
             , MEMBER_ORD_YN
             , MEMBER_NO
             , LOGIN_ID
             , MEMBER_GRADE_NO
             , ORD_SECT_NO
             , ORDR_NM
             , ORDR_EMAIL
             , ORDR_TEL
             , ORDR_MOBILE
             , ORDR_IP
             , ORD_ACCEPT_DTTM
             , ORD_CMPLT_DTTM
             , ORD_CANCEL_DTTM
             , PAYMENT_CMPLT_DTTM
             , SMS_RECV_YN
             , EMAIL_RECV_YN
             , PVD_SVMN
             , MANUAL_ORD_YN
             , PAYMENT_AMT
             , SALE_AMT
             , DC_AMT
             , REGR_NO
             , REG_DTTM
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{siteNo}                      -- 사이트 번호
             , #{orgOrdNo}                    -- 원본 주문번호
             , '20'  -- 주문상태 20:결제완료
             , '01'                           -- 주문매체 코드 PC
             , (SELECT B.CD
                  FROM TA_CMN_CD_DTL B
                 WHERE B.GRP_CD = 'SALE_CHANNEL_CD'
                   AND B.CD_NM  = A.SPMALL_ID)  -- 판매채널 코드
             , 'N'                            -- 회원주문 여부
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID = A.SPMALL_LOGIN_ID)                                             -- 회원 번호
             , A.SPMALL_LOGIN_ID              -- 쇼핑몰 로그인 아이디
             , (SELECT MEMBER_GRADE_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_GRADE_NO                          -- 회원등급 번호
             , null                           -- 주문 비밀번호
             , A.ORDR_NM                      -- 주문자 명
             , A.ORDR_EMAIL                   -- 주문자 이메일
             , A.ORDR_TEL                     -- 주문자 전화
             , A.ORDR_MOBILE                  -- 주문자 휴대폰
             , null                           -- 주문자 IP
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_ACCEPT_DTTM    -- 주문접수 일시
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS')                    -- 주문 완료 일시
             , TO_DATE(A.CLAIM_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS') ORD_CANCEL_DTTM  -- 주문취소 일시
             , TO_DATE(A.ORD_ACCEPT_DTTM, 'YYYYMMDDHH24:MI:SS')                    -- 결제 완료 일시
             , null                           -- SMS 수신 여부
             , null                           -- 이메일 수신 여부
             , null                           -- 지급 마켓포인트
             , 'N'                            -- 수기주문 여부
             , #{paymentAmt}                  -- 결제 금액
             , A.SALE_AMT                     -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
          FROM TI_CLAIM_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimForNoOrd - 5-9-2.클레임접수 NoOrd 주문 처리 - 주문 배송지 테이블 등록 */
        INSERT INTO TO_ORD_DELIVERY (
               ORD_NO                         -- 주문 번호
             , MEMBER_NO                      -- 회원 번호
             , AREA_DLVR_SET_NO               -- 지역 배송 설정 번호
             , SITE_NO                        -- 사이트 번호
             , DELIVERY_NM                    -- 배송지 명
             , ADRS_NM                        -- 수취인 명
             , ADRS_TEL                       -- 수취인 전화
             , ADRS_MOBILE                    -- 수취인 휴대폰
             , POST_NO                        -- 신 우편 번호
             , ROADNM_ADDR                    -- 도로명 주소
             , NUM_ADDR                       -- 지번 주소
             , DTL_ADDR                       -- 도로명 상세 주소
             , DLVR_MSG                       -- 배송 메세지
             , MEMBER_GB_CD                   -- 회원 구분 코드
             , FRG_ADDR_COUNTRY               -- 해외 주소 COUNTRY
             , FRG_ADDR_CITY                  -- 해외 주소 CITY
             , FRG_ADDR_STATE                 -- 해외 주소 STATE
             , FRG_ADDR_ZIP_CODE              -- 해외 주소 우편번호
             , FRG_ADDR_DTL1                  -- 해외 주소 상세1
             , FRG_ADDR_DTL2                  -- 해외 주소 상세2
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 회원 번호
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             , #{siteNo}                      -- 사이트 번호
             , null                           -- 배송지 명
             , A.ADRS_NM                      -- 수취인 명
             , A.ADRS_TEL                     -- 수취인 전화
             , A.ADRS_MOBILE                  -- 수취인 휴대폰
             , A.POST_NO                      -- 신 우편 번호
             , null                           -- 도로명 주소
             , null                           -- 지번 주소
             , A.DTL_ADDR                     -- 도로명 상세 주소
             , A.DLVR_MSG                     -- 배송 메세지
             , null                           -- 회원 구분 코드
             , null                           -- 해외 주소 COUNTRY
             , null                           -- 해외 주소 CITY
             , null                           -- 해외 주소 STATE
             , null                           -- 해외 주소 우편번호
             , null                           -- 해외 주소 상세1
             , null                           -- 해외 주소 상세2
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_CLAIM_CLCT_IF A
         WHERE 1=1
           AND A.DTL_ADDR IS NOT NULL
           AND A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimForNoOrd - 5-9-3.클레임접수 NoOrd 주문 처리 - 결제 테이블 배포 등록 */
        INSERT INTO TO_PAYMENT (
               PAYMENT_NO                     -- 결제 번호
             , SITE_NO                        -- 사이트 번호
             , ORD_NO                         -- 주문 번호
             , PAYMENT_TURN                   -- 결제 차수
             , PAYMENT_PG_CD                  -- 결제 PG 코드
             , PAYMENT_WAY_CD                 -- 결제 수단 코드
             , PAYMENT_STATUS_CD              -- 결제 상태 코드
             , PAYMENT_CMPLT_DTTM             -- 결제 완료 일시
             , PAYMENT_AMT                    -- 결제 금액
             , MEMBER_NO                      -- 회원 번호
             , TX_NO                          -- 거래 번호
             , CONFIRM_NO                     -- 승인 번호
             , CONFIRM_DTTM                   -- 승인 일시
             , CONFIRM_RESULT_CD              -- 승인 결과 코드
             , CONFIRM_RESULT_MSG             -- 승인 결과 메세지
             , CARD_CD                        -- 카드사 코드
             , INSTMNT_MONTH                  -- 할부개월
             , BANK_CD                        -- 은행 코드
             , ACT_NO                         -- 계좌 번호
             , HOLDER_NM                      -- 예금주 명
             , DPSTER_NM                      -- 입금자 명
             , DPST_SCD_DT                    -- 입금 예정 일자
             , DPST_SCD_AMT                   -- 입금 예정 금액
             , DPST_CHECK_MSG                 -- 입금 확인 메세지
             , ESCROW_YN                      -- 에스크로 여부
             , ESCROW_CONFIRMNO               -- 에스크로 승인번호(올더게이트)
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0,'TO_PAYMENT_NO') FROM DUAL) PAYMENT_NO -- 결제 번호
             , #{siteNo}                      -- 사이트 번호
             , #{ordNo}                       -- 주문 번호
             , 1                              -- 결제 차수
             , '00'                           -- 결제 PG 코드
             , '51'                           -- 결제 수단 코드 51:사방넷
             , '02'                           -- 결제 상태 코드 02:완료, 01:접수, 03:취소
             , TO_DATE(A.ORD_ACCEPT_DTTM , 'YYYYMMDDHH24:MI:SS')   -- 결제 완료 일시
             , A.PAYMENT_AMT                  -- 결제 금액
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID=A.SPMALL_LOGIN_ID) AS MEMBER_NO                           -- 회원 번호
             , null                           -- 거래 번호
             , null                           -- 승인 번호
             , null                           -- 승인 일시
             , null                           -- 승인 결과 코드
             , null                           -- 승인 결과 메세지
             , null                           -- 카드사 코드
             , null                           -- 할부개월
             , null                           -- 은행 코드
             , null                           -- 계좌 번호
             , null                           -- 예금주 명
             , null                           -- 입금자 명
             , null                           -- 입금 예정 일자
             , null                           -- 입금 예정 금액
             , null                           -- 입금 확인 메세지
             , null                           -- 에스크로 여부
             , null                           -- 에스크로 승인번호(올더게이트)
             , #{regrNo}                      -- 등록자 번호
             , sysdate                          -- 등록 일시
          FROM TI_CLAIM_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimForNoOrd - 5-9-4.클레임접수 NoOrd 주문 처리 - 주문번호를 주문수집연계 테이블에 업데이트 */
        UPDATE TI_CLAIM_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
         WHERE A.IF_SNO        = #{ifSno};

          END
        }
    </update>

    <!-- 5-10.클레임접수 NoOrd 주문 상세 처리 -->
    <update id="procClaimAcceptNoOrdDtl" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.OrdClctIfDtlPO">
        { CALL
   		DECLARE
   		BEGIN
        /* system.link.sabangnet.procClaimForNoOrdDtl - 5-10-1.클레임접수 NoOrd 주문 상세 처리 - 주문 상세 테이블 등록 */
        INSERT INTO TO_ORD_DTL (
               ORD_NO                         -- 주문 번호
             , ORD_DTL_SEQ                    -- 주문 상세 순번
             , ORD_DTL_STATUS_CD              -- 주문 상세 상태 코드
             , GOODS_NO                       -- 상품 번호
             , ITEM_NO                        -- 단품 번호
             , GOODS_NM                       -- 상품 명
             , ITEM_NM                        -- 단품 명
             , ORD_QTT                        -- 주문 수량
             , CUSTOMER_AMT                   -- 소비자 금액
             , SUPPLY_AMT                   -- 공급 금액
             , SALE_AMT                       -- 판매 금액
             , DC_AMT                         -- 할인 금액
             , GOODS_READY_DTTM               -- 상품 준비 일시
             , RLS_CMD_DTTM                   -- 출고 지시 일시
             , RLS_CMPLT_DTTM                 -- 출고 완료 일시
             , DLVR_CMPLT_DTTM                -- 배송 완료 일시
             , GOODS_ESTM_REG_YN              -- 상품 평가 등록 여부
             , DLVR_WISH_DT                   -- 배송 희망 일자
             , ADD_OPT_YN                     -- 추가 옵션 여부
             , ADD_OPT_NO                     -- 추가 옵션 번호
             , ADD_OPT_NM                     -- 옵션명
             , ADD_OPT_DTL_SEQ                -- 추가 옵션 상세 순번
             , PVD_SVMN                       -- 지급 적립금
             , RECOM_PVD_SVMN                 -- 추천인 지급 적립금
             , REGR_NO                        -- 등록자 번호
             , REG_DTTM                       -- 등록 일시
             , CLAIM_NO
             , RETURN_CD
             , CLAIM_CD
             , CLAIM_QTT
             , CLAIM_ACCEPT_DTTM
             , CLAIM_REASON_CD
             , CLAIM_DTL_REASON
             , CLAIM_MEMO
        )
        SELECT
               #{ordNo}                       -- 주문 번호
             , #{ordDtlSeq}                   -- 주문 상세 순번
             ,(SELECT CD FROM TA_CMN_CD_DTL WHERE GRP_CD ='ORD_DTL_STATUS_CD'
                AND CD_NM = DECODE(A.ORD_DLVR_STATUS,'신규주문','결제완료','주문확인','결제완료','출고대기','배송준비중','출고완료','배송중','취소접수','결제취소신청','교환접수','교환신청','반품접수','반품신청','취소완료','결제취소','교환완료','교환완료','반품완료','반품완료','')
                ) AS ORD_DTL_STATUS_CD -- 주문상세상태코드 23:취소신청 60:교환신청 70:환불신청
             , (SELECT GOODS_NO FROM TG_ITEM WHERE ITEM_NO = case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END) AS GOODS_NO -- 상품 번호
             , case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END AS ITEM_NO    -- 단품 번호
             , A.GOODS_NM                     -- 상품 명
             , A.OPT_NM                       -- 옵션 명
             , A.ORD_QTT                      -- 주문 수량
             , (SELECT CUSTOMER_PRICE FROM TG_ITEM WHERE ITEM_NO =case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END)                           -- 소비자 금액
             , (SELECT SUPPLY_PRICE FROM TG_ITEM WHERE ITEM_NO =case when length(a.item_no) > 18 then SUBSTR(A.ITEM_NO,1,17) else SUBSTR(A.ITEM_NO,1,16) END)                           -- 공급 금액
             , A.PAYMENT_AMT                  -- 판매 금액
             , A.SALE_AMT - A.PAYMENT_AMT     -- 할인 금액
             , null                           -- 상품 준비 일시
             , null                           -- 출고 지시 일시
             , null                           -- 출고 완료 일시
             , null                           -- 배송 완료 일시
             , null                           -- 상품 평가 등록 여부
             , null              -- 배송 희망 일자
             , 'N'                            -- 추가 옵션 여부
             , '0'                           -- 추가 옵션 번호
             , null                           -- 옵션명
             , '0'                           -- 추가 옵션 상세 순번
             , 0                             -- 지급 적립금
             , 0                            -- 추천인 지급 적립금
             , #{regrNo}                      -- 등록자번호
             , sysdate                          -- 등록 일시
            , #{claimNo}
            , CASE WHEN #{ordDlvrStatus} = '반품접수' THEN '11' ELSE '12' END -- 반품코드 - 11:반품신청
            , CASE WHEN #{ordDlvrStatus} = '취소접수' THEN '31'  -- 결제취소신청
                     WHEN #{ordDlvrStatus} = '반품접수' THEN '11'  -- 환불신청
                     WHEN #{ordDlvrStatus} = '교환접수' THEN '21'  -- 교환신청
                 END
            , (SELECT ORD_QTT FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
            , (SELECT TO_DATE(CLAIM_ACCEPT_DTTM,'YYYYMMDDHH24MISS')  FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                    -- 클레임 접수 일시
            , '90'                                   -- 클레임 사유코드 90:기타
            , '사방넷 연계 주문 ' || (SELECT CLAIM_TYPE FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})   -- 클레임 상세 사유
            , (SELECT CLAIM_MEMO FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})                           -- 클레임 메모
          FROM TI_CLAIM_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procClaimForNoOrdDtl - 5-5-3.클레임접수 NoOrd 주문 상세 처리 - 배송 테이블 배포 등록 */
        INSERT INTO TO_DLVR (
               DLVR_NO                            -- 배송 번호
             , SITE_NO                            -- 사이트 번호
             , ORD_NO                             -- 주문 번호
             , ORD_DTL_SEQ                        -- 주문 상세 순번
             , DLVR_PRC_TYPE_CD                   -- 배송 처리 유형 코드
             , DLVRC_PAYMENT_CD                   -- 배송비 결제 코드
             , DLVR_SET_CD                        -- 배송 설정 코드
             , RLS_COURIER_CD                     -- 출고 택배사 코드
             , RLS_INVOICE_NO                     -- 출고 송장 번호
             , RLS_INVOICE_REG_DTTM               -- 출고 송장 등록 일시
             , RLS_CMPLT_REG_DTTM                 -- 출고 완료 등록 일시
             , DLVR_QTT                           -- 배송 수량
             , DLVR_MSG                           -- 배송 메세지
             , ORG_DLVR_AMT                       -- 원본 배송 금액
             , REAL_DLVR_AMT                      -- 실 배송 금액
             , AREA_ADD_DLVRC                     -- 지역 추가 배송비
             , REGR_NO                            -- 등록자 번호
             , REG_DTTM                           -- 등록 일시
        )
        SELECT (SELECT fn_getSeq(0, 'TO_DLVR_NO') FROM DUAL) DLVR_NO -- 배송 번호
             , #{siteNo}                          -- 사이트 번호
             , #{ordNo}                           -- 주문 번호
             , #{ordDtlSeq}                       -- 주문 상세 순번
             , null                               -- 배송 처리 유형 코드
             , null AS DLVRC_PAYMENT_CD -- 배송비 결제 코드
             , (SELECT DLVR_SET_CD FROM TG_GOODS WHERE GOODS_NO = A.GOODS_NO) DLVR_SET_CD -- 배송 설정 코드
             , null                                -- 출고 택배사 코드
             , null                                -- 출고 송장 번호
             , null                                -- 출고 송장 등록 일시
             , null                                -- 출고 완료 등록 일시
             , A.ORD_QTT                           -- 배송 수량
             , A.DLVR_MSG                          -- 배송 메시지
             , null                                -- 원본 배송 금액
             , null -- A.REAL_DLVR_AMT                     -- 실 배송 금액
             , null                                -- 지역 추가 배송비
             , #{regrNo}                           -- 등록자 번호
             , sysdate                               -- 등록 일시
          FROM TI_CLAIM_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};

         INSERT INTO TO_CLAIM
        (
         CLAIM_NO
        ,ORD_NO
        ,ORD_DTL_SEQ
        ,RETURN_CD
        ,CLAIM_QTT
        ,CLAIM_CD
        ,CLAIM_ACCEPT_DTTM
        ,CLAIM_REASON_CD
        ,CLAIM_DTL_REASON
        ,REGR_NO
		,REG_DTTM
        )
        VALUES
        (
          #{claimNo}
        , #{ordNo}
        , #{ordDtlSeq}
        , CASE WHEN #{ordDlvrStatus} = '반품접수' THEN '11' ELSE '12' END  /* 반품코드 - 11:반품신청*/
        , (SELECT ORD_QTT FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
        , CASE WHEN #{ordDlvrStatus} = '취소접수' THEN '31'  -- 결제취소신청
                                          WHEN #{ordDlvrStatus} = '반품접수' THEN '11'  -- 환불신청
                                          WHEN #{ordDlvrStatus} = '교환접수' THEN '21'  -- 교환신청
                                      END
        ,sysdate
        ,'90'
        ,'사방넷 연계 주문 ' || (SELECT CLAIM_TYPE FROM TI_CLAIM_CLCT_IF WHERE IF_SNO = #{ifSno})
        ,#{regrNo}
        ,sysdate
        );


        /* system.link.sabangnet.procClaimForNoOrdDtl 5-5-5.클레임접수 NoOrd 주문 상세 처리 - 주문 수집 연계 테이블 업데이트 */
        UPDATE TI_CLAIM_CLCT_IF A
           SET A.ORD_NO        = #{ordNo}            -- 주문 번호
             , A.ORD_DTL_SEQ   = #{ordDtlSeq}        -- 주문 상세 순번
             , A.CLAIM_NO        = #{claimNo}        -- 클레임 번호
             , A.CLAIM_DTL_SEQ   = #{ordDtlSeq}      -- 클레임 상세 순번
             , A.BTCH_PRC_YN   = 'Y'                 -- 배치 처리 여부
             , A.SBN_IF_YN     = 'Y'                 -- 사방넷 연계 여부
             , A.SBN_IF_MSG    = #{resultContent}    -- 사방넷 연계 메시지
             , A.UPDR_NO       = #{updrNo}           -- 수정자 번호
             , A.UPD_DTTM      =  sysdate            -- 수정 일시
         WHERE A.IF_SNO        = #{ifSno};

         END
        }
    </update>

    <!-- 5-5-6.클레임접수 NoOrd 처리 - 결제금액 주문, 결제 테이블 업데이트-->
    <update id="procClaimNoOrdPaymentUpdate" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.ClaimClctIfPO">
    { CALL
   		DECLARE
   		BEGIN
        /* system.link.sabangnet.procClaimNoOrdPaymentUpdate 5-5-6.클레임접수 NoOrd 처리 - 결제금액 주문테이블 업데이트 */
        UPDATE TO_ORD A
           SET A.PAYMENT_AMT = (SELECT NVL(SUM(B.SALE_AMT*B.ORD_QTT-NVL(B.DC_AMT,0)),0) PAYMENT_AMT
                                    FROM TO_ORD_DTL B WHERE ORD_NO = #{ordNo})        -- 결제금액
             , A.SALE_AMT    =(SELECT NVL(SUM(B.SALE_AMT*B.ORD_QTT),0) SALE_AMT
                                    FROM TO_ORD_DTL B WHERE ORD_NO = #{ordNo})         -- 판매금액
             , A.DC_AMT      = (SELECT NVL(SUM(B.DC_AMT),0) DC_AMT
                                  FROM TO_ORD_DTL B WHERE ORD_NO = #{ordNo})           -- 할인금액
         WHERE A.ORD_NO = #{ordNo}
           ;


        /* system.link.sabangnet.procClaimNoOrdPaymentUpdate 5-5-6.클레임접수 NoOrd 주문 처리 - 결제금액 결제테이블 업데이트 */
        UPDATE TO_PAYMENT A
           SET A.PAYMENT_AMT    = (SELECT NVL(SUM(B.SALE_AMT*B.ORD_QTT-NVL(B.DC_AMT,0)),0) PAYMENT_AMT
                                      FROM TO_ORD_DTL B
                                     WHERE ORD_NO = #{ordNo})      -- 결제금액
         WHERE A.ORD_NO         = #{ordNo}
           AND A.PAYMENT_WAY_CD = 51
           AND A.PAYMENT_TURN   = 1
           AND A.ORD_NO = (SELECT B.ORD_NO
                  FROM TO_ORD_DTL B
                 WHERE ORD_NO = #{ordNo}
               );
          END
        }
    </update>

    <!-- 5-5-2.클레임수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 -->
    <delete id="deleteClaimClctIfPastData">
        /* system.link.sabangnet.deleteClaimClctIfPastData - 5-5-2.클레임수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 */
        DELETE FROM TI_CLAIM_CLCT_IF
         WHERE SITE_NO = #{siteNo}
           AND IF_SNO IN (
                      SELECT IF_SNO
                        FROM (
                              SELECT IF_SNO
                                FROM TI_CLAIM_CLCT_IF A
                               WHERE A.SITE_NO = #{siteNo}
                                 AND IF_SNO NOT IN ( -- 최종 IF_SNO (사방넷주문번호,클레임번호,클레임상세순번 별 최종)는 제외
                                            SELECT MAX(B.IF_SNO) FROM TI_CLAIM_CLCT_IF B
                                             WHERE B.SITE_NO = #{siteNo}
                                             GROUP BY B.SPMALL_ORD_NO, B.SBN_ORD_NO, B.SBN_CLAIM_NO, B.ORD_DLVR_STATUS
                                                    , B.CLAIM_TYPE, B.CLAIM_ACCEPT_DTTM, B.ORD_NO, B.ORD_DTL_SEQ
                                                    , B.CLAIM_NO, B.SBN_IF_YN
                                                   )
                             ) C
                      )
    </delete>

    <!-- 6.문의사항수집 요청 조회 -->
    <select id="selectInquiryRequest" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.InquiryRequest">
        /* system.link.sabangnet.selectInquiryRequest - 6.문의사항수집 요청 조회 */
        SELECT  TC.SBN_ID                    AS sendCompaynyId,
                SBN_CERT_KEY                 AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD') AS sendDate,
                TS.SITE_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>

    <!-- 6.문의사항수집 연계 테이블 중복 체크 -->
    <select id="selectInquiryClctIfDupYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.CsResult">
        /* system.link.sabangnet.selectInquiryClctIfDupYn - 6.문의사항수집 연계 테이블 중복 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS DUP_YN
          FROM TI_INQUIRY_CLCT_IF
         WHERE SITE_NO       = #{siteNo}
           AND SPMALL_ID     = #{mallId}            -- 쇼핑몰 ID
           AND SBN_SNO       = #{num}               -- 사방넷 유니크 일련번호
           AND PRC_GB        = #{csStatus}          -- 처리구분 001:신규접수 002:답변저장 003:답변전송 004:강제완료
    </select>

    <!-- 6.문의사항수집 연계 테이블 등록 -->
    <insert id="insertInquiryClctIf" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.CsResult">
        /* system.link.sabangnet.insertInquiryClctIf - 6.문의사항수집 연계 테이블 등록 */
        INSERT INTO TI_INQUIRY_CLCT_IF (
               IF_SNO
             , IF_ID
             , IF_NO
             , SITE_NO
             , SBN_SNO
             , SPMALL_ID
             , SPMALL_LOGIN_ID
             , PRC_GB
             , LETT_NO
             , GRP_NO
             , BBS_ID
             , CLCT_DT
             , SPMALL_ORD_NO
             , GOODS_NO
             , ITEM_NO
             , GOODS_NM
             , TITLE
             , CONTENT
             , WRTR
             , CUST_REG_DT
             , REPLY_CONTENT
             , RPLR
             , REPLY_REG_DTTM
             , REPLY_SEND_DTTM
             , INQUIRY_GB
             , REGR_NO
             , REG_DTTM
        ) VALUES (
               #{ifSno}
             , #{ifId}
             , #{ifNo}
             , #{siteNo}
             , #{num}
             , #{mallId}
             , #{mallUserId}
             , #{csStatus}
             , null
             , null
             , null
             , #{regDm}
             , #{orderId}
             , #{productId}
             , #{mallProdId}
             , #{productNm}
             , #{subject}
             , #{cnts:CLOB}
             , #{insNm}
             , #{insDm}
             , #{rplyCnts:CLOB}
             , #{updNm}
             , #{updDm}
             , #{sendDm}
             , #{csGubun}
             , #{regrNo}
             , sysdate
             )
    </insert>

    <!-- 6-1.문의사항 처리 - 문의사항수집연계 조회 -->
    <select id="selectInquiryClctIfList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.InquiryClctIfPO">
        /* system.link.sabangnet.selectInquiryClctIfList - 6-1.문의사항수집연계 - 문의사항수집연계 조회 */
        SELECT A.IF_SNO                               -- 연계 일련번호(PK)
              ,A.PRC_GB
              ,A.SITE_NO
              ,A.SPMALL_LOGIN_ID
          FROM TI_INQUIRY_CLCT_IF A                   -- 문의사항수집 연계
         WHERE A.IF_NO         = #{ifNo}              -- 연계 번호
           AND A.SITE_NO       = #{siteNo}            -- 사이트 번호
           AND NVL(A.SBN_IF_YN,'N') = 'N'          -- 'N' 사방넷연계 여부
    </select>

    <!-- 6-2.문의사항 상품게시판글 테이블 존재여부 체크 -->
    <select id="selectGoodsBbsExistYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.InquiryClctIfPO">
        /* system.link.sabangnet.selectGoodsBbsExistYn - 6-2.문의사항 상품게시판글 테이블 존재여부 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS EXIST_YN
          FROM TB_GOODS_BBS_LETT
         WHERE SITE_NO      = #{siteNo}
           AND LETT_NO      = (
           SELECT LETT_NO
          FROM TI_INQUIRY_CLCT_IF
         WHERE IF_SNO = (
                         SELECT MIN(E.IF_SNO)
                           FROM TI_INQUIRY_CLCT_IF D
                              , TI_INQUIRY_CLCT_IF E
                          WHERE D.SITE_NO        = 1
                            AND D.IF_SNO         = #{ifSno}
                            AND E.SITE_NO        = D.SITE_NO
                            AND E.SPMALL_ID      = D.SPMALL_ID        -- 쇼핑몰ID
                            AND E.SPMALL_LOGIN_ID = D.SPMALL_LOGIN_ID -- 쇼핑몰로그인ID
                            AND E.ITEM_NO         = D.ITEM_NO         -- 단품번호
                            AND E.SBN_SNO = D.SBN_SNO
                               )
                        )
    </select>

    <!-- 6-3.문의사항 처리 - 글번호 채번 -->
    <select id="selectLettNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.common.model.IfLogVO">
        /* system.link.sabangnet.selectLettNo - 6-3.문의사항 처리 - 글번호 채번 */
        SELECT fn_getSeq(0, 'TB_GOODS_BBS_LETT_NO')  LETT_NO
          FROM DUAL
    </select>

    <!-- 6-4.문의사항 처리 -->
    <update id="procInquiry" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.InquiryClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procInquiry - 6-4-1.문의사항 처리 - 상품게시판글 등록 */
        INSERT INTO TB_GOODS_BBS_LETT (
               LETT_NO                 -- 글 번호
             , GRP_NO                  -- 그룹 번호
             , BBS_ID                  -- 게시판 아이디
             , SITE_NO                 -- 사이트 번호
             , TITLE_NO                -- 타이틀 번호
             , TITLE                   -- 제목
             , CONTENT                 -- 내용
             , INQ_CNT                 -- 조회수
             , SCORE                   -- 점수
             , CTG_NO                  -- 카테고리 번호
             , SECT_YN                 -- 비밀 여부
             , OPEN_YN                 -- 공개 여부
             , REPLY_STATUS_YN         -- 답변 상태 여부
             , GOODS_NO                -- 상품 번호
             , BUY_YN                  -- 구매 여부
             , LETT_LVL                -- 글 레벨
             , PW                      -- 비밀번호
             , FILE_NO                 -- 파일 번호
             , BLIND_USE_YN            -- 블라인드 사용 여부
             , EXPS_YN                 -- 노출 여부
             , SMS_SEND_YN             -- SMS 발송 여부
             , EMAIL_SEND_YN           -- 이메일 발송 여부
             , REG_NM                  -- 등록 명
             , REG_DTTM                -- 등록 일시
             , REGR_NO                 -- 등록자 번호
             , UPD_DTTM                -- 수정 일시
             , UPDR_NO                 -- 수정자 번호
             , DEL_YN                  -- 삭제 여부
             , DELR_NO                 -- 삭제자 번호
             , DEL_DTTM                -- 삭제 일시
             , MEMBER_NO               -- 회원 번호
        )
        SELECT
               #{lettNo}                                       -- 글번호
             , null                                            -- 그룹번호
             , 'question'                                      -- 게시판 아이디
             , #{siteNo}                                       -- 사이트 번호
             , null                                            -- 타이틀 번호
             , A.TITLE                                         -- 제목
             , A.CONTENT                                       -- 내용
             , null                                            -- 조회수
             , null                                            -- 점수
             , fn_getGoodsCtgNoNm(#{siteNo}, A.GOODS_NO, 'CTG_NO') -- 카테고리 번호
             , 'N'                                             -- 비밀 여부
             , 'Y'                                             -- 공개 여부
             , null                                            -- 답변 상태 여부
             , ITEM_NO                                        -- 상품 번호
             , null                                            -- 구매 여부
             , null                                            -- 글 레벨
             , null                                            -- 비밀번호
             , null                                            -- 파일 번호
             , 'N'                                             -- 블라인드
             , 'Y'                                            -- 노출 여부
             , null                                            -- SMS 발송 여부
             , null                                            -- 이메일 발송 여부
             , A.WRTR                                          -- 등록 명
             , sysdate                                           -- 등록 일시
             , #{regrNo}                                       -- 등록자 번호
             , null                                            -- 수정 일시
             , null                                            -- 수정자 번호
             , 'N'                                             -- 삭제 여부
             , null                                            -- 삭제자 번호
             , null                                            -- 삭제 일시
             , (SELECT MEMBER_NO FROM TC_MEMBER WHERE LOGIN_ID = #{spmallLoginId})                                             -- 회원 번호
          FROM TI_INQUIRY_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno};


        /* system.link.sabangnet.procInquiry - 6-4-2.문의사항 처리 - 문의사항수집연계 테이블 업데이트 */
        UPDATE TI_INQUIRY_CLCT_IF               -- 문의사항 수집 연계
           SET LETT_NO       = #{lettNo}        -- 글 번호
             , GRP_NO        = null       -- 그룹 번호
             , BTCH_PRC_YN   = 'Y'              -- 배치 처리 여부
             , SBN_IF_YN     = 'Y'              -- 사방넷 연계 여부
             , SBN_IF_MSG    = #{resultContent} -- 사방넷 연계 메시지
             , UPDR_NO       = #{updrNo}        -- 수정자 번호
             , UPD_DTTM      = sysdate            -- 수정 일시
         WHERE IF_SNO = #{ifSno};
         end
         }
    </update>

    <!-- 6-4.문의사항 상품게시판글 글번호 조회 -->
    <select id="selectGoodsBbsLettNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.InquiryClctIfPO">
        SELECT LETT_NO
          FROM TI_INQUIRY_CLCT_IF
         WHERE IF_SNO = (
                         SELECT MIN(E.IF_SNO)
                           FROM TI_INQUIRY_CLCT_IF D
                              , TI_INQUIRY_CLCT_IF E
                          WHERE D.SITE_NO        = #{siteNo}
                            AND D.IF_SNO         = #{ifSno}
                            AND E.SITE_NO        = D.SITE_NO
                            AND E.SPMALL_ID      = D.SPMALL_ID        -- 쇼핑몰ID
                            AND E.SPMALL_LOGIN_ID = D.SPMALL_LOGIN_ID -- 쇼핑몰로그인ID
                            AND E.ITEM_NO         = D.ITEM_NO         -- 단품번호
                            AND E.SBN_SNO = D.SBN_SNO
                            AND E.LETT_NO IS NOT NULL                 -- 글번호
                            AND D.PRC_GB != '001'                     -- 신규접수
                            AND E.PRC_GB = '001'                      -- 신규접수
                        )
    </select>

    <!-- 6-7.문의사항 답변등록 처리 -->
    <update id="procInquiryReply" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.InquiryClctIfPO">
        {call
		declare
		begin
        /* system.link.sabangnet.procInquiryReply - 6-7-1.문의사항 답변등록 처리 - 상품게시판글 답변등록 */
        MERGE INTO TB_GOODS_BBS_LETT A
		USING (
		    SELECT
               #{lettNo}        AS LETT_NO                                      -- 글번호
             , #{grpNo}         AS GRP_NO                                      -- 그룹번호
             , 'question'       AS BBS_ID                                     -- 게시판 아이디
             , #{siteNo}        AS SITE_NO                                     -- 사이트 번호
             , null             AS TITLE_NO                                     -- 타이틀 번호
             , A.TITLE          AS TITLE                                    -- 제목
             , A.REPLY_CONTENT  AS CONTENT                            -- 내용
             , null             AS INQ_CNT                                         -- 조회수
             , null             AS SCORE                                          -- 점수
             , fn_getGoodsCtgNoNm(#{siteNo}, A.GOODS_NO, 'CTG_NO') AS CTG_NO -- 카테고리 번호
             , 'N'         AS SECT_YN                                             -- 비밀 여부
             , 'Y'         AS OPEN_YN                                          -- 공개 여부
             , null        AS REPLY_STATUS_YN                                -- 답변 상태 여부
             , ITEM_NO     AS GOODS_NO                                   -- 상품 번호
             , null        AS BUY_YN                                    -- 구매 여부
             , null        AS LETT_LVL                                    -- 글 레벨
             , null        AS PW                                    -- 비밀번호
             , null        AS FILE_NO                                    -- 파일 번호
             , 'N'         AS BLIND_USE_YN                                    -- 블라인드
             , 'Y'         AS EXPS_YN                                   -- 노출 여부
             , null        AS SMS_SEND_YN                                    -- SMS 발송 여부
             , null        AS EMAIL_SEND_YN                                    -- 이메일 발송 여부
             , A.WRTR      AS REG_NM                                    -- 등록 명
             , sysdate     AS REG_DTTM                                      -- 등록 일시
             , #{regrNo}   AS REGR_NO                                    -- 등록자 번호
             , null        AS UPD_DTTM                                    -- 수정 일시
             , null        AS UPDR_NO                                    -- 수정자 번호
             , 'N'         AS DEL_YN                                    -- 삭제 여부
             , null        AS DELR_NO                                    -- 삭제자 번호
             , null        AS DEL_DTTM                                    -- 삭제 일시
             , null        AS MEMBER_NO                                    -- 회원 번호
          FROM TI_INQUIRY_CLCT_IF A
         WHERE A.IF_SNO  = #{ifSno}
		) C
		ON (A.GRP_NO = C.GRP_NO AND A.BBS_ID=C.BBS_ID)
		WHEN MATCHED THEN
		    UPDATE SET
		     A.CONTENT = C.CONTENT
		    ,A.TITLE = C.TITLE
		    ,A.UPDR_NO = #{updrNo}
		    ,A.UPD_DTTM =  sysdate
		WHEN NOT MATCHED THEN
        INSERT (
               LETT_NO                 -- 글 번호
             , GRP_NO                  -- 그룹 번호
             , BBS_ID                  -- 게시판 아이디
             , SITE_NO                 -- 사이트 번호
             , TITLE_NO                -- 타이틀 번호
             , TITLE                   -- 제목
             , CONTENT                 -- 내용
             , INQ_CNT                 -- 조회수
             , SCORE                   -- 점수
             , CTG_NO                  -- 카테고리 번호
             , SECT_YN                 -- 비밀 여부
             , OPEN_YN                 -- 공개 여부
             , REPLY_STATUS_YN         -- 답변 상태 여부
             , GOODS_NO                -- 상품 번호
             , BUY_YN                  -- 구매 여부
             , LETT_LVL                -- 글 레벨
             , PW                      -- 비밀번호
             , FILE_NO                 -- 파일 번호
             , BLIND_USE_YN            -- 블라인드 사용 여부
             , EXPS_YN                 -- 노출 여부
             , SMS_SEND_YN             -- SMS 발송 여부
             , EMAIL_SEND_YN           -- 이메일 발송 여부
             , REG_NM                  -- 등록 명
             , REG_DTTM                -- 등록 일시
             , REGR_NO                 -- 등록자 번호
             , UPD_DTTM                -- 수정 일시
             , UPDR_NO                 -- 수정자 번호
             , DEL_YN                  -- 삭제 여부
             , DELR_NO                 -- 삭제자 번호
             , DEL_DTTM                -- 삭제 일시
             , MEMBER_NO               -- 회원 번호
        ) VALUES (
               C.LETT_NO                 -- 글 번호
             , C.GRP_NO                  -- 그룹 번호
             , C.BBS_ID                  -- 게시판 아이디
             , C.SITE_NO                 -- 사이트 번호
             , C.TITLE_NO                -- 타이틀 번호
             , C.TITLE                   -- 제목
             , C.CONTENT                 -- 내용
             , C.INQ_CNT                 -- 조회수
             , C.SCORE                   -- 점수
             , C.CTG_NO                  -- 카테고리 번호
             , C.SECT_YN                 -- 비밀 여부
             , C.OPEN_YN                 -- 공개 여부
             , C.REPLY_STATUS_YN         -- 답변 상태 여부
             , C.GOODS_NO                -- 상품 번호
             , C.BUY_YN                  -- 구매 여부
             , C.LETT_LVL                -- 글 레벨
             , C.PW                      -- 비밀번호
             , C.FILE_NO                 -- 파일 번호
             , C.BLIND_USE_YN            -- 블라인드 사용 여부
             , C.EXPS_YN                 -- 노출 여부
             , C.SMS_SEND_YN             -- SMS 발송 여부
             , C.EMAIL_SEND_YN           -- 이메일 발송 여부
             , C.REG_NM                  -- 등록 명
             , C.REG_DTTM                -- 등록 일시
             , C.REGR_NO                 -- 등록자 번호
             , C.UPD_DTTM                -- 수정 일시
             , C.UPDR_NO                 -- 수정자 번호
             , C.DEL_YN                  -- 삭제 여부
             , C.DELR_NO                 -- 삭제자 번호
             , C.DEL_DTTM                -- 삭제 일시
             , C.MEMBER_NO               -- 회원 번호
        )
        ;


        UPDATE TB_GOODS_BBS_LETT SET REPLY_STATUS_YN='Y'
        WHERE LETT_NO = #{grpNo};

        /* system.link.sabangnet.procInquiryReply - 6-7-2.문의사항 처리 - 문의사항수집연계 테이블 업데이트 */
        UPDATE TI_INQUIRY_CLCT_IF               -- 문의사항 수집 연계
           SET LETT_NO       = #{lettNo}        -- 글 번호
             , GRP_NO        = #{grpNo}       -- 그룹 번호
             , BTCH_PRC_YN   = 'Y'              -- 배치 처리 여부
             , SBN_IF_YN     = 'Y'              -- 사방넷 연계 여부
             , SBN_IF_MSG    = #{resultContent} -- 사방넷 연계 메시지
             , UPDR_NO       = #{updrNo}        -- 수정자 번호
             , UPD_DTTM      = sysdate            -- 수정 일시
         WHERE IF_SNO = #{ifSno};

         end
         }
    </update>

    <!-- 6-8.문의사항수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 -->
    <delete id="deleteInquiryClctIfPastData">
        /* system.link.sabangnet.deleteInquiryClctIfPastData - 6-8.문의사항수집연계 테이블 최종 IF_SNO 만 남기고 모두 삭제 */
        DELETE FROM TI_INQUIRY_CLCT_IF
         WHERE SITE_NO = #{siteNo}
           AND IF_SNO IN (
                      SELECT IF_SNO
                        FROM (
                              SELECT IF_SNO
                                FROM TI_INQUIRY_CLCT_IF A
                               WHERE A.SITE_NO = #{siteNo}
                                 AND IF_SNO NOT IN (    -- 최종 IF_SNO (사방넷일련번호,글번호 별 최종)는 제외
                                            SELECT MAX(B.IF_SNO) FROM TI_INQUIRY_CLCT_IF B
                                             WHERE B.SITE_NO = #{siteNo}
                                             GROUP BY B.SPMALL_ID, B.SBN_SNO, B.GOODS_NO, B.GRP_NO
                                                 , B.LETT_NO, B.SBN_IF_YN
                                           )
                             ) C
                      )
    </delete>

    <!-- 7.문의답변 등록 -->
    <resultMap id="inquiryReplyRegiRequest" type="net.danvi.dmall.biz.batch.link.sabangnet.model.request.InquiryReplyRequest">
        <collection column="{siteNo=SITE_NO, ifNo=IF_NO}" property="data" javaType="ArrayList"
                    ofType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.InquiryReply"
                    select="system.link.sabangnet.selectInquiryReplyRegiData"/>
    </resultMap>
    <!-- 7.문의답변 등록 데이터 조회 -->
    <select id="selectInquiryReplyRegi" resultMap="system.link.sabangnet.inquiryReplyRegiRequest">
        /* system.link.sabangnet.selectInquiryReplyRegi - 7.문의답변 등록 데이터 조회 */
        SELECT  TC.SBN_ID                       AS sendCompaynyId,
                SBN_CERT_KEY                    AS sendAuthKey,
                TO_CHAR(sysdate, 'YYYYMMDD')    AS sendDate,
                TS.SITE_NO,
                #{ifNo}                         AS IF_NO
        FROM    TS_COMPANY TC, TS_SITE TS
        WHERE   TC.COMPANY_NO = TS.COMPANY_NO
        AND     TC.SBN_ID IS NOT NULL         -- 사방넷 아이디
        <![CDATA[
        AND     SUBSTR(TC.SBN_START_DT, 1, 8) <= TO_CHAR(sysdate, 'YYYYMMDD')   -- 사방넷 시작일자
        AND     SUBSTR(TC.SBN_END_DT, 1, 8) >= TO_CHAR(sysdate, 'YYYYMMDD')     -- 사방넷 종료일자
        AND     TS.SITE_NO = #{siteNo}


        ]]>
    </select>

    <!-- 7.문의답변 등록 데이터 조회-->
    <select id="selectInquiryReplyRegiData" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.request.InquiryReply">
        /* system.link.sabangnet.selectInquiryReplyRegiData - 7.문의답변 등록 데이터 조회 */
        SELECT
                SBN_SNO                                    AS num
              , NVL(REPLY_CONTENT, '')                  AS csReContent
          FROM  TI_INQUIRY_REPLY_REG_IF
          WHERE SITE_NO = #{siteNo}
           AND  IF_NO   = #{ifNo}               -- 연계번호
           AND  NVL(SBN_IF_YN,'N') = 'N'     -- 'N' 사방넷연계 여부
         ORDER BY IF_SNO
    </select>

    <!-- 7-1.문의답변등록 연계 사방넷연계여부 수정 -->
    <update id="updateInquiryReplyRegSbnIfYn" parameterType="net.danvi.dmall.biz.batch.common.model.IfExecLogVO">
        /* system.link.sabangnet.updateInquiryReplyRegSbnIfYn - 7-1.문의답변등록 연계 사방넷연계여부 수정 */
        UPDATE TI_INQUIRY_REPLY_REG_IF A
           SET A.SBN_IF_YN      = CASE WHEN #{resultContent} LIKE '%성공%' THEN 'Y' ELSE 'N' END
             , A.SBN_IF_MSG     = #{resultContent}
             , A.UPDR_NO        = #{updrNo}
             , A.UPD_DTTM       = sysdate
        WHERE
               A.IF_SNO         = (SELECT IF_SNO
                  FROM TI_INQUIRY_REPLY_REG_IF
                 WHERE LETT_NO = #{srchKey}
                   AND IF_NO    = #{ifNo}
                   AND NVL(SBN_IF_YN,'N') = 'N'   -- 'N' 사방넷연계 여부
               )
    </update>

    <select id="selectNewIfNo" resultType="String">
        SELECT fn_getIfNo(0, 'TI_IF_NO') AS IF_NO FROM DUAL
    </select>

    <select id="selectMaxIfNo" resultType="String" parameterType="net.danvi.dmall.biz.batch.common.model.IfLogVO">
		SELECT MAX(IF_NO) FROM TI_IF_LOG WHERE IF_ID = #{ifId}
    </select>

    <!-- 연계 로그 등록 -->
    <insert id="insertNewIfLog" parameterType="net.danvi.dmall.biz.batch.common.model.IfLogVO">
        INSERT INTO TI_IF_LOG (
               IF_NO
             , IF_ID
             , SITE_NO
             , IF_PGM_ID
             , IF_PGM_NM
             , IF_GB_CD
             , UP_IF_NO
             , START_IF_SNO
             , END_IF_SNO
             , START_DTTM
             , END_DTTM
             , SEND_DT
             , SUCS_YN
             , ERR_CD
             , RESULT_CONTENT
             , DATA_CNT
             , DATA_TOT_CNT
             , START_KEY
             , END_KEY
             , SEND_CONTS
             , RECV_CONTS
             , MEDIA_CD
             , REGR_NO
             , REG_DTTM
        ) VALUES (
               #{ifNo}
             , #{ifId}
             , #{siteNo}
             , #{ifPgmId}
             , #{ifPgmNm}
             , #{ifGbCd}
             , #{upIfNo}
             , #{startIfSno}
             , #{endIfSno}
             , TO_CHAR(sysdate, 'YYYYMMDDHH24MISS')
             , TO_CHAR(sysdate, 'YYYYMMDDHH24MISS')
             , TO_CHAR(sysdate, 'YYYYMMDD%')
             , #{sucsYn}
             , #{errCd}
             , #{resultContent}
             , #{dataCnt}
             , #{dataTotCnt}
             , #{startKey}
             , #{endKey}
             , #{sendConts:CLOB}
             , #{recvConts:CLOB}
             , #{mediaCd}
             , #{regrNo}
             , sysdate
             )
    </insert>


    <!-- 연계 사방넷 로그 등록 -->
    <insert id="insertIfSbnLog" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.batch.job.model.IfSbnLogVO">
        /* system.link.sabangnet.insertIfSbnLog - 연계 사방넷 로그 등록 */
        INSERT INTO TI_IF_SBN_LOG (
               IF_NO
             , IF_ID
             , SITE_NO
             , IF_PGM_NM
             , GOODS_CD_RETURN_YN
             , SRCH_START_DT
             , SRCH_END_DT
             , PRT_FIELD_LIST
             , SALES_CALCULATE_CHECK_YN
             , ORD_NO
             , SPMALL_CD
             , ORD_DLVR_STATUS_CD
             , INVOICE_INFO_UPD_YN
             , SRCH_PRC_GB_CD
             , REGR_NO
             , REG_DTTM
        ) VALUES (
               #{ifNo}
             , #{ifId}
             , #{siteNo}
             , #{ifPgmNm}
             , #{goodsCdReturnYn}
             , #{srchStartDt}
             , #{srchEndDt}
             , #{prtFieldList}
             , #{salesCalculateCheckYn}
             , #{ordNo}
             , #{spmallCd}
             , #{ordDlvrStatusCd}
             , #{invoiceInfoUpdYn}
             , #{srchPrcGbCd}
             , #{regrNo}
             , sysdate
             )
    </insert>

    <!-- 연계 사방넷 로그 수정 -->
    <update id="updateIfSbnLog" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.batch.job.model.IfSbnLogVO">
        /* system.link.sabangnet.updateIfSbnLog - 연계 사방넷 로그 수정 */
        UPDATE TI_IF_SBN_LOG
        SET
               RESULT_CONTENT = #{resultContent}
             , UPDR_NO        = #{updrNo}
             , UPD_DTTM       = sysdate
        WHERE
               IF_NO          = #{ifNo}
    </update>


    <!-- 상품수집 연계 테이블 중복 체크 -->
    <select id="selecttGoodsClctIfDupYn" resultType="String" parameterType="net.danvi.dmall.webservice.model.GoodsPO">
        /* system.link.sabangnet.selecttGoodsClctIfDupYn - 상품수집 연계 테이블 중복 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS DUP_YN
          FROM TI_GOODS_CLCT_IF
         WHERE SITE_NO       = #{siteNo}
           AND SELLER_LOGIN_ID  = #{SELLER_ID}     -- 쇼핑몰 ID
           AND SBN_GOODS_NO    = #{SBN_GOODS_NO}   -- 사방넷 상품번호

    </select>

    <!-- 상품 수집 연계 테이블 등록 -->
    <insert id="insertGoodsClctIf" parameterType="net.danvi.dmall.webservice.model.GoodsPO">
        /* system.link.sabangnet.insertGoodsClctIf - 상품 수집 연계 테이블 등록 */
        MERGE INTO TI_GOODS_CLCT_IF
		USING dual
		ON (SBN_GOODS_NO = #{SBN_GOODS_NO})
		WHEN MATCHED THEN
		    UPDATE SET
               IF_SNO           = #{ifSno},
               IF_ID            = #{ifId},
               IF_NO            = #{ifNo},
               GOODS_NM         = #{GOODS_NM},
               MODEL_NM         = #{MODEL_NM},
               BRAND_NO         = #{BRAND_NO},
               CTG_NO_1         = #{CTG_NO_1},
               CTG_NO_2         = #{CTG_NO_2},
               CTG_NO_3         = #{CTG_NO_3},
               CTG_NO_4         = #{CTG_NO_4},
               SRCH_WORD        = #{GOODS_SEARCH},
               MMFT             = #{MAKER},
               HABITAT          = #{ORIGIN},
               SALE_STATUS_CD   = #{STATUS},
               TAX_GB_CD        = #{TAX_YN},
               DLVRC_GB_CD      = #{DELV_TYPE},
               DELV_EXPECT_DAYS = #{DELV_EXPECT_DAYS},
               GOODS_EACH_DLVRC = #{DELV_COST},
               SUPPLY_PRICE     = #{GOODS_COST},
               SALE_PRICE       = #{GOODS_PRICE},
               CUSTOMER_PRICE   = #{GOODS_CONSUMER_PRICE},
               CHAR_1_NM        = #{CHAR_1_NM},
               CHAR_1_VAL       = #{CHAR_1_VAL},
               CHAR_2_NM        = #{CHAR_2_NM},
               CHAR_2_VAL       = #{CHAR_2_VAL},
               PROP1_CD         = #{PROP1_CD} ,
               PROP_VAL1        = #{PROP_VAL1},
               PROP_VAL2        = #{PROP_VAL2},
               PROP_VAL3        = #{PROP_VAL3},
               PROP_VAL4        = #{PROP_VAL4},
               PROP_VAL5        = #{PROP_VAL5},
               PROP_VAL6        = #{PROP_VAL6},
               PROP_VAL7        = #{PROP_VAL7},
               PROP_VAL8        = #{PROP_VAL8},
               PROP_VAL9        = #{PROP_VAL9},
               PROP_VAL10       = #{PROP_VAL10},
               PROP_VAL11       = #{PROP_VAL11},
               PROP_VAL12       = #{PROP_VAL12},
               PROP_VAL13       = #{PROP_VAL13},
               PROP_VAL14       = #{PROP_VAL14},
               PROP_VAL15       = #{PROP_VAL15},
               PROP_VAL16       = #{PROP_VAL16},
               PROP_VAL17       = #{PROP_VAL17},
               PROP_VAL18       = #{PROP_VAL18},
               PROP_VAL19       = #{PROP_VAL19},
               PROP_VAL20       = #{PROP_VAL20},
               PROP_VAL21       = #{PROP_VAL21},
               PROP_VAL22       = #{PROP_VAL22},
               PROP_VAL23       = #{PROP_VAL23},
               PROP_VAL24       = #{PROP_VAL24},
               PROP_VAL25       = #{PROP_VAL25},
               PROP_VAL26       = #{PROP_VAL26},
               PROP_VAL27       = #{PROP_VAL27},
               PROP_VAL28       = #{PROP_VAL28},
               DLGT_IMG_PATH    = #{IMG_PATH},
               IMG_PATH1        = #{IMG_PATH1},
               IMG_PATH2        = #{IMG_PATH2},
               IMG_PATH3        = #{IMG_PATH3},
               IMG_PATH4        = #{IMG_PATH4},
               IMG_PATH5        = #{IMG_PATH5},
               GOODS_DTL_DSCRT  = #{GOODS_REMARKS},
               UPDR_NO          = #{updrNo},
               UPD_DTTM         = sysdate

		WHEN NOT MATCHED THEN
        INSERT (
           IF_SNO, IF_ID, IF_NO,
           SITE_NO, SELLER_NO, SELLER_LOGIN_ID,
           SBN_GOODS_NO, GOODS_NO, ITEM_NO,
           ATTR_VER, GOODS_NM, ITEM_NM,
           MODEL_NM, BRAND_NO, CTG_NO_1,
           CTG_NO_2, CTG_NO_3, CTG_NO_4,
           SRCH_WORD, MMFT, HABITAT,
           SALE_STATUS_CD, TAX_GB_CD, DLVRC_GB_CD,
           DELV_EXPECT_DAYS, GOODS_EACH_DLVRC, SUPPLY_PRICE,
           SALE_PRICE, CUSTOMER_PRICE, CHAR_1_NM,
           CHAR_1_VAL, CHAR_2_NM, CHAR_2_VAL,
           PROP1_CD, PROP_VAL1, PROP_VAL2,
           PROP_VAL3, PROP_VAL4, PROP_VAL5,
           PROP_VAL6, PROP_VAL7, PROP_VAL8,
           PROP_VAL9, PROP_VAL10, PROP_VAL11,
           PROP_VAL12, PROP_VAL13, PROP_VAL14,
           PROP_VAL15, PROP_VAL16, PROP_VAL17,
           PROP_VAL18, PROP_VAL19, PROP_VAL20,
           PROP_VAL21, PROP_VAL22, PROP_VAL23,
           PROP_VAL24, PROP_VAL25, PROP_VAL26,
           PROP_VAL27, PROP_VAL28, DLGT_IMG_PATH,
           IMG_PATH1, IMG_PATH2, IMG_PATH3,
           IMG_PATH4, IMG_PATH5, GOODS_DTL_DSCRT,
           REGR_NO, REG_DTTM
       ) VALUES (
          #{ifSno}
        , #{ifId}
        , #{ifNo}
        , #{siteNo}
        , #{sellerNo}/*SELLER_NO*/
        , #{SELLER_ID}/*SELLER_LOGIN_ID*/
        , #{SBN_GOODS_NO}/*SBN_GOODS_NO*/
        , #{goodsNo}/*GOODS_NO*/
        , #{itemNo}/*ITEM_NO*/
        , #{attrVer} /*ATTR_VER*/
        , #{GOODS_NM}/*GOODS_NM*/
        , ''/* ITEM_NM */
        , #{MODEL_NM}/*MODEL_NM*/
        , #{BRAND_NO}
        , #{CTG_NO_1}
        , #{CTG_NO_2}
        , #{CTG_NO_3}
        , #{CTG_NO_4}
        , #{GOODS_SEARCH} /*SRCH_WORD*/
        , #{MAKER}/*MMFT*/
        , #{ORIGIN}/*HABITAT*/
        , #{STATUS}/*SALE_STATUS_CD*/
        , #{TAX_YN}/*TAX_GB_CD*/
        , #{DELV_TYPE}/*DLVRC_GB_CD*/
        , #{DELV_EXPECT_DAYS}
        , #{DELV_COST}/*GOODS_EACH_DLVRC*/
        , #{GOODS_COST}/*SUPPLY_PRICE*/
        , #{GOODS_PRICE}/*SALE_PRICE*/
        , #{GOODS_CONSUMER_PRICE}/*CUSTOMER_PRICE*/
        , #{CHAR_1_NM} /* CHAR_1_NM */
        , #{CHAR_1_VAL} /* CHAR_1_VAL */
        , #{CHAR_2_NM} /* CHAR_2_NM */
        , #{CHAR_2_VAL} /* CHAR_2_VAL */
        , #{PROP1_CD} /* PROP1_CD */
        , #{PROP_VAL1} /* PROP_VAL1 */
        , #{PROP_VAL2} /* PROP_VAL2 */
        , #{PROP_VAL3} /* PROP_VAL3 */
        , #{PROP_VAL4} /* PROP_VAL4 */
        , #{PROP_VAL5} /* PROP_VAL5 */
        , #{PROP_VAL6} /* PROP_VAL6 */
        , #{PROP_VAL7} /* PROP_VAL7 */
        , #{PROP_VAL8} /* PROP_VAL8 */
        , #{PROP_VAL9} /* PROP_VAL9 */
        , #{PROP_VAL10} /* PROP_VAL10 */
        , #{PROP_VAL11} /* PROP_VAL11 */
        , #{PROP_VAL12} /* PROP_VAL12 */
        , #{PROP_VAL13} /* PROP_VAL13 */
        , #{PROP_VAL14} /* PROP_VAL14 */
        , #{PROP_VAL15} /* PROP_VAL15 */
        , #{PROP_VAL16} /* PROP_VAL16 */
        , #{PROP_VAL17} /* PROP_VAL17 */
        , #{PROP_VAL18} /* PROP_VAL18 */
        , #{PROP_VAL19} /* PROP_VAL19 */
        , #{PROP_VAL20} /* PROP_VAL20 */
        , #{PROP_VAL21} /* PROP_VAL21 */
        , #{PROP_VAL22} /* PROP_VAL22 */
        , #{PROP_VAL23} /* PROP_VAL23 */
        , #{PROP_VAL24} /* PROP_VAL24 */
        , #{PROP_VAL25} /* PROP_VAL25 */
        , #{PROP_VAL26} /* PROP_VAL26 */
        , #{PROP_VAL27} /* PROP_VAL27 */
        , #{PROP_VAL28} /* PROP_VAL28 */
        , #{IMG_PATH}/*DLGT_IMG_PATH*/
        , #{IMG_PATH1}/*IMG_PATH1*/
        , #{IMG_PATH2}/*IMG_PATH2*/
        , #{IMG_PATH3}/*IMG_PATH3*/
        , #{IMG_PATH4}/*IMG_PATH4*/
        , #{IMG_PATH5}/*IMG_PATH5*/
        , #{GOODS_REMARKS}/*GOODS_DTL_DSCRT*/
        , #{regrNo}
        , sysdate
        )
    </insert>

    <!-- 상품수집연계 처리 - 쇼핑몰 상품번호별 조회 -->
    <select id="selectGoodsClctIfList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        /* system.link.sabangnet.selectGoodsClctIfList - 상품수집연계 - 쇼핑몰 상품번호별 조회 */
          SELECT
                 A.IF_SNO  /* 연계 일련번호 */
                ,A.IF_ID  /* 연계 ID */
                ,A.IF_NO  /* 연계 번호 */
                ,A.SITE_NO  /* 사이트 번호 */
                ,A.SELLER_NO  /* 판매자 번호 */
                ,A.SELLER_LOGIN_ID  /* 판매자 로그인 ID */
                ,A.SBN_GOODS_NO  /* 사방넷 상품 번호 */
                ,A.GOODS_NO  /* 상품 번호 */
                ,A.ITEM_NO  /* 단품 번호 */
                ,A.ATTR_VER  /* 속성 VER */
                ,A.GOODS_NM  /* 상품 명 */
                ,A.ITEM_NM  /* 단품 명 */
                ,A.MODEL_NM  /* 모델 명 */
                ,A.BRAND_NO  /* 브랜드 번호 */
                ,A.CTG_NO_1  /* 카테고리 번호 1 */
                ,A.CTG_NO_2  /* 카테고리 번호 2 */
                ,A.CTG_NO_3  /* 카테고리 번호 3 */
                ,A.CTG_NO_4  /* 카테고리 번호 4 */
                ,A.SRCH_WORD  /* 검색어 */
                ,A.MMFT  /* 제조사 */
                ,A.HABITAT  /* 원산지 */
                ,A.SALE_STATUS_CD  /* 판매 상태 코드 */
                ,A.TAX_GB_CD  /* 과세 구분 코드 */
                ,A.DLVRC_GB_CD  /* 배송비 구분 코드 */
                ,A.DELV_EXPECT_DAYS  /* 예상 배송 소요일 */
                ,A.GOODS_EACH_DLVRC  /* 상품 별 배송비 */
                ,A.SUPPLY_PRICE  /* 공급 가격 */
                ,A.SALE_PRICE  /* 판매 가격 */
                ,A.CUSTOMER_PRICE  /* 소비자 가격 */
                ,A.CHAR_1_NM  /* 옵션 제목1 */
                ,A.CHAR_1_VAL  /* 옵션 상세명칭1 */
                ,A.CHAR_2_NM  /* 옵션 제목2 */
                ,A.CHAR_2_VAL  /* 옵션 상세명칭2 */
                ,A.PROP1_CD  /* 속성 분류 코드 */
                ,A.PROP_VAL1  /* 속성 값1 */
                ,A.PROP_VAL2  /* 속성 값2 */
                ,A.PROP_VAL3  /* 속성 값3 */
                ,A.PROP_VAL4  /* 속성 값4 */
                ,A.PROP_VAL5  /* 속성 값5 */
                ,A.PROP_VAL6  /* 속성 값6 */
                ,A.PROP_VAL7  /* 속성 값7 */
                ,A.PROP_VAL8  /* 속성 값8 */
                ,A.PROP_VAL9  /* 속성 값9 */
                ,A.PROP_VAL10  /* 속성 값10 */
                ,A.PROP_VAL11  /* 속성 값11 */
                ,A.PROP_VAL12  /* 속성 값12 */
                ,A.PROP_VAL13  /* 속성 값13 */
                ,A.PROP_VAL14  /* 속성 값14 */
                ,A.PROP_VAL15  /* 속성 값15 */
                ,A.PROP_VAL16  /* 속성 값16 */
                ,A.PROP_VAL17  /* 속성 값17 */
                ,A.PROP_VAL18  /* 속성 값18 */
                ,A.PROP_VAL19  /* 속성 값19 */
                ,A.PROP_VAL20  /* 속성 값20 */
                ,A.PROP_VAL21  /* 속성 값21 */
                ,A.PROP_VAL22  /* 속성 값22 */
                ,A.PROP_VAL23  /* 속성 값23 */
                ,A.PROP_VAL24  /* 속성 값24 */
                ,A.PROP_VAL25  /* 속성 값25 */
                ,A.PROP_VAL26  /* 속성 값26 */
                ,A.PROP_VAL27  /* 속성 값27 */
                ,A.PROP_VAL28  /* 속성 값28 */
                ,A.DLGT_IMG_PATH  /* 대표 이미지 경로 */
                ,A.IMG_PATH1  /* 이미지 경로1 */
                ,A.IMG_PATH2  /* 이미지 경로2 */
                ,A.IMG_PATH3  /* 이미지 경로3 */
                ,A.IMG_PATH4  /* 이미지 경로4 */
                ,A.IMG_PATH5  /* 이미지 경로5 */
                ,A.GOODS_DTL_DSCRT  /* 상품 상세 설명 */
                ,A.REGR_NO  /* 등록자 번호 */
                ,A.REG_DTTM  /* 등록 일시 */
                ,A.UPDR_NO  /* 수정자 번호 */
                ,A.UPD_DTTM  /* 수정 일시 */
            FROM TI_GOODS_CLCT_IF A
           WHERE A.SITE_NO  = #{siteNo}
             AND A.IF_NO    = #{ifNo}
             AND (A.GOODS_NO, A.SBN_GOODS_NO) IN (SELECT B.GOODS_NO, MIN(B.SBN_GOODS_NO) SBN_GOODS_NO
                                                       FROM TI_GOODS_CLCT_IF B
                                                      WHERE B.SITE_NO  = #{siteNo}
                                                        AND B.IF_NO    = #{ifNo}
                                                      GROUP BY B.GOODS_NO
                                                    )
           ORDER BY A.GOODS_NO, A.SBN_GOODS_NO
    </select>

    <!-- 상품 테이블 존재여부 체크 -->
    <select id="selectGoodsExistYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        /* system.link.sabangnet.selectGoodsExistYn - 상품 테이블 존재여부 체크 */
        SELECT CASE WHEN COUNT(*) = 0 THEN 'N'
                    WHEN COUNT(*) > 0 THEN 'Y' END  AS EXIST_YN
          FROM TG_GOODS
         WHERE SITE_NO      = #{siteNo}
           AND GOODS_NO       = #{goodsNo}
           AND DEL_YN ='N'
    </select>


    <!-- 상품 처리 -->
    <update id="procGoods" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        /* system.link.sabangnet.procGoods - 상품 처리 - 상품 테이블 등록 */
        MERGE INTO TG_GOODS TG
		USING (
		SELECT
             GOODS_NO     											AS GOODS_NO	     				/* 상품 번호 */
            ,'01'        											AS GOODS_CONTS_GB_CD	  		/* 상품 컨텐츠 구분 코드 */
            ,null        											AS GOODS_TYPE_CD				/* 상품 유형 코드 */
            ,SELLER_NO   											AS SELLER_NO					    /* 판매자 번호 */
            ,null        											AS COMPANY_NO					/* 업체 번호 */
            ,SITE_NO     											AS SITE_NO	    					/* 사이트 번호 */
            ,ITEM_NO     											AS ITEM_NO	    					/* 단품 번호 */
            ,TO_NUMBER(PROP1_CD)                      				AS NOTIFY_NO							/* 고시 번호 */
            ,GOODS_NM   											AS GOODS_NM	    				/* 상품 명 */
            ,MODEL_NM   											AS MODEL_NM	    				/* 모델 명 */
            ,BRAND_NO   											AS BRAND_NO	    				/* 브랜드 번호 */
            ,'3'        											AS GOODS_SALE_STATUS_CD			/* 상품 판매 상태 코드 */
            ,'N'        											AS DISP_YN								/* 전시 여부 */
            ,'N'        											AS RSV_ONLY_YN						/* 예약 전용 여부 */
            ,'N'        											AS NAVER_LINK_YN					/* 네이버 연동 여부 */
            ,'N'        											AS VIRT_OUTING_YN					/* 가상 착장 여부 */
            ,'Y'        											AS RETURN_PSB_YN					/* 반품 가능 여부 */
            ,'Y'        											AS SALE_YN								/* 판매 여부 */
            ,null       											AS SALE_START_DT	  				/* 판매 시작 일자 */
            ,null       											AS SALE_END_DT	 		 			/* 판매 종료 일자 */
            ,'N'        											AS GOODS_ADD_INFO_USE_YN			/* 상품 추가 정보 사용 여부 */
            ,'N'        											AS MOBILE_DISP_YN					/* 모바일 전시 여부 */
            ,'N'        											AS REINWARE_APPLY_YN				/* 재입고 적용 여부 */
            ,'N'        											AS ADULT_CERTIFY_YN					/* 성인 인증 여부 */
            ,'N'     												AS MAX_ORD_LIMIT_YN	   				/* 최대 주문 제한 여부 */
            ,0       												AS MAX_ORD_QTT	 					/* 최대 주문 수량 */
            ,'N'     												AS MIN_ORD_LIMIT_YN	   				/* 최소 주문 제한 여부 */
            ,0       												AS MIN_ORD_QTT	 					/* 최소 주문 수량 */
            ,null    												AS PR_WORDS	     					/* 홍보 문구 */
            ,'N'     												AS ADD_OPT_USE_YN	 				 /* 추가 옵션 사용 여부 */
            ,CASE WHEN CHAR_2_NM is not null THEN 'Y' ELSE 'N' END  AS MULTI_OPT_YN      				/* 다중 옵션 여부 */
            ,HABITAT   												AS HABITAT	     					/* 원산지 */
            ,MMFT      												AS MMFT	   								/* 제조사 */
            ,null      												AS HSCODE	   								/* HSCODE */
            ,SRCH_WORD 												AS SEO_SEARCH_WORD	   				   /* SEO 검색 단어 */
            ,0         												AS GOODS_SVMN_AMT						/* 상품 적립금 금액 */
            ,'N'       												AS GOODS_SVMN_POLICY_USE_YN		  		/* 상품 적립금 정책 사용 여부 */
            ,'01'      												AS GOODS_SVMN_POLICY_CD		    		/* 상품 적립금 정책 코드 */
            ,'1'       												AS GOODS_SVMN_GB_CD		  			/* 상품 적립금 구분 코드 */
            ,'03'      												AS GOODS_SVMN_MAX_USE_POLICY_CD		    /* 상품 적립금 최대 사용 정책 코드 */
            ,null      												AS GOODS_SVMN_MAX_USE_RATE		    /* 상품 적립금 최대 사용 율 */
            ,0         												AS RECOM_PVD_RATE					/* 추천 적립율 */
            ,'01'      												AS RECOM_PVD_POLICY_CD		    		/* 추천 적립 정책 코드 */
            ,TAX_GB_CD  											AS TAX_GB_CD	       				/* 과세 구분 코드 */
            ,'1'         											AS DLVR_SET_CD							/* 배송 설정 코드 */
            ,DELV_EXPECT_DAYS       								AS DLVR_EXPECT_DAYS					 /* 배송 예상 소요일 */
            ,GOODS_EACH_DLVRC       								AS GOODSEACH_DLVRC					  /* 상품별 배송비 */
            ,null          											AS PACK_MAX_UNIT						/* 포장 최대 단위 */
            ,null          											AS PACK_UNIT_DLVRC						/* 포장 단위 배송비 */
            ,null          											AS GOODSEACH_CNDTADD_DLVRC				/* 상품별 조건부 배송비 */
            ,null          											AS FREE_DLVR_MIN_AMT				/* 무료 배송 최소 금액 */
            ,'Y'         											AS COURI_DLVR_APPLY_YN				/* 택배 배송 적용 여부 */
            ,'N'         											AS DIRECT_RECPT_APPLY_YN				/* 직접 수령 적용 여부 */
            ,DLVRC_GB_CD       										AS DLVR_PAYMENT_KIND_CD				 /* 배송 결제 방식 코드 */
            ,null         											AS TX_LIMIT_CNDT					/* 거래 제한 조건 */
            ,'3'         											AS RELATE_GOODS_APPLY_TYPE_CD				/* 관련 상품 적용 유형 코드 */
            ,null         											AS RELATE_GOODS_APPLY_CTG				/* 관련 상품 적용 카테고리 */
            ,null         											AS RELATE_GOODS_SALE_PRICE_START				/* 관련 상품 판매 가격 시작 */
            ,null         											AS RELATE_GOODS_SALE_PRICE_END				/* 관련 상품 판매 가격 종료 */
            ,null         											AS RELATE_GOODS_SALE_STATUS_CD				/* 관련 상품 판매 상태 코드 */
            ,null         											AS RELATE_GOODS_DISP_STATUS_CD				/* 관련 상품 전시 상태 코드 */
            ,null          											AS RELATE_GOODS_AUTO_EXPS_SORT_CD					/* 관련 상품 자동 노출 정렬 코드 */
            ,null          											AS VIDEO_SOURCE_PATH					/* 동영상 소스 경로 */
            ,#{dispImgPathTypeA}      								AS DISP_IMG_PATH_TYPE_A					   /* 전시 이미지 경로 TYPE A */
            ,#{dispImgNmTypeA}        								AS DISP_IMG_NM_TYPE_A					 /* 전시 이미지 명 TYPE A */
            ,#{dispImgFileSizeTypeA}  								AS DISP_IMG_FILE_SIZE_TYPE_A					       /* 전시 이미지 파일 사이즈 TYPE A */
            ,#{dispImgPathTypeB}      								AS DISP_IMG_PATH_TYPE_B					   /* 전시 이미지 경로 TYPE B */
            ,#{dispImgNmTypeB}        								AS DISP_IMG_NM_TYPE_B					 /* 전시 이미지 명 TYPE B */
            ,#{dispImgFileSizeTypeB}  								AS DISP_IMG_FILE_SIZE_TYPE_B					       /* 전시 이미지 파일 사이즈 TYPE B */
            ,#{dispImgPathTypeC}      								AS DISP_IMG_PATH_TYPE_C					   /* 전시 이미지 경로 TYPE C */
            ,#{dispImgNmTypeC}        								AS DISP_IMG_NM_TYPE_C					 /* 전시 이미지 명 TYPE C */
            ,#{dispImgFileSizeTypeC}  								AS DISP_IMG_FILE_SIZE_TYPE_C					       /* 전시 이미지 파일 사이즈 TYPE C */
            ,#{dispImgPathTypeD}      								AS DISP_IMG_PATH_TYPE_D					   /* 전시 이미지 경로 TYPE D */
            ,#{dispImgNmTypeD}        								AS DISP_IMG_NM_TYPE_D					 /* 전시 이미지 명 TYPE D */
            ,#{dispImgFileSizeTypeD}  								AS DISP_IMG_FILE_SIZE_TYPE_D					       /* 전시 이미지 파일 사이즈 TYPE D */
            ,#{dispImgPathTypeE}      								AS DISP_IMG_PATH_TYPE_E					   /* 전시 이미지 경로 TYPE E */
            ,#{dispImgNmTypeE}        								AS DISP_IMG_NM_TYPE_E					 /* 전시 이미지 명 TYPE E */
            ,#{dispImgFileSizeTypeE}  								AS DISP_IMG_FILE_SIZE_TYPE_E					       /* 전시 이미지 파일 사이즈 TYPE E */
            ,#{dispImgPathTypeF}      								AS DISP_IMG_PATH_TYPE_F					   /* 전시 이미지 경로 TYPE F */
            ,#{dispImgNmTypeF}        								AS DISP_IMG_NM_TYPE_F					 /* 전시 이미지 명 TYPE F */
            ,#{dispImgFileSizeTypeF}  								AS DISP_IMG_FILE_SIZE_TYPE_F					       /* 전시 이미지 파일 사이즈 TYPE F */
            ,#{dispImgPathTypeG}      								AS DISP_IMG_PATH_TYPE_G					   /* 전시 이미지 경로 TYPE G */
            ,#{dispImgNmTypeG}        								AS DISP_IMG_NM_TYPE_G					 /* 전시 이미지 명 TYPE G */
            ,#{dispImgFileSizeTypeG}  								AS DISP_IMG_FILE_SIZE_TYPE_G					       /* 전시 이미지 파일 사이즈 TYPE G */
            ,#{dispImgPathTypeS}      								AS DISP_IMG_PATH_TYPE_S					   /* 전시 이미지 경로 TYPE S */
            ,#{dispImgNmTypeS}        								AS DISP_IMG_NM_TYPE_S					 /* 전시 이미지 명 TYPE S */
            ,#{dispImgFileSizeTypeS}  								AS DISP_IMG_FILE_SIZE_TYPE_S					       /* 전시 이미지 파일 사이즈 TYPE S */
            ,#{dispImgPathTypeM}      								AS DISP_IMG_PATH_TYPE_M					   /* 전시 이미지 경로 TYPE M */
            ,#{dispImgNmTypeM}        								AS DISP_IMG_NM_TYPE_M					 /* 전시 이미지 명 TYPE M */
            ,#{dispImgFileSizeTypeM}  								AS DISP_IMG_FILE_SIZE_TYPE_M					       /* 전시 이미지 파일 사이즈 TYPE M */
            ,'N'        											AS DEL_YN								 /* 삭제 여부 */
        FROM TI_GOODS_CLCT_IF
        WHERE IF_SNO = #{ifSno}
		) TAB
		ON (TG.GOODS_NO = TAB.GOODS_NO)
		WHEN MATCHED THEN
		    UPDATE SET
		     NOTIFY_NO  = TAB.NOTIFY_NO
            ,GOODS_NM   = TAB.GOODS_NM
            ,MODEL_NM   = TAB.MODEL_NM
            ,BRAND_NO   = TAB.BRAND_NO
            ,MULTI_OPT_YN   = TAB.MULTI_OPT_YN
            ,HABITAT    = TAB.HABITAT
            ,MMFT   = TAB.MMFT
            ,SEO_SEARCH_WORD    = TAB.SEO_SEARCH_WORD
            ,TAX_GB_CD  = TAB.TAX_GB_CD
            ,DLVR_EXPECT_DAYS   = TAB.DLVR_EXPECT_DAYS
            ,GOODSEACH_DLVRC    = TAB.GOODSEACH_DLVRC
            ,DLVR_PAYMENT_KIND_CD   = TAB.DLVR_PAYMENT_KIND_CD
            ,DISP_IMG_PATH_TYPE_A   = TAB.DISP_IMG_PATH_TYPE_A
            ,DISP_IMG_NM_TYPE_A = TAB.DISP_IMG_NM_TYPE_A
            ,DISP_IMG_FILE_SIZE_TYPE_A  = TAB.DISP_IMG_FILE_SIZE_TYPE_A
            ,DISP_IMG_PATH_TYPE_B   = TAB.DISP_IMG_PATH_TYPE_B
            ,DISP_IMG_NM_TYPE_B = TAB.DISP_IMG_NM_TYPE_B
            ,DISP_IMG_FILE_SIZE_TYPE_B  = TAB.DISP_IMG_FILE_SIZE_TYPE_B
            ,DISP_IMG_PATH_TYPE_C   = TAB.DISP_IMG_PATH_TYPE_C
            ,DISP_IMG_NM_TYPE_C = TAB.DISP_IMG_NM_TYPE_C
            ,DISP_IMG_FILE_SIZE_TYPE_C  = TAB.DISP_IMG_FILE_SIZE_TYPE_C
            ,DISP_IMG_PATH_TYPE_D   = TAB.DISP_IMG_PATH_TYPE_D
            ,DISP_IMG_NM_TYPE_D = TAB.DISP_IMG_NM_TYPE_D
            ,DISP_IMG_FILE_SIZE_TYPE_D  = TAB.DISP_IMG_FILE_SIZE_TYPE_D
            ,DISP_IMG_PATH_TYPE_E   = TAB.DISP_IMG_PATH_TYPE_E
            ,DISP_IMG_NM_TYPE_E = TAB.DISP_IMG_NM_TYPE_E
            ,DISP_IMG_FILE_SIZE_TYPE_E  = TAB.DISP_IMG_FILE_SIZE_TYPE_E
            ,DISP_IMG_PATH_TYPE_F   = TAB.DISP_IMG_PATH_TYPE_F
            ,DISP_IMG_NM_TYPE_F = TAB.DISP_IMG_NM_TYPE_F
            ,DISP_IMG_FILE_SIZE_TYPE_F  = TAB.DISP_IMG_FILE_SIZE_TYPE_F
            ,DISP_IMG_PATH_TYPE_G   = TAB.DISP_IMG_PATH_TYPE_G
            ,DISP_IMG_NM_TYPE_G = TAB.DISP_IMG_NM_TYPE_G
            ,DISP_IMG_FILE_SIZE_TYPE_G  = TAB.DISP_IMG_FILE_SIZE_TYPE_G
            ,DISP_IMG_PATH_TYPE_S   = TAB.DISP_IMG_PATH_TYPE_S
            ,DISP_IMG_NM_TYPE_S = TAB.DISP_IMG_NM_TYPE_S
            ,DISP_IMG_FILE_SIZE_TYPE_S  = TAB.DISP_IMG_FILE_SIZE_TYPE_S
            ,DISP_IMG_PATH_TYPE_M   = TAB.DISP_IMG_PATH_TYPE_M
            ,DISP_IMG_NM_TYPE_M = TAB.DISP_IMG_NM_TYPE_M
            ,DISP_IMG_FILE_SIZE_TYPE_M  = TAB.DISP_IMG_FILE_SIZE_TYPE_M
            ,UPDR_NO    = #{updrNo}
            ,UPD_DTTM   = sysdate


		WHEN NOT MATCHED THEN
		    INSERT (
             GOODS_NO
            ,GOODS_CONTS_GB_CD
            ,GOODS_TYPE_CD
            ,SELLER_NO
            ,COMPANY_NO
            ,SITE_NO
            ,ITEM_NO
            ,NOTIFY_NO
            ,GOODS_NM
            ,MODEL_NM
            ,BRAND_NO
            ,GOODS_SALE_STATUS_CD
            ,DISP_YN
            ,RSV_ONLY_YN
            ,NAVER_LINK_YN
            ,VIRT_OUTING_YN
            ,RETURN_PSB_YN
            ,SALE_YN
            ,SALE_START_DT
            ,SALE_END_DT
            ,GOODS_ADD_INFO_USE_YN
            ,MOBILE_DISP_YN
            ,REINWARE_APPLY_YN
            ,ADULT_CERTIFY_YN
            ,MAX_ORD_LIMIT_YN
            ,MAX_ORD_QTT
            ,MIN_ORD_LIMIT_YN
            ,MIN_ORD_QTT
            ,PR_WORDS
            ,ADD_OPT_USE_YN
            ,MULTI_OPT_YN
            ,HABITAT
            ,MMFT
            ,HSCODE
            ,SEO_SEARCH_WORD
            ,GOODS_SVMN_AMT
            ,GOODS_SVMN_POLICY_USE_YN
            ,GOODS_SVMN_POLICY_CD
            ,GOODS_SVMN_GB_CD
            ,GOODS_SVMN_MAX_USE_POLICY_CD
            ,GOODS_SVMN_MAX_USE_RATE
            ,RECOM_PVD_RATE
            ,RECOM_PVD_POLICY_CD
            ,TAX_GB_CD
            ,DLVR_SET_CD
            ,DLVR_EXPECT_DAYS
            ,GOODSEACH_DLVRC
            ,PACK_MAX_UNIT
            ,PACK_UNIT_DLVRC
            ,GOODSEACH_CNDTADD_DLVRC
            ,FREE_DLVR_MIN_AMT
            ,COURI_DLVR_APPLY_YN
            ,DIRECT_RECPT_APPLY_YN
            ,DLVR_PAYMENT_KIND_CD
            ,TX_LIMIT_CNDT
            ,RELATE_GOODS_APPLY_TYPE_CD
            ,RELATE_GOODS_APPLY_CTG
            ,RELATE_GOODS_SALE_PRICE_START
            ,RELATE_GOODS_SALE_PRICE_END
            ,RELATE_GOODS_SALE_STATUS_CD
            ,RELATE_GOODS_DISP_STATUS_CD
            ,RELATE_GOODS_AUTO_EXPS_SORT_CD
            ,VIDEO_SOURCE_PATH
            ,DISP_IMG_PATH_TYPE_A
            ,DISP_IMG_NM_TYPE_A
            ,DISP_IMG_FILE_SIZE_TYPE_A
            ,DISP_IMG_PATH_TYPE_B
            ,DISP_IMG_NM_TYPE_B
            ,DISP_IMG_FILE_SIZE_TYPE_B
            ,DISP_IMG_PATH_TYPE_C
            ,DISP_IMG_NM_TYPE_C
            ,DISP_IMG_FILE_SIZE_TYPE_C
            ,DISP_IMG_PATH_TYPE_D
            ,DISP_IMG_NM_TYPE_D
            ,DISP_IMG_FILE_SIZE_TYPE_D
            ,DISP_IMG_PATH_TYPE_E
            ,DISP_IMG_NM_TYPE_E
            ,DISP_IMG_FILE_SIZE_TYPE_E
            ,DISP_IMG_PATH_TYPE_F
            ,DISP_IMG_NM_TYPE_F
            ,DISP_IMG_FILE_SIZE_TYPE_F
            ,DISP_IMG_PATH_TYPE_G
            ,DISP_IMG_NM_TYPE_G
            ,DISP_IMG_FILE_SIZE_TYPE_G
            ,DISP_IMG_PATH_TYPE_S
            ,DISP_IMG_NM_TYPE_S
            ,DISP_IMG_FILE_SIZE_TYPE_S
            ,DISP_IMG_PATH_TYPE_M
            ,DISP_IMG_NM_TYPE_M
            ,DISP_IMG_FILE_SIZE_TYPE_M
            ,DEL_YN
            ,REGR_NO
            ,REG_DTTM
        ) VALUES (
            TAB.GOODS_NO	     				/* 상품 번호 */
            ,TAB.GOODS_CONTS_GB_CD	  		/* 상품 컨텐츠 구분 코드 */
            ,TAB.GOODS_TYPE_CD				/* 상품 유형 코드 */
            ,TAB.SELLER_NO					    /* 판매자 번호 */
            ,TAB.COMPANY_NO					/* 업체 번호 */
            ,TAB.SITE_NO	    					/* 사이트 번호 */
            ,TAB.ITEM_NO	    					/* 단품 번호 */
            ,TAB.NOTIFY_NO							/* 고시 번호 */
            ,TAB.GOODS_NM	    				/* 상품 명 */
            ,TAB.MODEL_NM	    				/* 모델 명 */
            ,TAB.BRAND_NO	    				/* 브랜드 번호 */
            ,TAB.GOODS_SALE_STATUS_CD			/* 상품 판매 상태 코드 */
            ,TAB.DISP_YN								/* 전시 여부 */
            ,TAB.RSV_ONLY_YN						/* 예약 전용 여부 */
            ,TAB.NAVER_LINK_YN					/* 네이버 연동 여부 */
            ,TAB.VIRT_OUTING_YN					/* 가상 착장 여부 */
            ,TAB.RETURN_PSB_YN					/* 반품 가능 여부 */
            ,TAB.SALE_YN								/* 판매 여부 */
            ,TAB.SALE_START_DT	  				/* 판매 시작 일자 */
            ,TAB.SALE_END_DT	 		 			/* 판매 종료 일자 */
            ,TAB.GOODS_ADD_INFO_USE_YN			/* 상품 추가 정보 사용 여부 */
            ,TAB.MOBILE_DISP_YN					/* 모바일 전시 여부 */
            ,TAB.REINWARE_APPLY_YN				/* 재입고 적용 여부 */
            ,TAB.ADULT_CERTIFY_YN					/* 성인 인증 여부 */
            ,TAB.MAX_ORD_LIMIT_YN	   				/* 최대 주문 제한 여부 */
            ,TAB.MAX_ORD_QTT	 					/* 최대 주문 수량 */
            ,TAB.MIN_ORD_LIMIT_YN	   				/* 최소 주문 제한 여부 */
            ,TAB.MIN_ORD_QTT	 					/* 최소 주문 수량 */
            ,TAB.PR_WORDS	     					/* 홍보 문구 */
            ,TAB.ADD_OPT_USE_YN	 				 /* 추가 옵션 사용 여부 */
            ,TAB.MULTI_OPT_YN      				/* 다중 옵션 여부 */
            ,TAB.HABITAT	     					/* 원산지 */
            ,TAB.MMFT	   								/* 제조사 */
            ,TAB.HSCODE	   								/* HSCODE */
            ,TAB.SEO_SEARCH_WORD	   				   /* SEO 검색 단어 */
            ,TAB.GOODS_SVMN_AMT						/* 상품 적립금 금액 */
            ,TAB.GOODS_SVMN_POLICY_USE_YN		  		/* 상품 적립금 정책 사용 여부 */
            ,TAB.GOODS_SVMN_POLICY_CD		    		/* 상품 적립금 정책 코드 */
            ,TAB.GOODS_SVMN_GB_CD		  			/* 상품 적립금 구분 코드 */
            ,TAB.GOODS_SVMN_MAX_USE_POLICY_CD		    /* 상품 적립금 최대 사용 정책 코드 */
            ,TAB.GOODS_SVMN_MAX_USE_RATE		    /* 상품 적립금 최대 사용 율 */
            ,TAB.RECOM_PVD_RATE					/* 추천 적립율 */
            ,TAB.RECOM_PVD_POLICY_CD		    		/* 추천 적립 정책 코드 */
            ,TAB.TAX_GB_CD	       				/* 과세 구분 코드 */
            ,TAB.DLVR_SET_CD							/* 배송 설정 코드 */
            ,TAB.DLVR_EXPECT_DAYS					 /* 배송 예상 소요일 */
            ,TAB.GOODSEACH_DLVRC					  /* 상품별 배송비 */
            ,TAB.PACK_MAX_UNIT						/* 포장 최대 단위 */
            ,TAB.PACK_UNIT_DLVRC						/* 포장 단위 배송비 */
            ,TAB.GOODSEACH_CNDTADD_DLVRC				/* 상품별 조건부 배송비 */
            ,TAB.FREE_DLVR_MIN_AMT				/* 무료 배송 최소 금액 */
            ,TAB.COURI_DLVR_APPLY_YN				/* 택배 배송 적용 여부 */
            ,TAB.DIRECT_RECPT_APPLY_YN				/* 직접 수령 적용 여부 */
            ,TAB.DLVR_PAYMENT_KIND_CD				 /* 배송 결제 방식 코드 */
            ,TAB.TX_LIMIT_CNDT					/* 거래 제한 조건 */
            ,TAB.RELATE_GOODS_APPLY_TYPE_CD				/* 관련 상품 적용 유형 코드 */
            ,TAB.RELATE_GOODS_APPLY_CTG				/* 관련 상품 적용 카테고리 */
            ,TAB.RELATE_GOODS_SALE_PRICE_START				/* 관련 상품 판매 가격 시작 */
            ,TAB.RELATE_GOODS_SALE_PRICE_END				/* 관련 상품 판매 가격 종료 */
            ,TAB.RELATE_GOODS_SALE_STATUS_CD				/* 관련 상품 판매 상태 코드 */
            ,TAB.RELATE_GOODS_DISP_STATUS_CD				/* 관련 상품 전시 상태 코드 */
            ,TAB.RELATE_GOODS_AUTO_EXPS_SORT_CD					/* 관련 상품 자동 노출 정렬 코드 */
            ,TAB.VIDEO_SOURCE_PATH					/* 동영상 소스 경로 */
            ,TAB.DISP_IMG_PATH_TYPE_A					   /* 전시 이미지 경로 TYPE A */
            ,TAB.DISP_IMG_NM_TYPE_A					 /* 전시 이미지 명 TYPE A */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_A					       /* 전시 이미지 파일 사이즈 TYPE A */
            ,TAB.DISP_IMG_PATH_TYPE_B					   /* 전시 이미지 경로 TYPE B */
            ,TAB.DISP_IMG_NM_TYPE_B					 /* 전시 이미지 명 TYPE B */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_B					       /* 전시 이미지 파일 사이즈 TYPE B */
            ,TAB.DISP_IMG_PATH_TYPE_C					   /* 전시 이미지 경로 TYPE C */
            ,TAB.DISP_IMG_NM_TYPE_C					 /* 전시 이미지 명 TYPE C */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_C					       /* 전시 이미지 파일 사이즈 TYPE C */
            ,TAB.DISP_IMG_PATH_TYPE_D					   /* 전시 이미지 경로 TYPE D */
            ,TAB.DISP_IMG_NM_TYPE_D					 /* 전시 이미지 명 TYPE D */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_D					       /* 전시 이미지 파일 사이즈 TYPE D */
            ,TAB.DISP_IMG_PATH_TYPE_E					   /* 전시 이미지 경로 TYPE E */
            ,TAB.DISP_IMG_NM_TYPE_E					 /* 전시 이미지 명 TYPE E */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_E					       /* 전시 이미지 파일 사이즈 TYPE E */
            ,TAB.DISP_IMG_PATH_TYPE_F					   /* 전시 이미지 경로 TYPE F */
            ,TAB.DISP_IMG_NM_TYPE_F					 /* 전시 이미지 명 TYPE F */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_F					       /* 전시 이미지 파일 사이즈 TYPE F */
            ,TAB.DISP_IMG_PATH_TYPE_G					   /* 전시 이미지 경로 TYPE G */
            ,TAB.DISP_IMG_NM_TYPE_G					 /* 전시 이미지 명 TYPE G */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_G					       /* 전시 이미지 파일 사이즈 TYPE G */
            ,TAB.DISP_IMG_PATH_TYPE_S					   /* 전시 이미지 경로 TYPE S */
            ,TAB.DISP_IMG_NM_TYPE_S					 /* 전시 이미지 명 TYPE S */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_S					       /* 전시 이미지 파일 사이즈 TYPE S */
            ,TAB.DISP_IMG_PATH_TYPE_M					   /* 전시 이미지 경로 TYPE M */
            ,TAB.DISP_IMG_NM_TYPE_M					 /* 전시 이미지 명 TYPE M */
            ,TAB.DISP_IMG_FILE_SIZE_TYPE_M					       /* 전시 이미지 파일 사이즈 TYPE M */
            ,TAB.DEL_YN								 /* 삭제 여부 */
            ,#{regrNo}								/* 등록자 번호 */
            ,sysdate								/* 등록 일시 */
        )

    </update>

    <select id="selectMultiOptYn" resultType="String" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        /* system.link.sabangnet.selectMultiOptYn - 다중옵션여부 체크 */
        SELECT CASE WHEN CHAR_2_NM is not null THEN 'Y' ELSE 'N' END   AS MULTI_OPT_YN
          FROM TI_GOODS_CLCT_IF
         WHERE IF_SNO = #{ifSno}
    </select>

    <select id="selectOptionList" resultType="GoodsOptionPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT
	    	  OPT_NM
	       FROM TI_GOODS_CLCT_IF
            UNPIVOT ( OPT_NM FOR OPT IN (CHAR_1_NM,CHAR_2_NM))
            WHERE OPT IN (
                 'CHAR_1_NM'
                ,'CHAR_2_NM'
            )
        AND IF_SNO = #{ifSno}

    </select>

    <select id="selectOptionValueList" resultType="net.danvi.dmall.biz.app.goods.model.GoodsOptionAttrPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
      WITH TAB1 AS (
                SELECT
                 SPLIT(SPLIT(CHAR_1_VAL,1,','),1,'^^') AS ATTR_VAL_1
                ,SPLIT(SPLIT(CHAR_1_VAL,2,','),1,'^^') AS ATTR_VAL_2
                ,SPLIT(SPLIT(CHAR_1_VAL,3,','),1,'^^') AS ATTR_VAL_3
                ,SPLIT(SPLIT(CHAR_1_VAL,4,','),1,'^^') AS ATTRVA14
                ,SPLIT(SPLIT(CHAR_1_VAL,5,','),1,'^^') AS ATTR_VAL_5
                ,SPLIT(SPLIT(CHAR_2_VAL,1,','),1,'^^') AS ATTR_VAL_6
                ,SPLIT(SPLIT(CHAR_2_VAL,2,','),1,'^^') AS ATTR_VAL_7
                ,SPLIT(SPLIT(CHAR_2_VAL,3,','),1,'^^') AS ATTR_VAL_8
                ,SPLIT(SPLIT(CHAR_2_VAL,4,','),1,'^^') AS ATTR_VAL_9
                ,SPLIT(SPLIT(CHAR_2_VAL,5,','),1,'^^') AS ATTR_VAL_10
                FROM TI_GOODS_CLCT_IF
                WHERE IF_SNO = #{ifSno}
                )
        SELECT
	    	  ATTR_NM FROM  TAB1
        UNPIVOT ( ATTR_NM FOR ATTR IN (ATTR_VAL_1,ATTR_VAL_2,ATTR_VAL_3,ATTRVA14,ATTR_VAL_5,ATTR_VAL_6,ATTR_VAL_7,ATTR_VAL_8,ATTR_VAL_9,ATTR_VAL_10 ))
          WHERE ATTR IN (
                 'ATTR_VAL_1'
                 ,'ATTR_VAL_2'
                 ,'ATTR_VAL_3'
                ,'ATTR_VAL_4'
                ,'ATTR_VAL_5'
                ,'ATTR_VAL_6'
                ,'ATTR_VAL_7'
                ,'ATTR_VAL_8'
                ,'ATTR_VAL_9'
                ,'ATTR_VAL_10'
            )
    </select>

    <select id="selectGoodsItemList" resultType="net.danvi.dmall.biz.app.goods.model.GoodsItemPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT
            DISTINCT SPLIT(SPLIT(CHAR_1_VAL,1,','),1,'^^') AS ATTR_VALUE_1,
            CHAR_2_VAL AS ATTR_VALUE_2,
            SPLIT(SPLIT(CHAR_1_VAL,1,','),2,'^^') AS STOCK_QTT,
            SPLIT(SPLIT(CHAR_1_VAL,1,','),3,'^^') AS SALE_PRICE
            FROM (
                SELECT
                    DISTINCT CHAR_1_VAL,
                    CHAR_2_VAL
                FROM (
                SELECT
                    DISTINCT CHAR_1_VAL,
                    REGEXP_SUBSTR(CHAR_2_VAL,'[^,]+', 1, LEVEL) AS CHAR_2_VAL
                FROM (
                SELECT REGEXP_SUBSTR(CHAR_1_VAL,'[^,]+', 1, LEVEL) AS CHAR_1_VAL
                    ,CHAR_2_VAL
              FROM (
                  SELECT
                      CHAR_1_VAL ,CHAR_2_VAL
                   FROM TI_GOODS_CLCT_IF
                  WHERE IF_SNO =   #{ifSno}
                )
            CONNECT BY REGEXP_SUBSTR(CHAR_1_VAL, '[^,]+', 1, LEVEL) IS NOT NULL
            )
            CONNECT BY REGEXP_SUBSTR(CHAR_2_VAL, '[^,]+', 1, LEVEL) IS NOT NULL
            )
            )
            ORDER BY 1,2
    </select>

    <select id="selectGoodsAttrList1" resultType="net.danvi.dmall.biz.app.goods.model.GoodsItemPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT REGEXP_SUBSTR(ATTR_VALUE1,'[^,]+', 1, LEVEL) AS ATTR_VALUE1
          FROM (
          SELECT
	    	  ATTR_VALUE1
	       FROM TI_GOODS_CLCT_IF
          WHERE IF_SNO = #{ifSno}
        )
        CONNECT BY REGEXP_SUBSTR(ATTR_VALUE1, '[^,]+', 1, LEVEL) IS NOT NULL
    </select>

    <select id="selectGoodsAttrList2" resultType="net.danvi.dmall.biz.app.goods.model.GoodsItemPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT REGEXP_SUBSTR(ATTR_VALUE2,'[^,]+', 1, LEVEL) AS ATTR_VALUE2
          FROM (
          SELECT
	    	  ATTR_VALUE2
	       FROM TI_GOODS_CLCT_IF
          WHERE IF_SNO = #{ifSno}
        )
        CONNECT BY REGEXP_SUBSTR(ATTR_VALUE2, '[^,]+', 1, LEVEL) IS NOT NULL
    </select>

    <select id="selectGoodsAttrList3" resultType="net.danvi.dmall.biz.app.goods.model.GoodsItemPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT REGEXP_SUBSTR(ATTR_VALUE3,'[^,]+', 1, LEVEL) AS ATTR_VALUE3
          FROM (
          SELECT
	    	  ATTR_VALUE3
	       FROM TI_GOODS_CLCT_IF
          WHERE IF_SNO = #{ifSno}
        )
        CONNECT BY REGEXP_SUBSTR(ATTR_VALUE3, '[^,]+', 1, LEVEL) IS NOT NULL
    </select>

    <select id="selectGoodsAttrList4" resultType="net.danvi.dmall.biz.app.goods.model.GoodsItemPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT REGEXP_SUBSTR(ATTR_VALUE4,'[^,]+', 1, LEVEL) AS ATTR_VALUE4
          FROM (
          SELECT
	    	  ATTR_VALUE4
	       FROM TI_GOODS_CLCT_IF
          WHERE IF_SNO = #{ifSno}
        )
        CONNECT BY REGEXP_SUBSTR(ATTR_VALUE4, '[^,]+', 1, LEVEL) IS NOT NULL
    </select>

    <select id="selectImgList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT
          DLGT_IMG_PATH
        ,IMG_PATH1
        ,IMG_PATH2
        ,IMG_PATH3
        ,IMG_PATH4
        FROM TI_GOODS_CLCT_IF
        WHERE IF_SNO = #{ifSno}
    </select>

    <select id="selectGoodsCtgList" resultType="net.danvi.dmall.biz.app.goods.model.GoodsCtgPO" parameterType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT
	    	  CTG_NO
	       FROM TI_GOODS_CLCT_IF
            UNPIVOT ( CTG_NO FOR CTG IN (CTG_NO_1,CTG_NO_2,CTG_NO_3,CTG_NO_4))
        WHERE IF_SNO = #{ifSno}
        AND CTG_NO >0
    </select>


    <!-- 고시정보조회 -->
    <select id="selectGoodsNotifyItemList" resultType="net.danvi.dmall.biz.batch.link.sabangnet.model.result.GoodsClctIfPO">
        SELECT
            TO_NUMBER(PROP1_CD) AS PROP1_CD
            ,PROP_VAL1
            ,PROP_VAL2
            ,PROP_VAL3
            ,PROP_VAL4
            ,PROP_VAL5
            ,PROP_VAL6
            ,PROP_VAL7
            ,PROP_VAL8
            ,PROP_VAL9
            ,PROP_VAL10
            ,PROP_VAL11
            ,PROP_VAL12
            ,PROP_VAL13
            ,PROP_VAL14
            ,PROP_VAL15
            ,PROP_VAL16
            ,PROP_VAL17
            ,PROP_VAL18
            ,PROP_VAL19
            ,PROP_VAL20
            ,PROP_VAL21
            ,PROP_VAL22
            ,PROP_VAL23
            ,PROP_VAL24
            ,PROP_VAL25
            ,PROP_VAL26
            ,PROP_VAL27
            ,PROP_VAL28
       FROM TI_GOODS_CLCT_IF
      WHERE IF_SNO =  #{ifSno}

    </select>

    <!-- 이미지 세트 정보 삭제 -->
    <delete id="deleteGoodsImageSet">
        /* goods.manage.deleteGoodsImageSet - 이미지 세트 정보 삭제 */
        DELETE FROM TG_GOODS_IMG_SET
        WHERE GOODS_NO = #{goodsNo}
    </delete>
    <!-- 이미지 상세 정보 삭제 -->
    <delete id="deleteGoodsImageDtlSet">
        /* goods.manage.deleteGoodsImageDtlSet - 이미지 세트 정보 삭제 */
        DELETE FROM TG_GOODS_IMG_DTL
        WHERE GOODS_IMGSET_NO IN (
                SELECT GOODS_IMGSET_NO
                     FROM TG_GOODS_IMG_SET
                WHERE GOODS_NO = #{goodsNo}
        )
    </delete>

    <!-- 단품 정보 삭제 -->
    <insert id="deleteGoodsItemOne">
		 	UPDATE TG_ITEM SET
				  USE_YN = #{useYn}
				, UPDR_NO = #{updrNo}
		        , UPD_DTTM = sysdate
		    WHERE GOODS_NO=#{goodsNo}
    </insert>

    <!-- 옵션 수정 -->
    <update id="updateAttrUseYn">
        UPDATE TG_ATTR
        SET
	          USE_YN = #{useYn}
	        , UPDR_NO = #{updrNo}
	        , UPD_DTTM = sysdate
        WHERE OPT_NO = #{optNo}
    </update>

    <!-- 옵션 수정 -->
    <update id="updateOption">
        UPDATE  TG_OPT
        SET
                USE_YN = #{useYn}
              , UPDR_NO = #{updrNo}
              , UPD_DTTM = sysdate
        WHERE   OPT_NO IN (SELECT OPT_NO FROM TG_GOODS_OPT WHERE GOODS_NO=#{goodsNo})
    </update>

    <!-- 카테고리 정보조회 -->
    <select id="selectCategoryInfoList" resultType="net.danvi.dmall.webservice.model.CtgVO">
        SELECT
        CTG_NO, UP_CTG_NO, CTG_LVL, CTG_NM
        FROM TG_CTG
        WHERE SITE_NO =#{siteNo}
        AND DEL_YN = 'N'
        <if test="CTG_NO != null and CTG_NO !=''">
            AND CTG_NO = #{CTG_NO}
        </if>
        <if test="CTG_NM != null and CTG_NM !=''">
            AND CTG_NM LIKE '%'||#{CTG_NM}||'%'
        </if>
        ORDER BY SORT_SEQ
    </select>

    <!-- 카테고리 정보조회 -->
    <select id="selectBrandInfoList" resultType="net.danvi.dmall.webservice.model.BrandVO">
        SELECT
        BRAND_NO as brandNo,
        BRAND_NM as brandKorNm,
        BRAND_ENNM AS brandEngNm
        FROM TG_BRAND
        WHERE SITE_NO = #{siteNo}
        AND DISP_YN = 'Y'
        <if test="BRAND_NO != null and BRAND_NO !=''">
            AND BRAND_NO = #{BRAND_NO}
        </if>
        <if test="BRAND_KOR_NM != null and BRAND_KOR_NM !=''">
            AND BRAND_NM LIKE '%'||#{BRAND_KOR_NM}||'%'
        </if>
    </select>

</mapper>


